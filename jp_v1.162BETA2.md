# DIS:Legacy v1.162BETA2
# Update: "EQUITES PORRO" - Proto
内部的なシステムが大幅に組み替えられたためバグりがちです。何か見つけたら報告お願いします。

#### **1.162BETAロードマップ：**  
- 投擲武器のリロードとAIによる自動持ち替え制御  
- 馬とアクセサリの分離  
- ★ステージ追加  
- カスタムユニットシステム実装？（Elonaのあれみたいな）  
- ユニットセリフシステム実装？（ヴァーレンのあれみたいな）  
  
晩夏ごろの正式リリースが目標。ステージ追加以外は大して変わりません。  
  
#### 1.7?:  
- マップエディタ追加  
- ステージ製作リファレンス等の用意  
- 英語完訳  
- Denys氏によるUIリデザイン？  
  
## 翻訳関係
//＊ストーリーモードの流れを仮訳。＊
- ストーリー周り以外を大体GPT4で仮訳。システム文章は仮訳のままいくかもしれません。

## 追加
/*
・エンデュランス新ステージ追加
  - 「大八洲」
  …まつろわぬ民が住まう複雑な地形の島々を平定し，外敵の侵入に備えましょう。
  敵はヴァイキングではありません。
  
・戦術マップの追加
  - 「トレーニング（ポテチ）１」
  約一年ほど遅い戦術チュートリアルマップです。
  ポテチの雑兵と帝国の雑兵の小競り合いです。
  歩兵隊の組み合わせや配置についての基礎的なことが学べます。ポーズを使わなければおそらく１分で終わります。

  - 「トレーニング（帝国）」
  「天帝南征」よりも前に起きていた竜族と帝国の小競り合いのうちの一つです。
  辺境防衛隊の弱いユニットを使ってドラさんたちを撃退しましょう。
  視界取りと攻城兵器の大切さを学ぶシナリオ……
  と見せかけて、ユニットパワーの関係で一筋縄ではいかない難度かもしれません。
*/

- 操作の追加
  - Ctrlキーを押しながら右クリックでミニマップ指定以外でも経路探索付きの移動指示をできるように。

- アドバンスドタイルシステム（仮）
  - 前々から用意していた高度情報等を動的に変更して描画に反映したりマップタイルを細かく書き換えたりできるシステムの試験を開始。
    すこし重くなるかもしれませんが，BETA版の軽量化度合いがまず凄まじいのでわからないでしょう。

## 変更


### 総論
  - Maniacs Patchバージョン更新
    - なんとマップスクリプトにおいてJava Scriptによる処理を挟むことができるようになりました。プレイヤーには関係ありませんが。
  - 描画システム再構築
    - 今まで一ユニットには6枚のスプライトしか使えませんでした。が，これから理論上9枚まで割り当てられるようになります。とはいえそんなに重ねて表現したいものがいまのところ髪の毛くらいしかないため，とりあえず8枚設定で負荷チェックのテスト。
  - ユニット超過密状態を避けるためのシステム変更
    - 前線であまりにもユニットが渋滞している場合は動きが少し遅くなるように変更。
    - 渋滞している場所にユニットが向かう時は少しもたつくように変更。
    - 超過密状態での衝突処理はよりユニットをばらけさせることを意識した計算を行うように変更。
  - 弓矢と投射武器のシステム変更
    - 弓矢とクロスボウ
      - 全ての弓矢系武器の射程を5pixel分伸長。
      - 矢の弾道計算を通常の放物投射運動へと変更。
        勿論全てのユニットは投射角度を計算した上で射撃を行います。
        たぶん前より引き撃ち操作等が気持ちいいです。
      - 地面に落下したフレームだけでなく，一定の高さを下回った時点で命中チェックが行われるように変更。騎兵や攻城兵器のような大きいユニットや，飛行ユニット（こちらは本来当てづらい方がリアルかもしれませんがバランス上）に対しては高さの閾値が高くなりより当たりやすくなります。
        パラメータを参照する回避判定の合計回数は従来と同じ一回だけですが，
        これまで弾道がズレてそもそも命中判定が行われないことが多かったHITが低めのユニットでも矢を当てやすくなり，
        また高HITユニットであれば命中判定が行われないことはまずなくなります。
      - その代わり低HITのユニットはほんの少しだけ狙いが散らばりやすくなるように変更。
      - 遠隔攻撃の命中判定においてこれまで足されていた命中係数を38->25へ低下。
        加えて弓矢の場合は距離に対応して命中係数が上下するように変更。
        密着している敵に対してはかなり外しやすくなります。
        相当熟練した弓兵でない限り，盾を持っている相手に対しては厳しい戦いを強いられることになるでしょう。
      - 命中係数変更については投擲系の武器も影響を受けるため，投槍系武器は補填としてHITボーナスを一律+5，着弾時の当たり判定を1pixel拡大。
        投げ斧は斧が元々強いのを踏まえて変更なし。むしろ盾に当たりやすくなって好都合かもしれません。
    - 弾薬システムのリメイク
  - 高度システムの変更
    - より高度の高い位置へ移動する際はSPを消費するように変更。
      大して変わりませんが，戦闘中しながら高台へ移動しようとするとSPが削れて苦労するかもしれません。
      特に騎兵はSP消費が激しくなります。起伏のある場所では思わぬ苦戦をするかもしれません。
      当然ですが飛行ユニットには影響がありません。
  - シールドウォールの変更
    - 性能変更
    - オーラ効果の追加
  - 騎兵の変更
    - スピードボーナスを現在移動速度の8%から10%に変更。段々とある意味極端な存在へ変わってきました。
  - 攻城兵器の変更
    - 「カタパルト」の最低射程を「帝国破城投石機」と同じ数値に変更。
      通常のカタパルトの方は帝国のものよりも最低射程が短くセットされていたのですが，意図したものではなかったため延長する形で変更。
    - 「カタパルト」系ユニットの必要最低射程を少し増加。騎兵で処理しやすいように。

### 各論


  - 帝国の変更
    - 「コロヌス・スケレトゥム」の作業効率を3%低下。想定よりも強力で崩壊が始まった後の帝国の内政を支えられてしまっていたため。
    - 「帝国重スコルピオ」の最低射程を90pixから30pixへ変更。

  - ルーリキアの変更
    - 「フローズンスリンガー」の変更
      - SP回復量を10->12へ変更。
      - 武器「エインヘリャル」の攻撃速度を35->52、ADを120->128へ変更。

  - スシの変更
      - 「ゴブリン防人野郎」の変更
        - SP+10，HIT-2。
        - スキル「アンブッシュ」を削除。
          下記の弩の性能変更に伴う調整。
          数が揃うと凄まじい火力になりますが，どうせすぐ死んでしまうのでこれくらいのほうが面白いのではないでしょうか。

      - 「三八式歩兵弩」の性能変更
        - 三回連続で射撃を行うように変更。
          また一発ごとの射撃SPコストを14->5に変更し，AA必要フレームを4->2に変更。
        - 基本ADを65->52，ARpenを45%->35%,Hitボーナスを6->2，攻撃速度を50->27へ低下。
          この武器は最初から連弩にする予定で作ったものでしたが，内部仕様的に実現に難があった関係で放置されたまま名前オチのしょぼい弩になっていました。
          しかしながら，投射武器の仕様変更をもってついに連弩に。


#### 演出の変更
  - 「スコーピオン」系の貫通ボルトにも影が付くように変更。
  - 共通規格のユニットは状況に応じて瞬きをしたり表情が変化したりするように変更。

#### UIの変更
  - パラメータにカーソルを合わせると変動した現在値が表示されるように変更。
  - ドラッグ時の範囲表示レスポンスをより素早く変更。

#### パフォーマンス
おそらくv1.161の半分程度の軽さになりました。
  - ユニット処理を再構築して抜本的に軽量化。恐ろしく軽くなります。逆にいうとこれ以上毎f処理されている処理を軽くするのは無理かも。
  - 並列処理ほぼ全てをリファクタリング。
  - 現在能力値計算をリメイクして軽量化。
  - 描画処理を作り直して軽量化。
  - マップスクリプトの処理を高速化。
  - 建築物のミニマップ処理をさらに高速化。
  - 各ユニットのチーム判定処理に無駄があったのを組み換え。
  - 衝突判定を更に効率化。
  - その他細かい計算を効率化。
  - ミニマップ画像の編集元をキャッシュしておくように変更（アセット同梱版のみ反映）。
  - 視界処理を完全リファクタリング。
  - 単位ベクトルの生成式をより軽量なものに変更(まだ一部しか適用されていませんが)。

#### その他
  - 前版で廃止されていた敵の戦闘検知処理をロールバック。串良のＮＰＣ異常挙動の原因がこれを廃止したことの可能性があるため。関係なかったらまた切ります
  - 1fあたりのステップ数上限（内部コマンド実行数上限）をデフォルトの15万程度から300万へ変更。

## 修正
### v1.161からの修正:
- 2019年当時のテキストから変更されていたはずの内容がマップに反映されていなかったのを修正。
  時事の状況がより酷くなって，当時のテキストはもう本当に洒落にならないことになってしまいました。どうしてこうなった。
- 友軍建物のキルや撃破数が，一部の友軍ユニットのキル数と撃破数に算入されてリザルトで表示されていた不具合を修正。
- ファクションピック画面の記載が未だに崩れることがあったのを修正。
- 研究ボタンを押すとたまに関係のないところが光っていた不具合を修正。
- カメラを激しく動かすと攻撃範囲判定がおかしくなることがあったのを修正？(BETA2fix1)
- 破城槌系のユニットが他の種類のユニットの優先度を低く見るだけで，建物を特段重要視していなかったのを修正（BETA2prefix1）
- ユニットが何らかの要因でマップ外にはみ出ると無言でクラッシュしていた不具合..というより仕様，が発生し辛いように変更（BETA2prefix2）
- 実績「もう終わりだよこの国」のフォント表記が崩れていた不具合を修正。
- スシの衝撃騎兵アップグレードが最終的にハーピー斥候に繋がってしまっていた不具合を修正。
- セーブロードを挟むと死体表示がおかしくなっていることがあった不具合が修正されました（Maniacs Patchの更新によって本体のバグが修正されたため、DIS製作者が能動的に解決したわけではありません）。


### BETA期間の修正:
- 通れないマップタイル判定が壊れていたのを修正(BETA1fix2)。
- マップのちょっとした押し出し処理のポインタ処理が壊れており，色々と奇怪なことが起きていたのを修正(BETA1fix2)
- 町の中心から出た労働者がちゃんと仕事してくれなくなっていたのを修正(BETA1fix2)
- 敵と交戦しているときの経路探索処理がバグってずっとその場を行ったり来たりしていたのを修正(BETA1fix3)
  ↑まだ直っていなかったのを修正(BETA2)
- 描画システム変更の影響で750体以上のユニットが出撃すると当たり判定を破損させていた不具合を修正(BETA1fix3)
- 弓騎兵が攻撃する際必ず馬が後ろを向いてしまっていた不具合を修正(BETA1fix3)
- 持ち替え後のユニットに戦術指示が一切できなくなっていた不具合を修正(BETA2prefix1)
- 歩きアニメモーションが微妙に変になることがあったのを修正(BETA2prefix1)
- 弓矢の射撃がカメラ移動に対応せず，ずれてしまっていた不具合を*今度こそ*修正(BETA2prefix1)
- 弓矢のパーティクルがポーズするとおかしなことになっていた不具合を修正(BETA2prefix1)
- マップ端の視界処理がおかしくなる不具合を修正(BETA2prefix1)
- ベクトル式組み換えの余波で投げ斧が明後日の方角へ飛んでいた不具合を修正(BETA2prefix1)
- 検索ＡＩの軽量化処理に瑕疵があり，全てのユニットが建物を最優先するようになっていたのを修正(BETA2prefix1)
- リスタート機能が破損していたのを修正(BETA2prefix2)
- 攻撃待機モーションよりも歩きの方が優先されていたバグを修正(BETA2prefix2)
- 渋滞時の押し出し判定が上手く機能していなかった不具合を修正(BETA2prefix2)
- 上の不具合の影響で不自然に歩行速度が遅くなることがあった不具合も修正(BETA2prefix2)
- 押し出し判定組み換えの影響でユニットがマップ外にはみ出やすくなっていたのを修正(BETA2prefix2)
- 戦闘中に謎の無言クラッシュが生じていた不具合を修正。原因となっていた変数の衝突の解決こそしましたが，触っていなかった箇所のため，何故衝突が始まったのかが不明（おそらくステップ数絡み）であり，この修正は対処療法的と言わざるを得ません。リファクタリングはもう少し続くかもしれません。(BETA2prefix2)
- 特定のオブジェクトをターゲットとした状態で経路探索を行うと目標地点が破損し，異常な頻度での経路探索が繰り返されていた不具合を修正。(BETA2prefix3)
- ユニット個別の情報画面における表示情報が崩壊していた不具合を修正。（BETA2fix1）
- 視界システムが作動しているマップでヴァイキング船を選択することが不可能かつ表示されない状態が発生していたのを修正。（BETA2fix2）
- 「ルーリキア木こり兵」「追いはぎ」が「木こりの大斧」を持たない素手の状態で出撃することがあった不具合を修正。（BETA2fix2）
- 「フローズンスリンガー」が「オブリビオン・ブリザード」を発動するとユニットデータが破損していた不具合を修正。（BETA2fix2）
- 定義されていないユニットの生成命令がなされたときに表示されるエラー文が、建物を選択して空欄になっている生産ボタンを押したときも出ていた不具合を修正。（BETA2fix2）
- 強制移動/攻撃指示を行ってもそれまで攻撃していたユニットをAIが優先して動いてしまうことがあったのを修正（BETA2fix2）。
- 矢の処理の不具合でユニット撃破時に無言でクラッシュすることがあったのを修正（BETA2fix2）。
- BETA版で試験的に導入していた新変数管理システムの根幹となるコマンド群に致命的なバグが発見されたため、これを全廃し安定版の処理にロールバック（BETA2fix3）。
  - 上記が原因で発生していたＡＩ回りのバグを結果的に解決。

### 既知の不具合：
- ストーリーモードでリスタートすると何も始まらない状態になる
- クルシラの敵の経路がおかしくなる
- アリーナで無敵の骸骨が出る？（未確認）
- 情報画面のユニットスキルの数値表示がおかしい

## プレイヤーにほぼ関係のない変更：
- マップエディタ機能着手
- RPGツクールシリーズの利用規約更新に対応したクレジット表記を追加。
