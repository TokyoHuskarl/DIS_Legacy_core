# DIS:Legacy v1.163PROTO "The Eastern Wind"
ベータ版です。  
大きなシステム変更は避け、v1.162に間に合わなかった諸要素の追加と修正をする程度のアップデートとなる予定。  
~~2月-3月の正式リリースが目標です。~~ 

--------------------

# 修正予定
- 防御状態の弓ユニットの経路が変になるやつ
- 弾かれた時の挙動が凄いことになることがある


--------------------

# 大規模な追加・変更要素

## ~~MPバージョン更新~~
- 最新版のenが破損していた（ピクチャ編集時にクラッシュする）ため前版と同様のものにダウングレード。

## ゲーム規模の拡大
Legacy版が出てから約２年、大規模なリファクタリングを行ってきた甲斐もあり、
今回の変更によって、ついに当初から目標にしていた規模に手が届いた感じがあります。
これ以上の規模拡大にあたっては、恐らく画面自体の描画処理のGPU対応、
あるいはマルチコア動作といった改善が必要となると思われます。
その点につき現状MPのユーザ側からできることは残念ながらないため、
これくらいがエンジン的な限界地点なのではないでしょうか。
...要するに、これ以上大きく仕様上のゲームサイズが変わることは当分ないだろう、ということです。

  
実際的な変更点は以下の通り：
### プレイングに直接関係するもの
- **総ユニット数上限**。を880から~~999~~983に上昇
  現在のシステムで490VS490の合戦が実際まともに楽しめるかというとまた微妙なところですし、
  設計上の拡張限界を元から1000と見積もっていた関係で、更なる拡張にはまた大きな工事が必要ということもあり、
  ユニット数の拡張についてはとりあえずここで一区切りとします。
- **チームユニット上限の限界を350->480に変更**。
  ただし、毎回480の人口枠を最大限に使えるというわけではなく、
  ステージごとに個別のユニット限界が設定されるようになります。
### その他
- ゲーム中同時に存在可能なパーティクルエミッター数の上限を100->256に変更。
- ゲーム中同時に存在可能なエフェクトイベント上限数（矢等を制御する概念）を120->256に変更。 *TODO*
- ゲーム中同時に存在可能な弾の上限数を180->256に拡大。 *TODO*

### マップの変更

#### クラシックアイランド
- チームユニット上限を350に設定。

#### クソデカアイランド
- チームユニット上限を400に設定。
- jsライブラリ"noisejs"を取り入れ、より自然な地形ランダマイズを行うように変更...試験中。

#### アリーナ
- チームユニット上限を450に設定。
- 対スシシナリオ中盤と最終盤の兵量を増加。
- 対帝国シナリオ中盤の兵量を増加。
- 対竜族シナリオ最終盤の質と兵量を強化。


## 新システム付きユニットの追加
### トレビュシェット *TODO*
- 実は23年秋頃の時点で、やしおじ様からスプライトが提供されていた遠投投石機ですが、  
  機能を再現するための処理実装が間に合わず、前版では未実装でした。  
  しかしながら、v1.163においてついに実装！  
- スキル「モードチェンジ」を通して、超長射程の砲撃を行う攻撃モードと攻撃能力を一切持たない移動モードを切り替えて運用する攻城ユニットです。  
  ゲーム中最高の射程を持ち、建物に対して高い破壊力を発揮します。  
  モードチェンジの関係で扱いが難しいこと、通常ユニットに大して攻撃を当てづらいことが弱点です。
- これまでにない新規軸のユニットであるため、個別AIの振る舞い等が微妙かもしれません。  
  BETAテスト等を通して少しずつ調整していく予定です。

# 変更/小規模な追加要素  

## バランス総論
### Perk
#### 未使用Perkの効果実装 *TODO*
#### 新Perk「フェイント」追加 *TODO*
**近接通常攻撃が外れたとき、消費ＳＰの半分を回復する**Perkです。  
手数多めの軽装兵向け。  
- 下記のユニットに当該Perkを付与：
  - ポテチ：「勇者の妹」
  - スシ：「剣豪」
#### 新Perk「圧倒」追加
**物理攻撃スキルが命中したとき，敵に白兵戦ペナルティを付与するようになる**効果を持つ新Perkです。  *TODO*
一部の範囲攻撃を持つユニットが強くなります……が，範囲攻撃持ちユニットはもともと強いのであまり安売りされません。  
基本的に，両手持ち兵の中でも現状あまりパッとしていない人たち向けのPerkです。  
とはいえ，システム上，範囲通常攻撃にも適用されてしまうことを踏まえると……？
- 下記のユニットに当該Perkを付与：
  - 竜族：「エンピリオン・ガード」 
  - 帝国：「帝国ランキアリィ・コミタテンセス」「帝国パラティーナ護衛兵」 
  - ポテチ：「ポテチ下馬騎士」 
  - ルーリキア：「ルーリキアベルゼルガ」「ルーリキア選抜戦士」「ヴァリャーグ」 
  - スシ：「剣豪」
  - ヒュペルボレイア：「JOMSVIKING」 

### 内政
DISの内政ははっきり言ってとてもカジュアルです。  
かなり適当にやっていても終盤は資源がだぶつくようになっています。  
これは、「戦闘メインのシングルRTSで内政要素がめんどくさいのは嫌」という作者の考えの表れです。  
DISがシングルゲームである限り、この基本的な思想は変わりません。  
  
しかしながら、DISの内政システムは19年のクラシック版から大して変わっておらず、  
カジュアルでストレスフリーという建前のもとで、ゲームとして微妙な挙動がそのまま残っているのも確かです。  
そこで、本アップデートにおいてはカジュアルさを残しつつ内政回りの挙動をモダナイズし、  
より「それっぽさ」のある内政体験ができるように変更を加えました。  
  
#### 労働者の仕様変更
- ~~労働者は仕事切替時に持っている資源（SP欄に表示されているもの）を資源として収めるように変更。~~  
  ~~微妙に資源が無駄になると何かイヤな感じがするため。~~ *TODO*
- 労働者は対象となる資源リソースから資源を獲得できなかった場合、指示待ち状態(idle状態)になるように変更。  
    - 資源建築を建ててしまえば無限に資源が湧き出してくるのはDISのカジュアルな内政システムの象徴といえます。  
      実はこの資源は一つの場所からいくらでも取れるというわけでなく、  
      資源施設のリソース回復が追いつかない量の労働者を割り当ててしまうと、効率が落ちるようになっています。  
      これはクラシック版からの仕様であり、クラシック版には建物説明欄に目安となる割当人数が書かれていました。
      とはいえ、この割当人数システムは極めて分かりづらいものと言わざるを得ません。  
      このreadmeを読んで初めてそのような仕様があることを知った方もいることでしょう。  
    - そこで、資源リソースが枯渇してしまうほどの大量の労働者が割り当てられている場合は、  
      **労働者が次の指示を待つ状態へ移行するように変更しました**。  
      内政操作が少し増えてしまうかもしれませんが、効率的には変わらないか、むしろより良くなるため、  
      バランス的なインパクトはさほどでもないかと思われます。

#### 建築計算式の変更
- これまでの計算式は`{進捗} += {労働者のAD}`で、労働者を割り当てれば割り当てるほど効率が良くなる単純なものでした。  
  これにより、終盤は余った労働者を大量に差し向けて建築を進めれば、速攻でどんな建物も立つようになっていました。  
  とはいえ建築は人足をただひたすら割り当てればそれで進みが良くなるというものではないはずで、すこし違和感のある仕様でした。  
- そこで、式を`{進捗} += {労働者のAD} - ({労働者のADの25%} * ({一秒間に現場で行われた作業量} / 4))`に変更。
  序中盤においてはあまり影響がないと思われますが、最終盤において大量の労働者を使って無理やり建築をするようなプレイングは、  
  工兵ドラゴンのような建築用労働者を持つ勢力以外では難しくなったかもしれません。建物は計画的に立てましょう。  
- また、新計算式においては、作業速度だけ早くて建築効率の悪いユニット**(要するに帝国の「コロヌス・スケレトゥム」です)**が  
  作業グループに混じってしまうと、かなり建築効率が落ちてしまうことに注意してください。

### その他
- Perk「命の収穫」によるクリティカルが建物に対しては発生しないように変更。
- 研究「荷車」シリーズによる作業効率への影響を各々+12%（計+24%）へ統一。  
  計算パフォーマンス向上のための変更です。ゲームバランスへの影響はほぼないと思われます。  



## バランス各論
既存勢力・既存ユニットへの兵科や装備の追加については、今後もバランス変更として扱います。  
また、既存ユニットのステータス変更は勢力ごとにテーブル化するようにします。  

### 装備総論
#### 槍の変更
- 「コントス」系の両手騎兵槍に微弱な盾破壊効果を追加。
- 片手槍の武器スキル「リペル」は騎兵相手に追加白兵戦ペナルティを付与するように変更。

#### 銃の変更
- 「ハンドゴン」の射程を13pix増加。  
  出撃するタイミングを鑑みると威力を上げてなおパワー不足であると思われるため。
- 「エインヘリャル」の射程を5pix増加。
- 「Fusil Charleville」の射程を20pix増加。  
  終盤の敵用の武器にしては微妙だったため。

### ヒュペルボレイア
#### ユニットの変更
- カラス系ユニットの性能変更  
  彼らはクラシック版では、範囲攻撃可能な飛び道具がないと駆逐に時間がかかるウザキャラとして実装されました。  
  もっともLegacyにおいて、彼らは明らかにパワー不足で、鬱陶しさも薄れてしまっていました。    
  そこで、範囲攻撃で対処すれば一網打尽という点は残しつつ、もう少し無視できないように調整しました。
  - 「オオガラス」
    - Perk 「身躱し」を付与。
  - 「ネヴァーモア」
    - スキル「マインドブラスト」を使うように変更。
    - Perk 「身躱し」、「弾道予測」を付与。
- ユニットステータス変更表  
| Name | HP | SP | Hit | Eva | MR | Will | Move Speed |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :---| :--- |
| オオガラス | 0 | 0 | 0 | +5 | 0 | 0 | 0 |
| ネヴァーモア | 0 | 0 | 0 | +5 | 0 | 0 | 0 |

### 竜族
- ボンバルドラ・ギャオンの変更
  - 攻撃力を+3、移動速度を+5増加。  
   実は前版における大砲を対象とした調整がボンバルドラには行われていませんでした。  
   当初は単なる調整し忘れだったので合わせてもいいんですが、せっかくなので機動力を強調して性能に差異を作るように。  
   攻撃力増加は調整への補填というよりキリのいい数字にするためのものでしかなく、火力においては人間の大砲よりも劣ります。
- ユニットステータス変更表  
| Name | HP | SP | AD | Hit | Eva | MR | Will | Move Speed |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :---| :--- |
| ボンバルドラ・ギャオン | 0 | 0 | +3 | 0 | 0 | 0 | 0 | +5 |


### 帝国
- 内政の調整 **(TODO)**
  - デカダンスの効果で市場の資源価値がインフレしていくように変更。  
    設定の反映もとい内政の高難度化。中盤の資源調整がやりにくくなります。  
    最終盤に過剰資源を売り払って得られる金の量が増えるため、単なる弱体化というわけではないかもしれません。  
    - デカダンス一段階ごとに資源購入コストが+40%、資源売却で得られる金の量が+10%されるように。  
#### 演出
- 「帝国支援ドロメダリィ」の騎手を今後実装予定の南方人仕様へ変更。
- 「帝国マムルーク・ブケラリィ」の騎手に南方人が混ざるように変更。

### ポテチ
- 勢力マークをよりロアフレンドリーなものに変更。

### スシ

#### 総論
- Choomaque氏作曲のテーマソングを追加 *TODO*。   

#### ユニットの変更
- 衝撃騎兵シリーズの変更
  バランス上の問題というよりも、使用資源の種類を統一するための変更。  
  スシの衝撃騎兵は強力な分、食料、木、金という三種類の資源を消費する高級ユニットに。  
  - コスト変更
    - 「ステップランサー」の生産コストを[食料70,木30]から[食料60,木20,金5]へ変更。
    - 「ステップ重ランサー」の生産コストを[食料70,木30]から[食料65,木25,金25]へ変更。
    - 「ステップハーン護衛兵」の生産コストを[木50,金75]から[食料70,木30,金45]に変更。
  - 出し辛くなる分補填で全体的に強化。
    - 「ステップ重ランサー」の鎧を「プレーテッドレザーラメラー」、馬を「軍馬」に変更。
    - 「ステップハーン護衛兵」にPerk「恐怖そのもの」を付与。
    - 詳細なパラメータ変動は後述。
  
- 「ステップ災厄騎兵」の変更  
  - 生産コストを[食料60,金55]から[食料65,金35]へ変更。
    何をどう考えても金55の価値はないため。
  - 移動速度を増加。  
    タルカン…
  

- ユニットステータス変更表  
| Name | HP | SP | Hit | Eva | MR | Will | Move Speed |  
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :---| :--- |  
| ステップランサー | +50 | +2 | +1 | 0 | 0 | +2 | +1 |  
| ステップ重ランサー | 0 | +3 | +1 | +1 | 0 | +1 | +3 |  
| ステップハーン護衛兵 | +80 | +4 | 0 | +2 | +10 | +2 | 0 |  
| ステップ災厄騎兵 | 0 | 0 | 0 | 0 | 0 | 0 | +8 |

#### 装備の変更
- 武器「ステップ・ウォーランス」を追加。  
  片手騎兵槍としては最強の性能です。「ステップハーン護衛兵」が装備します。  
| TYPE | AD | AR eff. | AR pen. | Hit | Crit | Range | Attack Speed | Skill | Passive | AA bits |
|:--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 長柄 | 74 | 125% | 30% | +5 | +1% | 36 | 60 | ランスチャージ | / | 対騎兵特効 |
  
  
- 武器「ステップランス」の調整  
  上位武器が追加された兼ね合いで調整。  
  短くして対騎兵ビットを消去した代わりにDPSを向上。取り回しやすくしたイメージ。  
  - 射程を32pix->31pixに変更。
  - 攻撃速度を68->75に変更。
  - 対騎兵効果を削除。

### マップの変更
## 演出
- 馬に乗った騎兵ユニットに待機モーションを追加。  
- 馬に乗った騎兵ユニットがノックバック・スネア・スタンといった行動制限効果を受けた際のモーションを追加。
- 一部の片手剣または片手槍を持った騎兵は，スピードボーナスが有効かつ戦闘状態時の移動モーションでより攻撃的な武器の構え方をするように変更。
- 一部の武器に移動アニメーションを設定(「帝国重コントス」等)。
- 死体の吹き飛び方を調整。 *要塞確認・TODO*

## パフォーマンス
- 労働者の仕事処理をリファクタリングして軽量化。  
  建築物等の検索機能がついた以外ほとんど大昔の仕様のままで、非常に効率の悪い作りになっていました。  
  エンデュランス後半の重さがマシになるかもしれません。  
- 画像バッファ機能を使った処理軽量化のうち、導入を見合わせていたものを復活。  
  そろそろ大丈夫でしょう……たぶん……  
- 弾の処理をついにリファクタリング。  
  変なバグが出るかもしれないです
- UI回りで無駄な計算が行われていたのを削減。  
- ユニットに対する色彩効果処理を分割して軽量化。 
- スキル発動AIの無駄な処理をしていた部分を削除。
- ミニマップ処理に必要のない描画処理が挟まれていたのを削除。
- 天候表現のうち、乗算の有無如何で表現に差異がないものから乗算効果を削除。
- ランスチャージがヒットした際に呼び出される処理に無駄な部分があったのを修正。
- その他細かい効率化

## その他
- セーブ時にどのスロットにセーブされたかの表示が出るように変更。  
- ボーナステキスト中の年表の一部を修正。 *TODO*

# 修正

## v1.162からの修正:

### バランスに関係するもの
- 研究「徴用」の効果がv1.162では実際には発揮されていなかった不具合を修正（！）
- 初期配置される斥候と街の人に文化設定がされていなかった不具合を修正。
- 学問所のAPボーナスの作動条件が変だったのを修正（その挙動自体は下記参照）。
  - チャームの自動使用を禁止した場合妖狐に対して作用しない場合があった
  - 敵の魔法ユニットに対してもボーナス効果が発揮されていることがあった
- スキル「マインドブラスト」に加えられたダメージ付与の変更が反映されていなかったのを修正 *TODO*
- ランスチャージ系スキルによる盾割り効果が発動していなかったのを修正。

### 表示系
- クロースアーマーの画像に1ピクセルのゴミがついていたのを修正。  
- 「らくだ」用の日本語翻訳対応がずれていたのを修正。
- かたつむりの攻撃待機中グラフィックが消えていたのを修正。
- 実績取得時の表示フォントが崩れていた不具合を修正。
- ユニット撤退時の"RETREAT!"表示に廃止予定のフォントが適用されていたのを修正。

### 表記
- スピードボーナスの効果が「移動速度の10%」ではなく「移動速度の8%」と表記されていたのを修正。
- 「ミゾクティウス」が実際には白兵戦ペナルティを受けるにも関わらず、  
  パッシブ効果に「白兵戦ペナルティを受けない」という記載があったのを修正。
- 「天帝南征」のオトナスと旗持ち軍団兵のユニット表記が英語固定になっていたのを修正。

# プレイヤーにはほぼ関係のない変更
- コンソール機能をjs制御のものに変更。  
  また、テストプレイ時以外もF10からコンソールを呼べるように変更。
- 暗号化用jsライブラリCryptoJSを導入。
- ~~このバージョンからソースコードを同梱するように変更。~~  
  元々github上で公開していましたが、リンクが貼ってあるのがitch.ioのみで非常にアクセスし辛かったため。  
  中身が気になる人はどうぞ。まああまりにも汚くて読めないと思いますが。
- 一部の文字列には、より簡素なカラータグを使って色指定ができるように変更。
- ユニットスキンシステムをJSON制御に対応。

# 試験的要素（次回アップデートにおそらく含まれない分）
## ビリヤニ首長国（追加ファクション）
- 日本語名をセット。


# BETA版の修正
- 資源回収回りのバグを修正(fix1)
 - 異常な速度で資源が集まる
 - 竜族の資源リミットが増えない
- 建物建築速度のバグを修正(fix1)
- メモリ割当が壊れており，大量のユニットが出るとゲームに不具合が生じていたのを修正(fix2)
- 嶋マップで船を破壊しても変な場所から敵が出現しつづけていた不具合を修正
- 索敵AIが建物を対象に取ると破損していた，具体的には味方を狙ったり変な方向に向かったりすることがあったのを修正
- 弾の命中フラグ管理に不備があり，クラッシュを誘発していた不具合を修正
- スコーピオンの弾が，最初に命中したユニットのみならず，命中したユニット全てをノックバックさせていた不具合を修正。
- 「オルク神風野郎」の自爆によるダメージが確定でクリティカルしていた不具合を修正
- 「ネヴァーモア」のSPが回復していなかった不具合を修正(ここまでfix3)
- スキル「シェイドグラスプ」の弾道処理が破損していた不具合を修正
- スキル「ライトニングボルト」が命中した全ての敵ユニットをスタンしていた不具合を修正
