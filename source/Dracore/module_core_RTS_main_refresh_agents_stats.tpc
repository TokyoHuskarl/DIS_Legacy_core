__fn agent_ref_stats(){
    //@comment "Get [1-100]"

    //@comment "remove inertia"
    agent_AgentBits &= -17//~16
    /*@comment "########################
    Process Parameters Setting BEGIN
########################"*/
    //@comment "#Set ForceSprite Default"
    @if agent_ActionState < 4 {
        agent_ForceSprite = -2
        
    }
    //@comment "#Base Parameters Get"
    v[709].copy agent_ProcessAD, 11
    v[731].copy v[872], 2
    agent_ProcessObjBit = v[740]
    v[875] = v[739]
    //@comment "#SP fatigue penalty"
    v[868] -= !(agent_ExMotionFlags & 2048) ? muldiv(v[868], v[707] - v[708], v[707]) / 2 / (!(agent_PerkFlagBits1 & 32768) ? 1 : 2) : 0
    //@comment "#ProcessCamo dealed in per3f"
    v[877] = 0
    /*@comment "##############
#Terrain Check#
##############"*/
    //@comment "#Suitable Terrain"
    @if `agent_AgentBits & 2 {
        v[868] = muldiv(v[868], 120, 100)
        
    }
    //@comment "#Water Terrain"
    @if `agent_AgentBits & 1 {
        //@comment "pathfinder"
        @if `agent_PerkFlagBits1 & agent_PerkFlagBits1_FLAG_Pathfinder {
            agent_ProcessMS -= agent_ProcessMS>>2 //muldiv(v[868], 3, 4)
            agent_ProcessSPReg -= 1
            
        } .else bl {
            agent_ProcessEVA -= agent_ProcessEVA>>2 //muldiv(v[866], 3, 4)
            agent_ProcessMS /= 2
            agent_ProcessSPReg -= 2
            
        }
        
    }
    //@comment "#Ice"
    @if `agent_AgentBits & 32 {
        agent_AgentBits |= 16
        v[868] += v[868]>>2 //muldiv(v[868], 125, 100)
        
    }
    //@comment "#Horse in forest"
    v[868] = agent_AgentBits & 8 ? muldiv(v[868], agent_AgentBits & 128 ? 60 : 80, 100) : v[868]
    /*@comment "##################
#Terrain Check End#
##################"*/


    //Check TileFlags begin

    Ptr5 = Const_save_var_TileFlags + v[632]
    
    __if DIS_EXPERIMENTAL == 1 {
	TT10 = Const_AgentMetaTeam_begin + v[v[536]]//get Meta team

    	@if `v[Ptr5] & (FLAG_Maptile_ShieldCoverTeam0 << v[TT10])
{//covered by other guy's shield wall
		//EXPERIMENTAL - just check if it's working
		agent_HP -= 1
		agent_ProcessInstantState |= agent_ProcessInstantState_FLAG_shield_covered
	}

	//FLAG_Maptile_PikeWallTeam0 = 256
	//FLAG_Maptile_PikeWallTeam1 = 512
	//FLAG_Maptile_PikeWallTeam2 = 1024
	//check if under other team's pike effect or not
	agent_MeleeFightTimer = v[Ptr5] & (1792 & ~(FLAG_Maptile_PikeWallTeam0<<v[TT10]))?Const_Melee_Fight_Time_by_Melee_Attack:agent_MeleeFightTimer
	
		
    }


    //Check TileFlags end


    //@comment "#Buff/Debuff Effects"
    s[119].on
    v[235] = 671
    v[371] = 0
    @while v[v[235]] > v[1186] {
        v[234] = v[235] + 15
        @call .cev v[v[235]]
        //@comment "#タイマー切れてたら消す"
        @if v[v[234]] <= 0 {
            v[v[235]] = 0
            v[371] = 1
            
        }
        v[235] += 1
        
    }

    @if v[371] == 1 {
        v[235] = 671
        v[234] = 686
        v[v[235]].sortDescending 8 .sync v[v[234]]
        
    }
    s[119].off
    /*@comment "##############
	#Perk Check#
	##############"*/
    /*@comment "#Last Stand
    gains Attack Speed based on missing Health."*/
    v[871] += v[665] & 524288 ? divmul(v[871], v[705], v[705] - v[706]) : 0
    /*@comment "##################
	#Perk Check End#
	##################"
        ##############
	#Morale Check#
	##############"*/
    //v[341] = v[860]
    TT2 = 10 - agent_Morale // save 10-agent_Morale
    v[862..866] *= TT2
    v[862..866] /= 10
    //@comment "##Flee"
    @if agent_Morale == 3 {
        agent_ProcessInstantState |= agent_ProcessInstantState_FLAG_blind
        agent_ProcessObjBit |= 67110400//1024+512+67108864
        agent_ProcessObjBit &= -16793601//~16793600//(16777216+16384)
        //agent_ProcessObjBit |= 67108864 24.4.23
        v[842] = 11
        agent_ActionState = 0
        //@comment "#Break Discipline"
        //@comment "Will/4"
        //v[875] /= 4
	v[875] >>= 2
        //v[869] = v[869..870] = [9899999, 0]
	v[870] = 9899999 //is it fucking serious? what is going on?
	v[869] = 0
        v[868] += v[868]>>3 //muldiv(v[868], 110, 100)
        
    } .else bl {
        v[875] = muldiv(v[875], TT2, 10)
        //@comment "#Mages"
        @if v[702] == 4 {
            //@comment "Player only"
            @if v[800] == 0 {
                v[862] += muldiv(v[710], 4 * v[493], 100) + v[493]
                
            }
            
        } .else bl {
            //@comment "#Civilians"
            @if v[702] == 9 {
		agent_ProcessAD = v[709]
                v[341] = v[2409 + v[700] % 3]//get tech
                //@comment "cart1"
                @if `v[341] & 16 {
                    v[871] += muldiv(v[719], 12, 100)
                    v[868] = muldiv(v[868], 11, 10)
                    
                }
                //@comment "cart2"
                @if `v[341] & 32 {
                    v[871] += muldiv(v[719], 10, 100)
                    v[868] = muldiv(v[868], 11, 10)
                    
                }
                //@comment "crane"
                agent_ProcessAD += v[341] & 64 ? muldiv(agent_ProcessAD, 20, 100) : 0
                
            }
            
        }
        /*"##############
	#Fighting Order#
	##############"*/
        //v[341] = v[848]
        @if agent_TacticsOrderFlag >= 1 {

                    
 		@if `agent_TacticsOrderFlag & 2 {
 			@if `!(agent_ProcessObjBit & 67108864) {
				v[863] += muldiv(v[711], 30, 100)
				v[864] += muldiv(v[712], 30, 100)
				v[866] += muldiv(v[714], 40, 100)
				v[871] /= 2
				v[868] = muldiv(v[868], 8, 10)
				//@comment "#Force Spr"
				v[850] = 2
                        }
                }.elif `agent_TacticsOrderFlag & 4 {//stronger shield wall
 			@if `!(agent_ProcessObjBit & 67108864) {
				v[863] += muldiv(v[711], 40, 100)
				v[864] += muldiv(v[712], 40, 100)
				v[866] += v[714] / 2
				v[871] /= 2
				v[868] = muldiv(v[868], 8, 10)
				agent_ProcessObjBit |= 8192
				//@comment "#Force Spr"
				v[850] = 2
			}
                        
                }.elif `agent_TacticsOrderFlag & 1 {//@comment "##pikewall"
                    v[865] = muldiv(v[865], 12, 10)
                    agent_ProcessAS -= agent_ProcessAS>>3 //muldiv(v[871], 88, 100)

                    v[869] += 5000
                    v[868] /= 2
                    //@comment "##knock back immunity"
                    agent_ProcessObjBit |= 8
                    //@comment "#ForceSpr"
                    v[850] = 2
                    
                } .elif `agent_TacticsOrderFlag & 8 {//@comment "##Skirmishing" 
                    v[870] = v[869] / 2
                    v[869] = muldiv(v[869], 9, 10)
                    v[865] = muldiv(v[865], 9, 10)
                    v[871] = muldiv(v[871], 14, 10)
                    
                } .elif `agent_TacticsOrderFlag & 16 {//@comment "##Cast Support"
                    v[870] = v[869] / 2
                    v[869] += v[869]>>3 //muldiv(v[869], 11, 10)
                    v[868] += agent_ProcessMS>>2 //muldiv(v[868], 75, 100)
                    v[873] += 2
                    
                }.elif `agent_TacticsOrderFlag & 64 {//@comment "##Rallying"
                    v[863] += muldiv(v[711], 10, 100)
                    v[864] += muldiv(v[712], 10, 100)
                    v[871] /= 2
                    v[868] = muldiv(v[868], 8, 10)
                    agent_ProcessWill += agent_ProcessWill / 2 //muldiv(v[875], 50, 100)
                    v[876] = 0
                    
                }.elif `agent_TacticsOrderFlag & 128 {//@comment "##Observation Flag"
                    v[863] += muldiv(v[711], 10, 100)
                    v[864] += muldiv(v[712], 10, 100)
                    v[871] /= 2
                    v[868] = muldiv(v[868], 8, 10)
                    v[875] += muldiv(v[875], 50, 100)
                    v[876] += 500000
                    
                }

                
            
            
        }
        /*########################
#Fighting Order END########################"*/
        
    }
    /*@comment "#################
#Morale Check End#
#################"*/
    //@comment "#In Melee Combat"
    //v[0] = v[681] >= 1 ? (v[868..874] = [divmul(v[868], 100, 75), v[869], v[870], muldiv(v[871], 9, 10), v[872], divmul(v[873], 5, 4), agent_ProcessObjBit & ~16384 & ~1 & ~134217728]) : 0
    @if agent_MeleeFightTimer>1{
	    agent_ProcessMS -= agent_ProcessMS>>2 //divmul(v[868], 100, 75)
	    agent_ProcessAS -= agent_ProcessAS>>3
	    agent_ProcessSPReg = muldiv(agent_ProcessSPReg,5,4) //-20%
	    agent_ProcessObjBit &= -134234114//~134234113(agent_BaseObjBit_FLAG_SpeedBonus)//~16384 & ~1 & ~134217728

	    //Crowded?
	    agent_ProcessMS -= v[Temp2]&FLAG_Maptile_Crowded?agent_ProcessMS>>3:0 //-12.5%

    }.elif agent_ProcessObjBit & agent_BaseObjBit_FLAG_SpeedBonus {
        @if agent_AAType == 0 {//Melee - addition for throwing weapon owners are done in other proc I believe 
            agent_ProcessAD += muldiv(agent_ProcessMS, 8, 100)
            
        }
        
    }
    //@comment "#Set Process Parameters"
    /*@comment "########################
    Process Parameters Setting END
########################"*/
}



