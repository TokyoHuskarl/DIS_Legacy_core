//Kill Retreat

#include "./../headers/header_drawing.tpc"
//Kill
cev .id(41) .name("BattleSystemFunc:Kill Agent"){
	@comment "module_core_RTS_battlesystem_remove_agent_funcs.tpc"
	/*// "Access19 = AttackerObjectID
	Access20 = TargetObjectID
	Access18 = ObjTypeチェックPtr
	var1=Is_fatality
	var10=raw_damage 誤作動防止"*/
	//Ptr10 = v[300]*300
	s[212].off
	@if v[300] > 0 {
	    @if v[300] <= v[1004] {
		// "safety >0"
		@if v[v[298]] > 0 {
		    // "309 = ID 306 = ActionState"
		    Ptr10 = v[300] * 300 
		    v[311] = Ptr10+4707
		    v[826] = Ptr10+ 4826 
		    // "Flagset"
		    v[v[826]] &= ~524288
		    // "Can be FATALITY?"
		    v[371] = v[11]
		    // "Randomise upsidedown"
		    v[v[826]] |= v[Ptr10 + 4802] != 2 ? [0, 0, 4096][rnd(0, 2)] : 0
		    // "-1を死体とする"
		    // "ObjIDを死体に変える"
		    v[331] = v[v[298]]
		    v[v[298]] = -1
		    v[603] = v[v[298] + 2]
		    // "ActionStateを死体に変える"
		    v[306] += 4943
		    v[v[306]] = -1
		    v[311] = Ptr10 +4707
		    v[305] = v[v[311]]
		    v[v[311]].copy v[305], 2
		    // "GEt Morton Space"
		    v[609] = v[311] + 2
		    // "Colour"
		    v[Ptr10 + 4995] = 0
		    v[341] = v[Ptr10 + 4985]
		    v[0] = v[4013..4016] = [v[341] * 1, v[341] * -2, v[341] * -2, v[341] * -2]
		    // "#base colour"
		    v[0] = v[4001..4004] = [-22, -22, -22, -34]
		    // "#"
		    // "If victim is explosive"
		    v[373] = 0
		    @if `v[Ptr10 + 4974] & 2097152 {
			v[190] = 4
			v[Ptr10 + 4780] = v[Ptr10 + 4780] <= 0 ? 50 : Ptr10 + 4780
			v[607].copy v[361], 2
			@loop v[1017] .dst v[320] {
			    v[242] %= v[1017]
			    v[351] = v[242] * 100 
			    v[351] += v[1018]
			    @if v[v[351]] <= 1 {
				v[1301].copy v[v[351]], 100
				v[v[351]] = 2
				v[v[351] + 8] = v[300]
				v[v[351] + 10] = 1236
				v[110] = v[v[351] + 98] = v[Ptr10 + 4810]
				v[v[351] + 99] = 2
				v[341] = v[351] + 6
				v[305].copy v[v[341]], 2
				// "仕上げに登録消す"
				v[242..243] += 1
				s[141].off
				@break
				
			    }
			    v[242] += 1
			    
			}
			
			@if v[110] > 300 {
			    v[373] = 1
			    
			}
			
		    }
		    @if s[302] .isOn() {
			v[Ptr10 + 4780] = 0
			
		    } .else bl {
			v[Ptr10 + 4780] *= 2
			
		    }
		    // "#Frozen to death"
		    @if v[190] == 5 {
			// "#base colour"
			v[0] = v[4001..4004] = [55, 78, 91, -55]
			
		    } .else bl {
			// "#Death by fire!"
			@if v[190] == 4 {
			    // "#base colour"
			    //opt 28.4.23
			    //v[0] = v[4001..4004] = [-15, -15, -15, -34]
			    v[4001..4003] = -15 
			    v[4004] = -93
			    v[4001..4004] *= 4
			    v[4013..4016] = 0
			    // "#Dust Particle Effect"
			    @loop v[1017] .dst v[320] {
				v[244] %= v[1199]
				v[351] = v[244] * 50 
				v[351] += v[1198]
				@if v[v[351]] <= 1 {
				    // "まず清掃"
				    v[1301].copy v[v[351]], 50
				    // "ポインタセット開始"
				    // "設定"
				    v[v[351]] = 1
				    // "500F"
				    v[v[351] + 49] = 120
				    // "Set itself"
				    v[v[351] + 3] = 135
				    // "普通にアニメ"
				    v[341] = v[351] + 6
				    v[305].copy v[v[341]], 2
				    // "仕上げに登録消す"
				    s[141].off
				    v[244] += 1
				    @break
				    
				}
				v[244] += 1
				
			    }
			    
			    @if v[20] >= 400 {
				v[371] = 1
				v[373] = 1
				
			    }
			    
			}
			
		    }
		    v[4001] .add v[4013], 4
		    v[4005] = Ptr10 
		    v[4005] += 4991
		    v[4001].copy v[v[4005]], 4
		    // "Transparency"
		    v[Ptr10 + 4998] = 0
		    v[305].copy v[11], 2
		    v[12] += 14
		    @call .cev 2010
		    // "#WATER"
		    @if `v[v[4505] + v[23]] & 1 {
			v[Ptr10 + 4998] = 35
			
		    }
		    // "#Forest"
		    @if `v[v[4505] + v[23]] & 8 {
			v[Ptr10 + 4998] = 35
			
		    }
		    // "Set Head XY"
		    v[341] = Ptr10 
		    v[341] += 4983
		    v[0] = v[v[341]..v[341] + 1] = [v[305] * 10000, v[306] * 10000]
		    v[341] = v[341] + 2
		    v[1301].copy v[v[341]], 4
		    // "Dead sprite"
		    v[Ptr10 + 4988] = 0
		    v[320] = v[311] + 14
		    v[321] = v[v[320]]
		    v[0] = s[101] = v[v[320]] >= 0 ? 0 : 1
			//####
		    v[320] = v[311] + 94
		    v[320] = v[v[320]]
		    v[321] = 1
		    v[700] = 4800 + v[308]
		    // " Stop AI"
		    v[Ptr10 + 4703] &= ~1048576
		    v[Ptr10 + 4981] = 0
		    v[Ptr10 + 4982] = 0
		    @if v[331] <= 10 {
			// "NOT STATIC"
			// "#Can Bleed?"
			v[372] = (v[Ptr10 + 4840] & 4096) == 4096 ? 1 : 0
			@if s[313] .isOn() {
			    //@call .cev 1924
				func_logupdate_begin()
			    v[341] = 2
			    v[342] = [10, 5, 8, 1][v[v[700]]]
			    v[330] = v[4562] + v[300]
			    @pic[v[1155]].strpic {
				t[20306]
				.pos v[341], v[1126] .bottomLeft
				.size 0, 0                        .chromakey 1
				.scale 100
				.trans 30
				.rgbs 100, 100, 100, 100
				.font t[530], v[4511]
				.spacing 0, 4
				.skin "" .nobg .noframe .noPadding
				.mapLayer 8
				.eraseWhenTransfer
				.affectedByFlash
				.affectedByShake
			    }
			    //@call .cev 1925
				func_logupdate_end()
			    
			}
			// "################"
			v[305].copy v[607], 2
			@if s[220] .isOn() {
			    // "#########################"
			    v[472] = divmul(80, 100, v[2216])
			    v[473] = rnd(85, 95)
			    v[474] = divmul(v[607] + v[1001], v[1281], 50)
			    // "#########################"
			    // "If victim has big flag"
			    @if `(v[Ptr10 + 4974] & 524288) > 0 {
				// "#Sounds more heavier"
				v[473] -= 18
				// "#Dust Particle Effect"
				@loop v[1017] .dst v[320] {
				    v[244] %= v[1199]
				    v[351] = v[244] * 50 
				    v[351] += v[1198]
				    @if v[v[351]] <= 1 {
					// "まず清掃"
					v[1301].copy v[v[351]], 50
					// "ポインタセット開始"
					// "設定"
					v[v[351]] = 1
					// "500F"
					v[v[351] + 49] = 3
					// "Set itself"
					v[v[351] + 3] = 131
					// "普通にアニメ"
					v[341] = v[351] + 6
					v[607].copy v[v[341]], 2
					// "仕上げに登録消す"
					s[141].off
					v[244] += 1
					@break
					
				    }
				    v[244] += 1
				    
				}
				
				
			    }
			    @cmd 11550, "Falldown", .args v[472], 3
			    @if v[372] == 0 {
				// "Get Race"
				v[341] = Ptr10 
				v[341] += 4764
				@loop 1 {
				    // "#Human"
				    @if v[v[341]] == 0 {
					@if `v[Ptr10 + 4738] & 2 {
					    v[329] = rnd(1, 1)
					    // "#########################"
					    v[472] = divmul(75, 100, v[2216])
					    v[473] = rnd(75, 115)
					    v[474] = divmul(v[607] + v[1001], v[1281], 50)
					    t[510] .asg "vo\horse_death"
					    t[510] .cat v[329]
					    v[341] = 510
					    // "Strings = t[v[341]]"
					    @cmd 11550, t[v[341]], .args v[472], 3
					    // "#########################"
					    
					} .else bl {
					    v[341] -= 1
					    // "##Not Female"
					    v[182] += 1
					    @if v[v[341]] != 6 {
						@if v[190] == 4 {
						    v[329] = rnd(1, 3)
						    // "#########################"
						    v[472] = divmul(85, 100, v[2216])
						    v[473] = rnd(90, 110)
						    v[474] = divmul(v[607] + v[1001], v[1281], 50)
						    t[510] .asg "vo\man_burnt_to_death"
						    t[510] .cat v[329]
						    v[341] = 510
						    // "Strings = t[v[341]]"
						    @cmd 11550, t[v[341]], .args v[472], 3
						    // "#########################"
						    
						} .else bl {
						    v[329] = rnd(1, 6)
						    // "#########################"
						    v[472] = divmul(75, 100, v[2216])
						    v[473] = rnd(85, 110)
						    v[474] = divmul(v[607] + v[1001], v[1281], 50)
						    t[510] .asg "vo\man_death"
						    t[510] .cat v[329]
						    v[341] = 510
						    // "Strings = t[v[341]]"
						    @cmd 11550, t[v[341]], .args v[472], 3
						    // "#########################"
						    
						}
						
					    } .else bl {
						// "##Female"
						v[329] = rnd(1, 5)
						// "#########################"
						v[472] = divmul(75, 100, v[2216])
						v[473] = rnd(95, 115)
						v[474] = divmul(v[607] + v[1001], v[1281], 50)
						t[510] .asg "vo\woman_death"
						t[510] .cat v[329]
						v[341] = 510
						// "Strings = t[v[341]]"
						@cmd 11550, t[v[341]], .args v[472], 3
						// "#########################"
						
					    }
					    
					}
					@break
					
				    }
				    // "#Goblin"
				    @if v[v[341]] == 1 {
					v[182] += 1
					@if v[190] == 4 {
					    v[329] = rnd(1, 3)
					    // "#########################"
					    v[472] = divmul(85, 100, v[2216])
					    v[473] = rnd(90, 110)
					    v[474] = divmul(v[607] + v[1001], v[1281], 50)
					    t[510] .asg "vo\goblin_scream"
					    t[510] .cat v[329]
					    v[341] = 510
					    // "Strings = t[v[341]]"
					    @cmd 11550, t[v[341]], .args v[472], 3
					    // "#########################"
					    
					} .else bl {
					    v[329] = rnd(1, 2)
					    // "#########################"
					    v[472] = divmul(75, 100, v[2216])
					    v[473] = rnd(90, 110)
					    v[474] = divmul(v[607] + v[1001], v[1281], 50)
					    t[510] .asg "vo\goblin_death"
					    t[510] .cat v[329]
					    v[341] = 510
					    // "Strings = t[v[341]]"
					    @cmd 11550, t[v[341]], .args v[472], 3
					    // "#########################"
					    
					}
					@break
					
				    }
				    // "#Ork"
				    @if v[v[341]] == 2 {
					v[182] += 1
					@if v[190] == 4 {
					    v[329] = rnd(1, 3)
					    // "#########################"
					    v[472] = divmul(85, 100, v[2216])
					    v[473] = rnd(90, 110)
					    v[474] = divmul(v[607] + v[1001], v[1281], 50)
					    t[510] .asg "vo\ork_scream"
					    t[510] .cat v[329]
					    v[341] = 510
					    // "Strings = t[v[341]]"
					    @cmd 11550, t[v[341]], .args v[472], 3
					    // "#########################"
					    
					} .else bl {
					    v[329] = rnd(1, 4)
					    // "#########################"
					    v[472] = divmul(75, 100, v[2216])
					    v[473] = rnd(85, 110)
					    v[474] = divmul(v[607] + v[1001], v[1281], 50)
					    t[510] .asg "vo\ork_death"
					    t[510] .cat v[329]
					    v[341] = 510
					    // "Strings = t[v[341]]"
					    @cmd 11550, t[v[341]], .args v[472], 3
					    // "#########################"
					    
					}
					@break
					
				    }
				    // "#Dragons"
				    @if v[v[341]] == 3 {
					v[182] += 1
					@if v[190] == 4 {
					    // "#########################"
					    v[472] = divmul(85, 100, v[2216])
					    v[473] = rnd(90, 110)
					    v[474] = divmul(v[607] + v[1001], v[1281], 50)
					    // "Strings = t[v[341]]"
					    @se.play "vo\dragon_gyaoo" .opt v[472], v[473], v[474]
					    // "#########################"
					    
					} .else bl {
					    v[329] = rnd(1, 2)
					    // "#########################"
					    v[472] = divmul(75, 100, v[2216])
					    v[473] = rnd(90, 110)
					    v[474] = divmul(v[607] + v[1001], v[1281], 50)
					    t[510] .asg "vo\Dragon_death"
					    t[510] .cat v[329]
					    v[341] = 510
					    // "Strings = t[v[341]]"
					    @cmd 11550, t[v[341]], .args v[472], 3
					    // "#########################"
					    
					}
					@break
					
				    }
				    // "#Minotaurs"
				    @if v[v[341]] == 6 {
					v[182] += 1
					@if v[190] == 4 {
					    // "#########################"
					    v[472] = divmul(85, 100, v[2216])
					    v[473] = rnd(90, 110)
					    v[474] = divmul(v[607] + v[1001], v[1281], 50)
					    // "Strings = t[v[341]]"
					    @se.play "vo\minotaur_death1" .opt v[472], v[473], v[474]
					    // "#########################"
					    
					} .else bl {
					    v[329] = rnd(1, 3)
					    // "#########################"
					    v[472] = divmul(75, 100, v[2216])
					    v[473] = rnd(90, 110)
					    v[474] = divmul(v[607] + v[1001], v[1281], 50)
					    t[510] .asg "vo\minotaur_death"
					    t[510] .cat v[329]
					    v[341] = 510
					    // "Strings = t[v[341]]"
					    @cmd 11550, t[v[341]], .args v[472], 3
					    // "#########################"
					    
					}
					@break
					
				    }
				    
				}
				
				// "Fatality"
				v[11] = rnd(5, 7)
				v[12] = 2
				@if v[371] == 1 {
				    v[11] *= 2
				    v[12] += 1
				    // "Cut"
				    @if v[190] == 0 {
					// "#########################"
					v[471] = 11550
					v[472] = divmul(80, 100, v[2216])
					v[473] = rnd(90, 110)
					v[474] = divmul(v[607] + v[1001], v[1281], 50)
					// "#########################"
					@cmd v[471], "gib\beheaded_nenetei", .args v[472], 3
					
				    }
				    // "Pierce"
				    @if v[190] == 1 {
					// "#########################"
					v[471] = 11550
					v[472] = divmul(80, 100, v[2216])
					v[473] = rnd(90, 110)
					v[474] = divmul(v[607] + v[1001], v[1281], 50)
					// "#########################"
					@cmd v[471], "gib\gutted_nenetei", .args v[472], 3
					
				    }
				    // "Blunt"
				    @if v[190] == 2 {
					// "#########################"
					v[471] = 11550
					v[472] = divmul(80, 100, v[2216])
					v[473] = rnd(78, 90)
					v[474] = divmul(v[607] + v[1001], v[1281], 50)
					// "#########################"
					@cmd v[471], "gib\smashed_nenetei", .args v[472], 3
					
				    }
				    
				}
				// "death blood effect"
				@loop v[1017] .dst v[320] {
				    v[244] %= v[1199]
				    v[351] = v[244] * 50 + v[1198]
				    @if v[v[351]] <= 1 {
					// "まず清掃"
					v[1301].copy v[v[351]], 50
					// "ポインタセット開始"
					// "設定"
					v[v[351]] = 1
					// "500F"
					v[v[351] + 49] = v[12]
					// "Set itself"
					v[v[351] + 3] = 156
					// "Set Amount"
					v[v[351] + 1] = v[11]
					// "XY set"
					v[357] = v[351] + 6
					v[607].copy v[v[357]], 2
					// "仕上げに登録消す"
					v[244] += 1
					@break
					
				    }
				    v[244] += 1
				    
				}
				
				
			    }
			    
			}
			v[305].copy v[361], 2

			// "Set into BodyList"

			//opt 28.4.23
			//v[v[4531] + v[1004] - 1] = v[300]
			//v[v[4531] + v[1004]] += 1
			//v[341] = v[4531] + v[1004] 
			v[341] = v[4531] + v[1004]
			v[v[341]- 1] = v[300]
			v[v[341]] += 1

			v[341] -= 1
			v[v[4531]].sortDescending v[1004]
			// "FATALITY"
			v[Ptr10 + 4988] = 0
			@if v[371] == 1 {
			    @if v[372] == 0 {
				s[212].on
				// "Blood_big"
				@loop v[1163] .dst v[320] {
				    v[418] %= v[1163]
				    //opt
				    //v[301] = v[418] * 100
				    //v[301] = v[301] + v[1162]
				    v[301] = v[418] * 100
				    v[301] += v[1162]
				    @if v[v[301]] <= 1 {
					// "まず清掃"
					v[1301].copy v[v[301]], 100
					// "ポインタセット開始"
					v[310] = v[418] + v[1164]
					v[295] = v[301] + 99
					// "設定"
					v[v[301]] = 3
					// "500F"
					v[v[295]] = 600
					// "ziko"
					v[295] = v[301] + 3
					v[v[295]] = 112
					// "普通にアニメ"
					v[361] += rnd(-2, 2)
					v[362] += rnd(6, 9)
					v[305] = rnd(3, 6)
					v[361].copy v[11], 2
					v[12] -= 12
					@call .cev 2010
					// "WATER"
					v[634] = 100
					@if `v[v[4505] + v[23]] & 1 {
					    v[631] = 160
					    v[632..633] = 30
					    @pic[v[310]].show {
						"effects\sprite_fresheffects"
						.pos v[361], v[362] .center
						.scrollWithMap
						.chromakey 1
						.scale 0
						.trans 8
						.rgbs 40, 40, 40, 100
						.multi
						.grid 10, 10 .cell v[305]
						.mapLayer 2
						.eraseWhenTransfer
						.affectedByTint
						.affectedByFlash
						.affectedByShake
					    }
					    
					} .else bl {
					    v[631..633] = 100
					    @pic[v[310]].show {
						"effects\sprite_fresheffects"
						.pos v[361], v[362] .center
						.scrollWithMap
						.chromakey 1
						.scale 0
						.trans 8
						.rgbs 100, 100, 100, 100
						.grid 10, 10 .cell v[305]
						.mapLayer 2
						.eraseWhenTransfer
						.affectedByTint
						.affectedByFlash
						.affectedByShake
					    }
					    
					}
					v[295] = v[301] + 30
					v[631].copy v[v[295]], 4
					v[607] = v[301] + 6
					v[361].copy v[v[607]], 2
					// "仕上げに登録消す"
					v[418] += 1
					s[141].off
					@break
					
				    }
				    v[242] += 1
				    
				}
				
				// "Element == Cut,-decapitation"
				@if v[190] == 0 {
				    v[373] = 1
				    
				} .else bl {
				    // "Element == Blunt,-Smash Head"
				    @if v[190] == 2 {
					// "Smashable flag"
					@if `v[Ptr10 + 4826] & 64 {
					    v[899] = Ptr10 + 4999
					    v[899] = v[v[899]]
					    @while v[899] >= 1 {
						// "detect head"
						v[341] = v[899] % 10
						@if v[341] == 2 {
						    // "set crushed head sprite"
						    v[(v[300] - 1) * 6 + 1 + v[1185]] = v[Ptr10 + 4764] * -1 - 1 //ACHTUNG, outdated func
						    @break
						    
						}
						v[899] /= 10
						
					    }
					    
					    
					}
					@if v[20] >= 400 {
					    v[373] = 1
					    
					}
					
				    } .else bl {
					@if v[190] == 4 {
					    @if `v[Ptr10 + 4826] & 128 {
						v[899] = v[Ptr10 + 4999]
						@while v[899] >= 1 {
						    // "detect head"
						    v[341] = v[899] % 10
						    @if v[341] == 2 {
							// "set skull sprite"
							v[(v[300] - 1) * 6 + 1 + v[1185]] = 50000000//ACHTUNG outdatedfunc
							@break
							
						    }
						    v[899] /= 10
						    
						}
						
						
					    }
					    
					}
					
				    }
				    
				}
				@if v[373] == 1 {
				    // "Reset Head XY"
				    v[341] = Ptr10 
				    v[341] += 4983
				    v[0] = v[v[341]..v[341] + 1] = [rnd(-47000, 47000), v[Ptr10 + 4711] * -12000 + rnd(-15000, 0)]
				    v[Ptr10 + 4985] = rnd(-4, 4) * 2250
				    v[Ptr10 + 4986] = rnd(1, 4) * -300
				    v[Ptr10 + 4988] = rnd(13, 16)
				    v[Ptr10 + 4989] = rnd(-1800000, 1800000)
				    
				}
				
			    }
			    
			}
			v[v[298]] = v[331] * -1
			// "#Cause Morale Check"
			// "##Fatality affects morale more heavily"
			v[330] = v[371] == 1 ? 58 : 44
			// "#ck only 3nd dim"
			v[341] = v[v[609]] >> 4
			v[339] = v[v[1074] + v[341]]
			v[340] = v[1070] + v[341] * v[1004]
			// "GEt Lv"
			v[193] = v[Ptr10 + 4804]
			v[338] = 0
			@loop v[339] .dst v[310] {
			    v[312] = v[340] + v[310]
			    // "#confused fight"
			    @if v[310] >= 48 {
				v[338] = rnd(0, 1)
				
			    }
			    @if v[338] == 0 {
				@if v[v[312]] > 0 {
				    // "#is obj alive?"
				    v[311] = v[v[312]] * v[1117] + 4701
				    @if v[v[311]] >= 1 {
					// "team check"
					// "v1= targobj-	v2=power#30+lv/2?"
					v[11] = v[v[312]]
					//@if `v[v[700]] % 3 != v[v[311] + 99] % 3 {
					@if `v[Const_AgentMetaTeam_begin+v[300]-1] != v[Const_AgentMetaTeam_begin+v[11]-1] {
					    v[12] = v[193] / 2 + 4
					    //9.3.23
					    //@call .cev 1192
					    func_bs_morale_recover(var1 var2)
					    
					} .else bl {
					    @if s[34] .isOff() {
						v[12] = v[193] - v[v[11] * 300 + 4804] + v[330]
						//9.3.23
						//@call .cev 1193
						func_bs_morale_check(var1 var2)
						
					    }
					    
					}
					
				    }
				    
				}
				
			    }
			    
			}
			
			
		    } .else bl {
			// "STATIC"
	    		Bool_Refresh_Static_Minimap.on //request refresh minimap static
			v[341] = Ptr10 + 4712 
			v[1301].copy v[v[341]], 2
			// "wrecks remain longer"
			@if s[302] .isOff() {
			    v[Ptr10 + 4780] = v[1240] * v[4571] * 5
			    
			}
			@if s[34] .isOn() {
			    v[Ptr10 + 4780] = 10
			    
			}
			// "##########Foundation##########"
			@if `v[v[298] + 2] & 32 {
			    v[v[298]] = 0
			    v[2538] -= 1
			    @if s[34] .isOn() {
				// "refund"
				@if `v[Ptr10 + 4703] & 2097152 {
				    v[14] = v[Ptr10 + 4980]
				    @if v[14] >= 800 {
					s[175].on
					v[11] = Ptr10 + 4710
					v[v[11]].copy v[11], 2
					v[11..12] *= 2
					s[151].on
					@call .cev v[14]
					s[151].off
					v[300001] .add v[31], 4
					@call .cev 84
					
				    }
				    
				}
				
			    }
			    
			}
			@if s[175] .isOn() {
			    @if s[313] .isOn() {
				//@call .cev 1924
				func_logupdate_begin()
				v[341] = 2
				v[601] = 1
				v[342] = [10, 5, 8, 1][v[v[700]]]
				v[330] = v[4562] + v[300]
				@pic[v[1155]].strpic {
				    t[20444]
				    .pos v[341], v[1126] .bottomLeft
				    .size 0, 0                            .chromakey 1
				    .scale 100
				    .trans 30
				    .rgbs 100, 100, 100, 100
				    .font t[530], v[4511]
				    .spacing 0, 4
				    .skin "" .nobg .noframe .noPadding
				    .mapLayer 8
				    .eraseWhenTransfer
				    .affectedByFlash
				    .affectedByShake
				}
				//@call .cev 1925
				func_logupdate_end()
			    }
			    
			} .else bl {
			    @if s[313] .isOn() {
				//@call .cev 1924
				func_logupdate_begin()
				v[341] = 2
				v[601] = 1
				v[342] = [10, 5, 8, 1][v[v[700]]]
				v[330] = v[4562] + v[300]
				@pic[v[1155]].strpic {
				    t[20304]
				    .pos v[341], v[1126] .bottomLeft
				    .size 0, 0                            .chromakey 1
				    .scale 100
				    .trans 30
				    .rgbs 100, 100, 100, 100
				    .font t[530], v[4511]
				    .spacing 0, 4
				    .skin "" .nobg .noframe .noPadding
				    .mapLayer 8
				    .eraseWhenTransfer
				    .affectedByFlash
				    .affectedByShake
				}
				func_logupdate_end()
				//@call .cev 1925
				
			    }
			    
			}
			// "################"
			v[341] = v[298] + 100
			v[2515] += s[7] == 1 ? 1 : 0
			@if v[v[341]] != 6 {
			    v[v[298]] = -11
			    @if s[175] .isOff() {
				@if s[220] .isOn() {
				    @if v[v[341]] == 2 {
					// "hatake"
					v[471] = 11550
					v[472] = divmul(85, 100, v[2216])
					v[473] = rnd(75, 85)
					v[474] = divmul(v[607] + v[1001], v[1281], 50)
					// "#########################"
					@cmd v[471], "pollen", .args v[472], 3
					
				    } .else bl {
					v[305].copy v[607], 2
					// "#########################"
					v[471] = 11550
					v[472] = divmul(85, 100, v[2216])
					v[473] = rnd(75, 85)
					v[474] = divmul(v[607] + v[1001], v[1281], 50)
					// "#########################"
					@cmd v[471], "Earth1", .args v[472], 3
					s[141].on
					@call .cev 95
					
				    }
				    
				}
				
			    }
			    
			} .else bl {
			    // "Living Shadow"
			    v[v[298]] = -11
			    @if `between(v[305], v[1008], v[1009]) && between(v[306], v[1010], v[1011]) {
				v[305].copy v[607], 2
				// "#########################"
				v[471] = 11550
				v[472] = divmul(80, 100, v[2216])
				v[473] = 150
				v[474] = divmul(v[607] + v[1001], v[1281], 50)
				// "#########################"
				@cmd v[471], "Collapse2", .args v[472], 3
				s[141].on
				@call .cev 96
				
			    }
			    
			}
			// "##########	Wall##########"
			@if `v[v[298] + 101] == 107 {
			    v[v[298]] = 0
			    v[342] = v[298] + 200
			    v[v[342]].copy v[801], 6
			    // "Generate Wall"
			    @loop v[806] .dst v[2064] {
				v[286] = v[803] - v[69] + v[2061] * (v[804] - v[70]) + v[2061] * v[2064] + v[4529]
				v[287] = v[803] - v[69] + v[2061] * (v[804] - v[70]) + v[2061] * v[2064] + v[1182]
				@loop v[805] .dst v[2065] {
				    v[311] = v[2065] + v[803]
				    v[312] = v[2064] + v[804]
				    @map.getTerrain .pos v[311], v[312] .dst v[30]
				    @if v[30] >= 18 {
					v[341] = v[v[287]] % 100000 / 100
					@map.rewrite .lower .single v[341] .xywh v[311], v[312], 1, 1
					@map.getTerrain .pos v[311], v[312] .dst v[30]
					
				    }
				    v[v[287]] /= 100
				    v[v[287]] *= 100
				    v[v[287]] += v[30]
				    // "#TileFuncPushFlag"
				    v[v[286]] &= ~1
				    v[286..287] += 1
				    
				}
				
				
			    }
			    
			    // "gate"
			    @if `v[v[298] + 2] & 256 {
				v[v[298]] = -11
				v[807] = v[298] + 206
				v[v[807]].copy v[807], 3
				@loop v[809] .dst v[2064] {
				    v[286] = v[4564] * (v[807] + v[433] * v[2064]) + v[4569] - 1
				    @loop v[808] .dst v[2065] {
					// "init"
					v[287] = v[286] + 3
					// "Cost Set"
					v[v[287]] += 15
					@if `v[603] & 8 {
					    v[v[287]] -= 45
					    
					}
					// "1"
					v[286] += v[4564]
					
				    }
				    
				    
				}
				
				
			    } .else bl {
				// "justawall"
				s[174].on
				v[807] = v[298] + 206
				v[v[807]].copy v[807], 3
				@loop v[809] .dst v[2064] {
				    v[286] = v[4564] * (v[807] + v[433] * v[2064]) + v[4569] - 1
				    @loop v[808] .dst v[2065] {
					// "init"
					v[287] = v[286] + 3
					// "Cost Sub"
					v[v[287]] -= 24
					// "1"
					v[286] += v[4564]
					
				    }
				    
				    
				}
				
				
			    }
			    
			}
			// "Node Cost"
			@if `!between(v[v[298] + 101], 104, 105) {
			    v[807] = v[298] + 206
			    v[v[807]].copy v[807], 3
			    @loop v[809] .dst v[2064] {
				v[286] = v[4564] * (v[807] + v[433] * v[2064]) + v[4569] - 1
				@loop v[808] .dst v[2065] {
				    // "init"
				    v[287] = v[286] + 3
				    // "Cost Set"
				    v[v[287]] -= 5
				    // "1"
				    v[286] += v[4564]
				    
				}
				
				
			    }
			    
			    
			}
			// "##########House##########"
			@if `v[v[298] + 2] & 64 {
			    // "#Not Dragons"
			    @if `v[2403 + v[700] % 3] != 3 {
				v[v[4580] + v[700] % 3] -= 6
				// "#Potetons"
				@if `v[2403 + v[700] % 3] == 8 {
				    v[v[4580] + v[700] % 3] -= 2
				    
				}
				
			    }
			    
			}
			@if v[v[700]] == 0 {
			    v[11] = v[v[298] + 101]
			    @if v[11] != 105 {
				@if v[11] != 104 {
				    @if s[174] .isOff() {
					v[v[4580] + v[700] % 3] -= 1
					
				    }
				    v[603] = v[v[298] + 3]
				    @if `v[v[298] + 2] & 64 {
					v[496] -= 1
					s[205].on
					@call .cev 84
					s[205].off
					
				    }
				    
				}
				
			    }
			    // "Library"
			    @if v[v[341]] == 38 {
				v[493] -= 1
				
			    }
			    
			}
			// "Set into BodyList"
			@if s[174] .isOff() {
			    v[v[4531] + v[1004] - 1] = v[300]
			    v[341] = v[4531] + v[1004] - 1
			    v[v[4531]].sortDescending v[1004]
			    
			}
			s[175].off
			
		    }
		    // "Remove from UnitList"
		    v[11] = v[300]
		    v[12] = v[331]
		    @call .cev 1896
		    // "Team Get	!TEAM LIST!"
		    v[700] = Ptr10 
		    v[700] += 4800
		    v[308] = v[v[700]] % 3
		    // "NOT  neutral"
		    @if v[308] != 2 {
			v[310] = v[v[308] + 205]
			v[309] = v[1145 + v[308]]
			v[310] += v[309]
			@while v[309] <= v[310] {
			    v[311] = (v[309] + v[310]) / 2
			    @if v[v[311]] == v[300] {
				v[v[311]] = 0
				@break
				
			    } .else bl {
				@if v[v[311]] < v[300] {
				    v[310] = v[311] - 1
				    
				} .else bl {
				    v[309] = v[311] + 1
				    
				}
				
			    }
			    
			}
			
			v[309] = v[1145 + v[308]]
			v[v[309]].sortDescending v[1012]
			@if `v[v[700] + 1] > -9 {
			    // "If not STATIC, Count TroopID Death"
			    v[v[1259] + (v[v[700] + 1] - 1) * 4 + 2 + v[v[700] - 42] * v[1260] * 4] += 1
			    
			}
			// "Coｌなし施設はカウントされてないので引かない"
			v[343] = Ptr10 
			v[343] += 4802
			@if v[308] == 0 {
			    v[205] -= v[v[343]] != 104 && v[v[343]] != 105 && s[174] == 0 ? 1 : 0
			    v[2513] += 1
			    
			} .else bl {
			    v[206] -= v[v[343]] != 104 && v[v[343]] != 105 && s[174] == 0 ? 1 : 0
			    v[2514] += 1
			    
			}
			
		    }
		    s[174].off
		    // "Collision Counter"
		    v[196] -= v[Ptr10 + 4739] != -1 ? 1 : 0
		    // "EXP"
		    v[2701] += v[v[700]] == 1 ? v[v[700] - 41] : 0
		    // "Set HP 0"
		    v[Ptr10 + 4806] = -1
		    // "ObjA"
		    v[204] -= 1
		    // "###############Draw_newPicture"
		    v[314] = Ptr10 + 4700
		    @if `v[Ptr10 + 4701] == -3 {
			v[441] = 188
			v[442] = 1
			v[443] = 305
			v[444] = 306
			v[445] = 1
			v[448] = 1
			v[453..454] = 0
			v[457] = 0
			v[458] = 1
			v[459] = 0 //1
			v[460] = 0//320
			v[461..462] = 0
			v[465] = 1
			v[466] = 321
			v[467] = 0
			v[470] = 113
			v[447] = 0
			v[449..451] = 82
			v[452] = 75
			v[449..452] = 0
			v[463] = 5
			v[464] = 1
			v[321] = 1
			// "Z "
			v[455] = 0
			@if `v[Ptr10 + 4826] & 4096 {
			    v[315] = !v[Ptr10 + 4844] * 4096 | 8192
			    v[312] = -18
			    
			} .else bl {
			    v[315] = !v[Ptr10 + 4844] * 4096
			    v[312] = 0
			    
			}
			v[Ptr10 + 4979] = 0
			@if s[314] .isOff() {
			    @if s[220] .isOn() {
				@if v[331] == 3 {
				    @if `v[Ptr10 + 4950] != -1 {
					@if `(v[315] & 4096) > 0 {
					    @if `(v[315] & 8192) > 0 {
						v[Ptr10 + 4982] = -24
						v[Ptr10 + 4981] = 16
						v[Ptr10 + 4979] = rnd(-720000, -600000)
						
					    } .else bl {
						v[Ptr10 + 4982] = -4
						v[Ptr10 + 4981] = 16
						v[Ptr10 + 4979] = rnd(600000, 720000)
						
					    }
					    
					} .else bl {
					    @if `(v[315] & 8192) > 0 {
						v[Ptr10 + 4982] = -24
						v[Ptr10 + 4981] = -16
						v[Ptr10 + 4979] = rnd(600000, 720000)
						
					    } .else bl {
						v[Ptr10 + 4982] = -4
						v[Ptr10 + 4981] = -16
						v[Ptr10 + 4979] = rnd(-720000, -600000)
						
					    }
					    
					}
					@if `v[Ptr10 + 4738] & 2 {
					    v[Ptr10 + 4982] -= 28
					    
					}
					
				    } .else bl {
					v[Ptr10 + 4979] = 0
					v[Ptr10 + 4982] = 0
					v[Ptr10 + 4981] = 0
					
				    }
				    
				}
				
			    } .else bl {
				v[Ptr10 + 4979] = 0
				v[Ptr10 + 4982] = 0
				v[Ptr10 + 4981] = 0
				
			    }
			    
			}
			//Set using Cache Flag
			v[v[300]*300+4825] |= 512

			// "Get ID From Cache"
			v[188] = (v[300] - 1) * Const_layer_amount + v[1201]
			v[341] = v[v[314] + 290]
			// "Count Picture Layer Array"
			v[899] = v[Ptr10 + 4999]
			v[345] = v[899]
			@if v[899] != 0 {
			    @while v[345] > 0 .dst v[346] {
				v[345] /= 10
				
			    }
			    
			    v[346] += 1
			    
			}
			// "remove drawn sprites once"
			@if `s[v[300] + 500] == 1 {
			    // "safety"
			    @if v[341] > 0 {
				@loop v[346] .dst v[342] {
				    v[342] += v[341]
				    // "Safety"
				    @pic[v[342]].erase
				    
				}
				
				
			    }
			    v[188] = v[341]
			    
			} .else bl {
			    // "safety"
			    @if v[188] > 0 {
				@loop 6 .dst v[342] {
				    v[342] += v[188]
				    // "Safety"
				    @pic[v[342]].erase
				    
				}
				
				
			    }
			    
			}
			@if v[188] >= 1 {
			    v[178] = v[188]
			    // "#get damaged variation"
			    //v[604] = v[Ptr10 + 4704]
			    //v[0] = v[343..352] = [v[604] % 10, v[604] / 10 % 10, v[604] / 100 % 10]
			    v[468] = 3
			    v[187] = 0
			    v[379] = 0
			    v[378] = 0
			    v[669] = v[Ptr10 + 4769]
			    v[664] = v[Ptr10 + 4764]
			    v[4101..4110] = v[463]
			    v[725] = Ptr10 
			    v[725] += 4825
			    v[726] = Ptr10 
			    v[726] += 4826
			    v[4121..4130] = 1
			    /*v[4121] = [1, 2][(v[v[725]] & 1)]
			    v[4101] = v[v[726]] & 512 ? 7 : 5*/
			    
			    v[4106] = v[v[726]] & 16777216 ? 7 : 5// horse
			    v[4111..4120] = v[321] 
			    v[4115] = 2

			    //SEEMS Maniacs Patch itself has bug <- no you just ignored your cache system - which will be obsolete
	    		    fuction_drawing_set_grid()
			    //Head damaged check
			    //v[4112] += (v[v[726]] & 98304) == 32768 ? Const_head_spr_grid_damaged:0


			    //so temporary head setting - use legacy damaged head sprite 
			    v[335] =  (v[300]-1)*10
			    v[335] = Const_str_agent_pictures_strings_start+v[335]
				
			    //set damaged head
			    @if `(v[v[726]] & 98304) == 32768{
				v[4102]=5
				v[4122]=1
				var1 = v[335]+2
				t[var1].exMatch ("[0-9]{1,}",t[501],var2)
				t[var1].asg "parts\bodyset\set\damaged\spr_damaged_head_"
				t[var1].cat t[501]
				//var2 = 2
			    	//function_set_agent_picture(v[300] var1 var2)//this was needless
			    }

			    v[339] = -1
			    @if `v[v[726]] & 134217728 {
				v[4034] = 0
				v[4124] = 2
				v[4114] += v[455] / 4096 * v[4104]
				
			    }



			    @while v[899] >= 1 .dst v[340] {
				v[341] = v[899] % 10
				//v[286] = 900 + v[341] + 10 * v[v[341] + 342]
				v[286] = v[341] + v[335]
				v[463] = v[4100 + v[341]]
				v[464] = v[4120 + v[341]]
				v[321] = v[4110 + v[341]]
				// "#########################Layer own Setting"
				// "Found Head" 
				@if `v[341] == 2 || v[v[725]] & 524288 && v[341] == 3 {
				    v[378] |= 2
				    //If damaged head found-> then check the damaged grid
				    // "Save Head Pic ID"
				    v[379] = v[188]
				    
				}
				v[891] = v[314] + 291
				//v[341] = (v[341] - 1) % 6
				// "#Decapitated!"
				@if `v[v[314] + 288] > 0 && (v[v[314] + 126] & 32) == 32 && between(v[341], 1, 2) {
				    v[0] = v[305..306] = [v[311] + v[v[314] + 283] / 10000, v[312] + v[v[314] + 284] / 10000]
				    v[0] = v[453..456] = [3, v[v[314] + 289], v[455], 10000]
				    
				} .else bl {
				    v[311].copy v[305], 2
				    v[0] = v[453..456] = [0, 0, v[455], 0]
				    
				}
				// "Layer own Setting END#########################"
				//v[320] = v[(v[300] - 1) * 6 + v[341] + v[1185]]
				// "Strings = t[v[286]]"
				@cmd 11110, t[v[286]], .args v[441], 30
				// "When you found helmet AND already Loaded Head Part, then"
				@if `(v[341] == 3||v[341] == 9) && v[378] & 2 {
				    @if `v[v[725]] & 524288 {
					@pic[v[188]].getInfo .cewh .baseRect v[360], v[360], v[355], v[356]
					@pic[v[188]].getInfo .pixel 0, 0, v[355], v[356] .dst 550445
					
				    } .else bl {
					@pic[v[188]].setId .move 2599, 1
					@pic[2599].getInfo .cewh .baseRect v[360], v[360], v[355], v[356]
					@pic[2599].getInfo .pixel 0, 0, v[355], v[356] .dst 550445
					
				    }
				    // "V4  #0, 1= center"
				    v[11] = v[379]
				    v[12] = 0
				    v[13] = 0
				    @pic[v[11]].getInfo .cewh .baseRect v[360], v[360], v[19], v[20]
				    v[19..20] /= 2
				    v[18] = 550445
				    @loop v[356] .dst v[15] {
					@loop v[355] .dst v[16] {
					    v[17] = v[v[18]]
					    @if `(v[17] & 0xFF000000) == 0xFF000000 {
						v[358] = v[12] + v[16]
						v[358] -= v[355] / 2
						v[359] = v[13] + v[15]
						v[359] -= v[356] / 2
						v[358] .add v[19], 2
						@pic[v[11]].setPixel .xywh v[358], v[359], 1, 1 .src v[17]
						
					    }
					    v[18] += 1
					    
					}
					
					
				    }
				    
				    @if s[212] .isOn() {
					@if v[372] == 0 {
					    @if v[190] == 1 {
						// "#Arrow"
						@if v[422] == 1 {
						    t[501] .asg "stamp\wound_1"
						    v[11] = v[379]
						    v[12] = 4 + rnd(-1, 3)
						    v[13] = 5 + rnd(-3, 1)
						    v[14] = 1
						    func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						    
						}
						// "#Bolt"
						@if v[422] == 2 {
						    t[501] .asg "stamp\wound_2"
						    v[11] = v[379]
						    v[12] = 4 + rnd(-1, 3)
						    v[13] = 5 + rnd(-3, 1)
						    v[14] = 1
						    func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						    
						}
						@if v[422] == 3 {
						    t[501] .asg "stamp\wound_3"
						    v[11] = v[188]
						    v[11] = v[379]
						    v[12] = 4 + rnd(-1, 3)
						    v[13] = 4 + rnd(-3, 1)
						    v[14] = 1
						    func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						    
						}
						
					    }
					    
					} .else bl {
					    
					}
					
				    }
				    @if `!(v[v[725]] & 524288) {
					// "save helm pos"
					v[339] = v[340]
					// "don't spend pic cache"
					v[186..188] -= 1
					@pic[2599].erase
					
				    } .else bl {
					v[339] = 0
					
				    }
				    
				}
				// "######STAMP######"
				// "#######Armor"
				@if v[341] == 1 { //0
				    // "#######Greenskins"
				    @if `between(v[664], 1, 2) {
					@if `(v[378] & 2) == 0 {
					    t[501] .asg "stamp\extradeadbody_1"
					    v[11] = v[188]
					    v[12] = -4
					    v[13] = 12
					    v[14] = 1
					    func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
					    
					}
					
				    } .else bl {
					@if v[664] == 5 {
					    @if `(v[378] & 2) == 0 {
						t[501] .asg "stamp\extradeadbody_2"
						v[11] = v[188]
						v[12] = -4
						v[13] = 12
						v[14] = 1
						func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						
					    }
					    
					} .else bl {
					    
					}
					@if v[664] == 6 {
					    @if `(v[378] & 2) == 0 {
						t[501] .asg "stamp\extradeadbody_3"
						v[11] = v[188]
						v[12] = -4
						v[13] = 12
						v[14] = 1
						func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						
					    }
					    
					} .else bl {
					    
					}
					
				    }
				    @if v[372] == 0 {
					// "#######Cut"
					@if v[190] == 0 {
					    // "#######Melee Normal"
					    @if v[422] == 0 {
						@if v[371] == 0 {
						    t[501] .asg "stamp\cut"
						    v[11] = v[188]
						    v[12] = 12 + rnd(-1, 1)
						    v[13] = 24 + rnd(0, 1)
						    v[14] = 0
						    func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						    
						}
						
					    }
					    
					}
					// "#######P"
					@if v[190] == 1 {
					    // "#######Melee Normal"
					    @if v[422] == 0 {
						t[501] .asg "stamp\stabbed"
						v[11] = v[188]
						v[12] = 12 + rnd(-1, 1)
						v[13] = 24 + rnd(-1, 1)
						v[14] = 0
						func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						@if s[212] .isOn() {
						    t[501] .asg "stamp\guts"
						    v[11] = v[188]
						    v[12] = 12 + rnd(-1, 1)
						    v[13] = 24 + rnd(-1, 1)
						    v[14] = 0
						    func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						    
						}
						
					    }
					    @if s[212] .isOff() {
						// "#Arrow"
						@if v[422] == 1 {
						    t[501] .asg "stamp\wound_1"
						    v[11] = v[188]
						    v[12] = 13 + rnd(-2, 2)
						    v[13] = 20 + rnd(-1, 1)
						    v[14] = 0
						    func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						    
						} .else bl {
						    // "#Bolt"
						    @if v[422] == 2 {
							t[501] .asg "stamp\wound_2"
							v[11] = v[188]
							v[12] = 13 + rnd(-2, 2)
							v[13] = 20 + rnd(-1, 1)
							v[14] = 0
							func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
							
						    } .else bl {
							@if v[422] == 3 {
							    t[501] .asg "stamp\wound_3"
							    v[11] = v[188]
							    v[12] = 13 + rnd(-2, 2)
							    v[13] = 19 + rnd(-1, 1)
							    v[14] = 0
							    func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
							    
							}
							
						    }
						    
						}
						
					    }
					    
					}
					
				    } .else bl {
					
				    }
				    
				} .else bl {
				    // "#######Head"
				    @if v[341] == 2 { //341
					@if s[1] .isOn() {
					    @if v[190] == 1 {
						// "#######Melee Normal"
						@if v[422] == 0 {
						    t[501] .asg "stamp\stabbed"
						    v[11] = v[188]
						    v[12] = 4 + rnd(-1, 2)
						    v[13] = 8 + rnd(-2, 2)
						    v[14] = 1
						    func_stamp_picture_on_pic_id(t[501] v[11] v[12] v[13] v[14])
						    
						}
						
					    }
					    
					}
					
				    }
				    
				}
				v[186..188] += 1
				v[899] /= 10
				
			    }
			    
			    
			}
			// "#####################"
			@if `(v[315] & 4096) > 0 {
			    @if `(v[315] & 8192) > 0 {
				@loop v[187] .dst v[341] {
				    v[341] += v[178]
				    @pic[v[341]].move {
					.relative
					.pos 0, 0 .center
					.scale 0
					.trans 0
					.time 0
					.keepRgbs
					.keepEffect
					.vrev 
				    }
				    
				}
				
				
			    } .else bl {
				@loop v[187] .dst v[341] {
				    v[341] += v[178]
				    @pic[v[341]].move {
					.relative
					.pos 0, 0 .center
					.scale 0
					.trans 0
					.time 0
					.keepRgbs
					.keepEffect
					.hrev 
				    }
				    
				}
				
				
			    }
			    
			} .else bl {
			    @if `(v[315] & 8192) > 0 {
				@loop v[187] .dst v[341] {
				    v[341] += v[178]
				    @pic[v[341]].move {
					.relative
					.pos 0, 0 .center
					.scale 0
					.trans 0
					.time 0
					.keepRgbs
					.keepEffect
					.hrev .vrev 
				    }
				    
				}
				
				
			    } .else bl {
				@loop v[187] .dst v[341] {
				    v[341] += v[178]
				    @pic[v[341]].move {
					.relative
					.pos 0, 0 .center
					.scale 0
					.trans 0
					.time 0
					.keepRgbs
					.keepEffect
				    }
				    
				}
				
				
			    }
			    
			}
			// "Weapons fall"
			v[341] = v[315]
			v[315] = v[314] + 261
			v[1301].copy v[v[315]], 18
			// "WP XY"
			v[0] = v[v[315]..v[315] + 1] = [rnd(-36000, 36000), v[Ptr10 + 4711] * -12000 + rnd(-50000, -20000)]
			v[v[315] + 2] = rnd(-4, 4) * 2250
			v[v[315] + 3] = rnd(2, 5) * -450
			@if `(v[341] & 4096) > 0 {
			    @if `(v[341] & 8192) > 0 {
				v[v[315] + 6] = -1350000
				
			    } .else bl {
				v[v[315] + 6] = 450000
				
			    }
			    v[v[315] + 7] = rnd(10000, 50000)
			    
			} .else bl {
			    @if `(v[341] & 8192) > 0 {
				v[v[315] + 6] = 1350000
				
			    } .else bl {
				v[v[315] + 6] = -450000
				
			    }
			    v[v[315] + 7] = rnd(-50000, -10000)
			    
			}
			v[v[315] + 6] += rnd(-180000, 180000)
			v[v[315] + 5] = rnd(14, 18)
			@if `v[v[826]] & 16777216 {
			    v[v[315] + 5] += rnd(3, 5)
			    
			}
			// "Sh XY"
			v[315] = v[314] + 269
			v[0] = v[v[315]..v[315] + 1] = [rnd(-28000, 28000), v[Ptr10 + 4711] * -9500 + rnd(-13000, 0)]
			v[v[315] + 2] = rnd(-3, 3) * rnd(1900, 2250)
			v[v[315] + 3] = rnd(0, 2) * -250
			v[v[315] + 5] = rnd(11, 14)
			@if `v[v[826]] & 16777216 {
			    v[v[315] + 5] += rnd(3, 5)
			    
			}
			v[v[315] + 6] = v[342] = rnd(120000, 350000) * [-1, 1][rnd(0, 1)]
			@if v[342] >= 0 {
			    v[v[315] + 7] = rnd(30000, 50000)
			    
			} .else bl {
			    v[v[315] + 7] = rnd(-50000, -30000)
			    
			}
			v[v[315] + 7] = rnd(-60000, 60000)
			// "###############Helm found"
			@if v[339] >= 1 {
			    v[899] = v[Ptr10 + 4999]
			    v[341] = pow(10, v[339])
			    v[Ptr10 + 4999] = v[899] / v[341] / 10 * v[341] + v[899] % v[341]
			    
			}
			
		    }
		    @if `v[Ptr10 + 4701] == -4 {
			// "Weapons fall"
			v[315] = v[314] + 261
			v[1301].copy v[v[315]], 19
			// "WP XY"
			v[0] = v[v[315]..v[315] + 1] = [rnd(-36000, 36000), v[Ptr10 + 4711] * -12000 + rnd(-15000, 0)]
			v[v[315] + 2] = rnd(-4, 4) * 2250
			v[v[315] + 3] = rnd(1, 4) * -300
			v[v[315] + 6] = rnd(450000, 800000) * [-1, 1][rnd(0, 1)]
			v[v[315] + 6] += rnd(-180000, 180000)
			v[v[315] + 7] = rnd(-50000, 50000)
			v[v[315] + 5] = rnd(14, 19)
			// "Sh XY"
			v[315] = v[314] + 269
			v[0] = v[v[315]..v[315] + 1] = [rnd(-28000, 28000), v[Ptr10 + 4711] * -9500 + rnd(-13000, 0)]
			v[v[315] + 2] = rnd(-3, 3) * rnd(1900, 2250)
			v[v[315] + 3] = rnd(0, 2) * 250
			v[v[315] + 5] = rnd(11, 14)
			v[v[315] + 6] = rnd(-1800000, 1800000)
			v[v[315] + 7] = rnd(-60000, 60000)
			
		    }
		    @if s[117] .isOn() {
			@call .cev 84
			
		    }
		    @if s[319] .isOn() {
			// "Bogatyr"
			@if `v[v[299] * 300 + 4801] == 130 {
			    v[822] = v[Ptr10 + 4922]
			    @if v[822] == 12 {
				// "＃＃＃＃＃＃＃＃＃＃＃＃"
				v[229] = 29
				s[240].on
				// "＃＃＃＃＃＃＃＃＃＃＃＃"
				
			    }
			    
			}
			@if `v[v[299] * 300 + 4801] == 142 {
			    v[822] = v[Ptr10 + 4922]
			    @if v[822] == 12 {
				// "＃＃＃＃＃＃＃＃＃＃＃＃"
				v[229] = 30
				s[240].on
				// "＃＃＃＃＃＃＃＃＃＃＃＃"
				
			    }
			    
			}
			@if v[190] == 4 {
			    @if `v[Ptr10 + 4801] == 157 {
				// "＃＃＃＃＃＃＃＃＃＃＃＃"
				v[229] = 22
				s[240].on
				// "＃＃＃＃＃＃＃＃＃＃＃＃"
				
			    }
			    
			}
			
		    }
		    
		}
		
	    }
	    
	}
}

//Retreat
cev .id(30) .name("BattleSystemFunc:Retreat"){

	// "Access19 = AttackerObjectID	Access20 = TargetObjectID	Access18 = ObjTypeチェックPtr	var1=Is_fatality	誤作動防止"
	//Ptr10 = Ptr20*300
	@if v[300] > 0 {
	    // "309 = ID	306 = ActionState"
	    // "-1を死体とする"
	    // "ObjIDを死体に変える"
	    v[v[298]] = 0
	    // "ActionStateを死体に変える"
	    v[306] += 4943
	    v[v[306]] = 0
	    Ptr10 = v[300] * 300
	    v[311] = Ptr10 + 4707
	    v[305] = v[v[311]]
	    v[v[311]].copy v[305], 2
	    // "GEt Morton Space"
	    v[609] = v[311] + 2
	    // "移動"
	    v[Ptr10 + 4806] = -1
	    // "FleePop"
	    v[341] = Ptr10 
	    v[341] += 4707
	    v[305].copy v[607], 2
	    v[371] = between(v[607], v[1008], v[1009]) && between(v[608], v[1010], v[1011]) ? 1 : 0
	    @if v[371] >= 1 {
		@loop v[1017] .dst v[320] {
		    v[242] %= v[1017]
		    v[301] = v[242] * 100
		    v[301] = v[301] + v[1018]
		    @if v[v[301]] <= 1 {
			v[242] %= v[1017]
			v[281] = v[242] * 100
			v[281] = v[281] + v[1018]
			// "まず清掃"
			v[1301].copy v[v[301]], 100
			// "ポインタセット開始"
			v[310] = v[242] + 801
			v[295] = v[301] + 99
			// "設定"
			v[v[301]] = 1
			v[v[295]] = 0
			// "普通にアニメ"
			v[607].copy v[361], 2
			@pic[v[310]].strpic {
			    "RETREAT!"
			    .pos v[361], v[362] .center
			    .size 0, 0                    .scrollWithMap
			    .chromakey 1
			    .scale 100
			    .trans v[1066]
			    .rgbs 100, 100, 100, 100
			    .font "misaki_gothic_2nd", 10
			    .spacing 0, 0
			    .skin "" .nobg .noframe .noGradation .noPadding
			    .mapLayer 7
			    .eraseWhenTransfer
			    .affectedByFlash
			    .affectedByShake
			}
			v[362] -= 48
			@pic[v[310]].move {
			    .pos v[361], v[362] .center
			    .scale 100
			    .trans 100
			    .time 20
			    .rgbs 100, 100, 100, 100
			}
			// "仕上げに登録消す"
			v[242..242] += 1
			s[141].off
			@break
			
		    }
		    v[242] += 1
		    
		}
		
		
	    }
	    // "＃＃＃＃＃＃＃＃＃"
	    v[320] = v[311] + 94
	    v[320] = v[v[320]]
	    v[321] = 1
	    v[700] = 4800 + v[308]
	    // "＃＃＃＃＃＃＃＃＃"
	    // "Team Get"
	    @if s[313] .isOn() {
		@call .cev 1924
		v[341] = 2
		v[342] = [10, 5, 8, 1][v[v[700]]]
		v[330] = v[4562] + v[300]
		@pic[v[1155]].strpic {
		    t[20305]
		    .pos v[341], v[1126] .bottomLeft
		    .size 0, 0            .chromakey 1
		    .scale 100
		    .trans 30
		    .rgbs 100, 100, 100, 100
		    .font t[530], v[4511]
		    .spacing 0, 4
		    .skin "" .nobg .noframe .noPadding
		    .mapLayer 8
		    .eraseWhenTransfer
		    .affectedByFlash
		    .affectedByShake
		}
		@call .cev 1925
		
	    }
	    // "Remove from UnitList"
	    v[11] = v[300]
	    v[12] = v[Ptr10 + 4701]
	    @call .cev 1896
	    // "Team Get	!TEAM LIST!"
	    v[700] = Ptr10 
	    v[700] += 4800
	    v[308] = v[v[700]] % 3
	    // "NOT  neutral"
	    @if v[308] != 2 {
		v[310] = v[v[308] + 205]
		v[309] = v[1145 + v[308]]
		v[310] += v[309]
		@while v[309] <= v[310] {
		    v[311] = (v[309] + v[310])
		    v[311] /= 2
		    @if v[v[311]] == v[300] {
			v[v[311]] = 0
			@break
			
		    } .else bl {
			@if v[v[311]] < v[300] {
			    v[310] = v[311] - 1
			    
			} .else bl {
			    v[309] = v[311] + 1
			    
			}
			
		    }
		    
		}
		
		v[309] = v[1145 + v[308]]
		v[v[309]].sortDescending v[1012]
		v[v[1259] + (v[v[700] + 1] - 1) * 4 + 3 + v[v[700] - 42] * v[1260] * 4] += 1
		v[343] = v[298] + 101
		// "Coｌなし施設はカウントされてないので引かない"
		@if v[308] == 0 {
		    v[205] -= v[v[343]] != 104 && v[v[343]] != 105 ? 1 : 0
		    
		} .else bl {
		    v[206] -= v[v[343]] != 104 && v[v[343]] != 105 ? 1 : 0
		    
		}
		
	    }
	    // "Collision Counter"
	    v[196] -= v[Ptr10 + 4739] != -1 ? 1 : 0
	    // "ObjA"
	    v[204] -= 1
	    
	}

}
