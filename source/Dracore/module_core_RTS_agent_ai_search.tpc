def Const_AgentMetaTeam_beginMINUSONE = Const_AgentMetaTeam_begin -1 
__fn debug_selecting_agt $agtidptr $block {
	__if DIS_DEBUG_BUILD == 1 {
		@if v[$agtidptr] == v[101] {
			$block
		}
	}
}

v[4599] = 0
v[535] += 1
v[533] = (v[204] / 52 + 1) * v[1134]
v[535] %= v[533]
v[536] = v[4532]

v[4031] = v[1146]
v[4032..4033] = v[1145]
v[4034] = v[206]
v[4035..4036] = v[205]
//Check ground type troops agents all

// set expanding temp array for copying
v[4100..4112] = 100000000
// WITHOUT AEAB, above part is necessarily


@while v[v[536]] != 0 {
<<<<<<< HEAD
    v[211] = v[v[536]] - 1
    v[212] = v[211] * 300 
    v[212] += 5000
    v[v[212]].copy v[600], 301
    //Check agent timer to run search AI
    @if `(v[900] + v[535]) % v[533] == 0 {//9.5.23
        v[v[212] + 3] &= -134217729//~134217728
	//If worker AI flag is on
        @if `v[603] & 2097152 {//9.5.23
            @if `v[603] & 8388608 {//9.5.23
                @if `!(v[634] & 4096) {//9.5.23
                    s[280].on
                    v[v[212] + 34] |= 16384
                    
                }
                
            }
            
        } .else bl {
            @if `v[603] & 1048576 {//9.5.23
                v[634] = v[212] + 34
                @if `v[v[634]] & 2097152 {
                    v[v[634]] &= -2097153//~2097152
                    
                } .else bl {
                    v[307] = v[v[634]]
                    v[300] = v[212] + 18
                    v[299] = v[212] + 241
		    //get team ID
                    v[301] = v[212] + 100
		    //team ID % 3
		    //opt 28.4.23
		    //v[314] = v[Const_AgentMetaTeam_begin+v[211]] //v[v[301]] % 3
		    v[314] = Const_AgentMetaTeam_begin+v[211]
		    v[314] = v[v[314]]
                    v[309] = v[212] + 7
                    //v[308] = v[4034 + v[314]]
		    v[308] = 4034 + v[314]
		    v[308] = v[v[308]]
                    //v[302] = v[4031 + v[314]]
		    v[302] = 4031 + v[314]
		    v[302] = v[v[302]]
                    v[4001..4030] = 100000000
                    s[205].off
                    @if `v[307] & 1 {
                        v[4001..4029] += 700000000
                        v[4011] -= 750000000
                        s[205].on
                        
                    }
                    @if `v[307] & 2 {
                        v[4002] -= 50000000
                        s[205].on
                        
                    }
                    @if `v[307] & 4 {
                        v[4005] -= 50000000
                        s[205].on
                        
                    }
                    v[307] = 0
                    v[3401..3600] = 999999999
                    v[534] = v[4579] + (v[1012] + 2) * v[211]
                    v[v[534]] = 0
		    //v[308] = v[212] + 230 9.5.23
                    v[308] = v[830]
                    //@comment "##############"
		    v[315] = v[211] + v[4806]
                    v[315] = v[v[315]]

		    //If the agent has target agent  
                    @if v[v[300]] >= 1 {
			//then halve search radius
                        v[315] /= 2
			//If it's in melee combat, 
                        @if v[681] >= 1 {
			    //AND melee unit
                            @if v[703] == 0 {//9.5.23
				//then halve search radius once more
                                v[315] /= 2 //9.5.23
                                
                            }
                            
                        }
                        
                    }
                    /*@comment "#########################
		    #2002 Crd->Mort V1V2 reg1
		    ##########################"*/
                    v[v[309]].copy v[341], 2
                    v[341..342] -= v[315]
                    v[341] .add v[53], 2
                    v[341] .sub v[76], 2
                    v[341] .div v[74], 2
                    v[341] = max(v[341], 0)
                    v[342] = max(v[342], 0)
                    /*@comment "TT1=MortX
		   TT2=MortY
		   ビット演算して処理するよ"*/
                    v[341] = (v[341] | v[341] << 8) & 0xFF00FF
                    v[341] = (v[341] | v[341] << 4) & 0xF0F0F0F
                    v[341] = (v[341] | v[341] << 2) & 0x33333333
                    v[341] = (v[341] | v[341] << 1) & 0x55555555
                    v[342] = (v[342] | v[342] << 8) & 0xFF00FF
                    v[342] = (v[342] | v[342] << 4) & 0xF0F0F0F
                    v[342] = (v[342] | v[342] << 2) & 0x33333333
                    v[342] = ((v[342] | v[342] << 1) & 0x55555555)<<1
                    //@comment "yは1bitシフトで終わり"
                    //v[342] <<= 1
                    //@comment "最後にTT1 OR TT2"
		    //opt 28.4.23
                    //v[21] = v[341] | v[342]
                    /*@comment "#########################
		   #2002 Crd->Mort V1V2 reg1 end
		   ##########################"*/
                    v[351] = v[341] | v[342]
                    /*@comment "#########################
#2002 Crd->Mort V1V2 reg1
##########################"*/
                    v[v[309]].copy v[341], 2
                    v[341..342] += v[315]
                    v[341] .add v[53], 2
                    v[341] .sub v[76], 2
                    v[341] .div v[74], 2
                    v[341] = min(v[341], 31)
                    v[342] = min(v[342], 31)
                    /*@comment "TT1=MortX
		    TT2=MortY
	 	    ビット演算して処理するよ"*/
                    v[341] = (v[341] | v[341] << 8) & 0xFF00FF
                    v[341] = (v[341] | v[341] << 4) & 0xF0F0F0F
                    v[341] = (v[341] | v[341] << 2) & 0x33333333
                    v[341] = (v[341] | v[341] << 1) & 0x55555555
                    v[342] = (v[342] | v[342] << 8) & 0xFF00FF
                    v[342] = (v[342] | v[342] << 4) & 0xF0F0F0F
                    v[342] = (v[342] | v[342] << 2) & 0x33333333
                    v[342] = ((v[342] | v[342] << 1) & 0x55555555)<<1
                    //@comment "yは1bitシフトで終わり"
                    //v[342] <<= 1
                    //@comment "最後にTT1 OR TT2"

		    //opt 28.4.23
                    //v[21] = v[341] | v[342]
		    v[342] = v[341] | v[342]
                    v[341] = v[351]
                    //v[342] = v[21]
                    /*@comment "TT1 = upper left morton
			TT2 = bottom right morton
			TT5 = shift num"*/
                    v[343] = v[341] ^ v[342]
                    //@comment "#mask with 11000000"
                    //@comment "#mask with 110000"
                    //@comment "#mask with 001100"
                    //@comment "#mask with 000011"

		    //If going to check the morton root space
                    @if `v[343] & 768 {
			//then just check team list - but this seemingly not good design, so maybe change this later
                        v[306] = 3601
                        @if s[205] .isOn() {
                            @doWhile v[v[302]] != 0 {
                                v[v[309]].copy v[304], 2
                                //optimizing 25.4.23
				//v[301] = v[v[302]] * 300 + 4707
				v[301] = v[v[302]] * 300 
				v[301] += 4707
                                v[304] .sub v[v[301]], 2
                                v[304] .mul v[304], 2
                                v[v[306]] = v[304] + v[305] + v[v[v[302]] * 300 + 4976]
                                @if v[v[306]] < v[308] {
                                    v[v[534] + v[307]] = v[v[306]] * 1000 + v[v[302]] + v[4001 + min(v[v[301] + 95], 29)]
                                    v[306..307] += 1
                                    
                                }
                                v[302] += 1
                                
                            }
                            
                            
                        } .else bl {
                            @doWhile v[v[302]] != 0 {
                                v[v[309]].copy v[304], 2
                                //optimizing 25.4.23
				//v[301] = v[v[302]] * 300 + 4707
				v[301] = v[v[302]] * 300 
				v[301] += 4707
                                v[304] .sub v[v[301]], 2
                                v[304] .mul v[304], 2
                                v[v[306]] = v[304] + v[305] + v[v[v[302]] * 300 + 4976]
                                @if v[v[306]] < v[308] {
                                    v[v[534] + v[307]] = v[v[306]] * 1000 + v[v[302]]
                                    v[306..307] += 1
                                    
                                }
                                v[302] += 1
                                
                            }
                            
                            
                        }
                        
                    } .else bl {
                        //@comment "#TT6 = morton id"
			//Isn't this formula retarded? 8.Mar
                        v[345] = v[343] & 192 ? 8 : v[343] & 48 ? 6 : v[343] & 12 ? 4 : v[343] & 3 ? 2 : 0
                        v[346] = v[342] >> v[345]
                        //@comment "#mask end"
                        v[340] = v[4546 - v[345] / 2] + v[346] * v[1004]
                        v[327] = v[v[4552 - v[345] / 2] + v[346]]
                        v[700] = [1, 0, -2][(v[314])] /*v[v[301]] % 3*/
                        v[306] = 3601
                        @loop v[327] .dst v[310] {
                            v[312] = v[340] + v[310]
                            @if `v[700] == v[Const_AgentMetaTeam_begin+v[v[312]]-1] { //v[v[v[312]] * v[1117] + 4800] % 3 {
                                v[311] = v[v[312]] * v[1117] 
				v[311] += 4700
                                v[v[309]].copy v[304], 2
                                v[301] = v[311] + 7
                                v[304] .sub v[v[301]], 2
                                v[304] .mul v[304], 2
                                v[v[306]] = v[304] + v[305] + v[v[311] + 276]
                                @if v[v[306]] < v[308] {
                                    v[v[534] + v[307]] = v[v[306]] * 1000 + v[v[312]] + v[4001 + min(v[v[301] + 95], 29)]
                                    v[306..307] += 1
                                    
                                }
                                
                            }
                            
                        }
                        
                        
                    }

		    //Has upper than 16 enemies in the search radius
                    @if v[307] >= 16 {
			//set next search skip flag 
                        v[v[634]] |= v[v[212] + 103] == 0 ? 2097152 : 0
                        //break the flag
			v[v[634]] &= -129//~128
                        
                    } .else bl {
			//found none in the radius
                        @if v[307] == 0 {
				//If the agent has target agent initially
				@if v[v[300]] > 0 {
				    //If the unit has cohort order flag
				    @if `v[v[634]] & 128 {
					//if the target is set by cohort order, then sight radius is 2.5 times bigger - if an agent have a target already, its sight radius is halved - see above. 
					v[308] *= 5
					
				    }
					//Try checking if current target is in sight radius  
					v[311] = v[v[300]] * v[1117] 
					v[311] += 4700
					v[v[309]].copy v[304], 2
					v[301] = v[311] + 7
					v[304] .sub v[v[301]], 2
					v[304] .mul v[304], 2
					v[v[306]] = v[304] + v[305] + v[v[311] + 276]
					@if v[v[306]] < v[308] {
					    //and if it's in the agent's sight, let it keep following to the target.
					    v[v[534] + v[307]] = v[v[306]] * 1000 + v[v[300]] //+ v[4001 + min(v[v[301] + 95], 29)] this part is needless, cuz the agent has no other possible target
					    v[306..307] += 1
					    
					}.else bl{
						//If the target is out of agent sight, then break cohort order flag and wait new cohort order
						v[v[634]] &= -129//~128
=======
		v[212] = v[v[536]] * 300 
		val_add(v[212],N4700) // v[212] += 4700
		v[v[212]].copy v[600], 301
		//Check agent timer to run search AI
		@if `(v[900] + v[535]) % v[533] == 0 { //9.5.23
			v[211] = v[v[536]] - 1
				AgentIDholder = v[v[536]] 
				v[v[212] + 3] &= -134217729//~134217728

				//If worker AI flag is on
				@if `agent_AgentBits & AgentBits_FLAG_EnableCivAI {
						@if `agent_AgentBits & AgentBits_FLAG_walldetected {
								@if `!(agent_AI_routine_bits & AI_routine_bits_FLAG_tracing_flag) {
										s[280].on
										TT1 = v[212] + 34
										v[TT1] |= AI_routine_bits_FLAG_PATHFINDING
										
								}
								
						}
						
				} .else bl {
						@if `agent_AgentBits & AgentBits_FLAG_EnableBasicAI { //9.5.23
								agent_AI_routine_bits = v[212] + 34
								@if `v[agent_AI_routine_bits] & AI_routine_bits_FLAG_AIskip {
										v[agent_AI_routine_bits] &= -2097153 //~2097152
										
								} .else bl {
									Ptr20 = v[212] + 18
									v[299] = v[212] + 241
									//get team ID
									// Temp1 = v[212] + 100

									//team ID % 3
									__if DIS_EXPERIMENTAL == -1 {
										//macro_get_agent_MetaTeam_into_var(v[v[536]],Temp14)
														get_AEAB_element_wo_ptr(AgentIDholder,__id(Temp14),AgentExBuffer_SLOT_MetaTeam)
									}.else bl {
										Temp14 = Const_AgentMetaTeam_begin + v[211]
										Temp14.deref Temp14,1 // Temp14 = v[Temp14]
									}

									// Temp8 = v[4034 + Temp14]
									Temp8 = 4034 + Temp14
									Temp8.deref Temp8,1

									__if DIS_EXPERIMENTAL == -1 { // use AEBA to opt! also @if cond can be changed into other shit.
											get_AEAB_array(AgentIDholder,4001,AgentExBuffer_SLOT_Class_Target_Priority_Array,ClassType_Amount)

									}.else bl {

									agent_AI_routine_bits.deref Temp7,1 // Temp7 = v[agent_AI_routine_bits]
									v[4101].copy v[4001],12

								// Common_Switch5 serves checking if the agent has bias to prioritize the enemy by its type, if it's on, it means the agent has the bias
									LEGS_Common_Switch5.off
									@if `Temp7 & 1 {
											v[4001..4012] += 900000000
											v[4012] -= 950000000 // wut
											LEGS_Common_Switch5.on
											
									}
									@if `Temp7 & 2 {
											v[4002] -= 50000000
											LEGS_Common_Switch5.on
											
									}
									@if `Temp7 & 4 {
											v[4005] -= 50000000
											LEGS_Common_Switch5.on
											
									}
							}

										Temp7 = 0
										// set ptr to array for comparation of agents
										v[534] = v[4579] + (v[1012] + 2) * v[211]
										v[v[534]] = 0

										agent_UnitEyeSight_for_AgentSearch.copy Temp8,1

										// get sight range root
										defv UnitAI_agent_eyesight = 315
										__if DIS_EXPERIMENTAL == -1 { // use AEBA to opt! also @if cond can be changed into other shit.

											get_AEAB_element_wo_ptr(AgentIDholder,__id(UnitAI_agent_eyesight),AgentExBuffer_SLOT_BaseSight_Root)

										}.else bl {

											UnitAI_agent_eyesight = v[211] + v[4806]
											UnitAI_agent_eyesight.deref UnitAI_agent_eyesight,1
										}

										//If the agent has target agent
										//Temp16 = Temp15  
										@if v[Ptr20] >= 1 {
												//then halve search radius
												UnitAI_agent_eyesight >>= 1 // UnitAI_agent_eyesight /= 2
											//If it's in melee combat, 
												@if agent_MeleeFightTimer >= 1 {
														//AND melee unit
														UnitAI_agent_eyesight >>= agent_AAType == 0 ? 1 : 0

												}
												
										}


										UnitAI_agent_eyesight.copy v[316],1 // UnitAI_agent_eyesight is v[315]
										debug_selecting_agt(v[536],{
											agent_RelativeX.copy TT1, 2
											TT1 .sub UnitAI_agent_eyesight,2 // v[341..342] -= UnitAI_agent_eyesight
											TT1 .add v[53], 2
											agent_RelativeX.copy TT3,2
											TT3 .add UnitAI_agent_eyesight,2 // v[341..342] -= UnitAI_agent_eyesight
											TT3 .add v[53], 2
											TT3 -= TT1
											TT4 -= TT2
											@pic[10].strpic {
												"CHECK"
												.pos TT1, TT2 .topLeft
												.size TT3, TT4                        .chromakey 1
												.scale 100
												.trans 80
												.rgbs 100, 100, 100, 100
												.font Font_Common, Font_Common_size
												.spacing 0, 4
												.skin ""  .noPadding
												.mapLayer 8
												.eraseWhenTransfer
												.affectedByFlash
												.affectedByShake
										}

										})

										/*@comment "#########################		    #2002 Crd->Mort V1V2 reg1		    ##########################"*/
										agent_RelativeX.copy TT1, 2
										TT1 .sub UnitAI_agent_eyesight,2 // v[341..342] -= UnitAI_agent_eyesight
										TT1 .add v[53], 2
										TT1 .sub v[76], 2
										TT1 .div v[74], 2
										TT1 &= 31 // TT1 = max(TT1, 31)
										TT2 &= 31 // TT2 = max(TT2, 31)

										/*@comment "TT1=MortX
			 TT2=MortY
			 ビット演算して処理するよ"*/
										TT1 = (TT1 | TT1 << 8) & 0xFF00FF
										TT1 = (TT1 | TT1 << 4) & 0xF0F0F0F
										TT1 = (TT1 | TT1 << 2) & 0x33333333
										TT1 = (TT1 | TT1 << 1) & 0x55555555
										TT2 = (TT2 | TT2 << 8) & 0xFF00FF
										TT2 = (TT2 | TT2 << 4) & 0xF0F0F0F
										TT2 = (TT2 | TT2 << 2) & 0x33333333
										TT2 = ((TT2 | TT2 << 1) & 0x55555555)<<1

										//@comment "yは1bitシフトで終わり"
										//TT2 <<= 1
										//@comment "最後にTT1 OR TT2"
										//opt 28.4.23
										//v[21] = TT1 | TT2
										/*@comment "#########################		   #2002 Crd->Mort V1V2 reg1 end		   ##########################"*/
										v[351] = TT1 | TT2

										/*@comment "##########################2002 Crd->Mort V1V2 reg1##########################"*/
										agent_RelativeX.copy TT1, 2
										TT1 .add UnitAI_agent_eyesight,2 // v[341..342] += UnitAI_agent_eyesight
										TT1 .add v[53], 2
										TT1 .sub v[76], 2
										TT1 .div v[74], 2
										TT1 &= 31 // TT1 = min(TT1, 31)
										TT2 &= 31 // TT2 = min(TT2, 31)

										/*@comment "TT1=MortX
									TT2=MortY
									ビット演算して処理するよ"*/
										TT1 = (TT1 | TT1 << 8) & 0xFF00FF
										TT1 = (TT1 | TT1 << 4) & 0xF0F0F0F
										TT1 = (TT1 | TT1 << 2) & 0x33333333
										TT1 = (TT1 | TT1 << 1) & 0x55555555
										TT2 = (TT2 | TT2 << 8) & 0xFF00FF
										TT2 = (TT2 | TT2 << 4) & 0xF0F0F0F
										TT2 = (TT2 | TT2 << 2) & 0x33333333
										TT2 = ((TT2 | TT2 << 1) & 0x55555555) << 1
										//@comment "yは1bitシフトで終わり"
										//TT2 <<= 1
										//@comment "最後にTT1 OR TT2"

				//opt 28.4.23
										//v[21] = TT1 | TT2
										TT2 = TT1 | TT2
										val_asg(TT1,v[351]) // TT1 = v[351]
										//TT2 = v[21]
										/*
										@comment "TT1 = upper left morton
										TT2 = bottom right morton
										TT5 = shift num"
										*/

										TT3 = TT1 ^ TT2

										//If the morton space where you're gonna check is the root space...
										@if `TT3 & 768 {

											Temp2 = 4031 + Temp14
											Temp2.deref Temp2,1 // Temp2 = v[Temp2]

											//then just check team agent list - but this seemingly not good design (also kinda buggy), so maybe I need to change this later
											Temp6 = 3601

											//@if `v[agent_AI_routine_bits] & 7 { // EXPERIMENTAL
											@doWhile v[Temp2] != 0 {

													Temp1 = v[Temp2] * 300 
													val_add(Temp1,N4700) // Temp1 += 4700
													calc_victim_distance_and_camo_to_Temp4(Temp1)

													@if Temp4 < Temp8 {
														ptr_asg(Temp6,Temp4) // set the value to v[Temp6]

														// debug 
														debug_selecting_agt(v[536],{
																func_devlog(__str("Hit. target is \v[\v[",__id(AISearch_morton_ptr),"]] "," I checked teamlist"))
														})

														// set TT2 = v[534] + Temp7
														val_asg(TT2,v[534])
														val_add(TT2,Temp7)
														@if LEGS_Common_Switch5 .isOn() {
															v[TT2] = v[Temp6] * 1000 + v[Temp2] + v[4001 + min(victim_UnitType, ClassType_Amount)]

														}.else bl{
															v[TT2] = v[Temp6] * 1000
															v[TT2].add v[Temp2],1 // v[TT1] += v[Temp2]

														}
														Temp6.add N1,2 // v[306..307] += 1
														
													}

													increment_var(Temp2) // Temp2 += 1
													
											}
											
											

										} .else bl {

											//@comment "#TT6 = morton id"
											//Isn't this formula retarded? 8.Mar
											TT5 = TT3 & 192 ? 8 : TT3 & 48 ? 6 : TT3 & 12 ? 4 : TT3 & 3 ? 2 : 0
											TT6 = TT2 >> TT5
											//@comment "#mask end"

											TT5 >>= 1 // TT5 /= 2
											defv AISearch_morton_ptr = __id(Temp12)
											AISearch_morton_ptr = v[4546 - TT5] + TT6 * v[1004] // morton agent list head
											v[327] = v[v[4552 - TT5] + TT6] // morton agent list length
											Temp33 = [1, 0, -2][Temp14]
											Temp6 = 3601

											// deb
											debug_selecting_agt(v[536],{
													func_devlog(__str("Current selected agent is gonna search morton dim:\v[",__id(TT3), "], for \v[327] Times."))
											})

											@loop v[327] {
												// AISearch_morton_ptr = v[340] + Temp10
												// val_add(AISearch_morton_ptr,v[340])

												__if DIS_EXPERIMENTAL == -1 {
													macro_get_agent_MetaTeam_into_var(v[AISearch_morton_ptr],TT1) // AEBA

												}.else bl {
													TT1 = Const_AgentMetaTeam_beginMINUSONE + v[AISearch_morton_ptr]

												}

												// @if  agent_TeamID == TT1 { // EXPERIMENTAL - IF YOU USE AEBA  
												@if  Temp33 == v[TT1] { // NOT EXPERIMENTAL - WITHOUT AEBA

													Temp1 = v[AISearch_morton_ptr] * v[1117] 
													val_add(Temp1,N4700) // Temp1 += 4700
													calc_victim_distance_and_camo_to_Temp4(Temp1)

													@if Temp4 < Temp8 { // in agent sight
														ptr_asg(Temp6,Temp4) // set the value to v[Temp6]
														
														// debug 
														debug_selecting_agt(v[536],{
																func_devlog(__str("Hit. found target is \v[\v[",__id(AISearch_morton_ptr),"]] "))
																func_devlog("mydim is \v[609] - current morton list address is \v[", __id(AISearch_morton_ptr),"]")
														})

														// set TT2 = v[534] + Temp7
														val_asg(TT2,v[534])
														val_add(TT2,Temp7)
														v[TT2] = v[Temp6] * 1000 + v[AISearch_morton_ptr] + v[4001 + min(victim_UnitType, 11)]

														Temp6.add N1,2 // v[306..307] += 1
														
													}
												}
												increment_var(AISearch_morton_ptr)
											}
										}

										//Has more than 16 enemies in the search radius
										@if Temp7 >= 16 {
											//set next search skip flag 
											v[agent_AI_routine_bits] |= agent_AAType == 0 ? AI_routine_bits_FLAG_AIskip : 0 //v[v[212] + 103] == 0 ? 2097152 : 0
											//break the flag
											v[agent_AI_routine_bits] &= -129 //~128
											
										} .else bl {
											//found none in the radius
											@if Temp7 == 0 {
												agent_AI_check_current_target()
													
											} .else bl {
												//break the flag
												v[agent_AI_routine_bits] &= -129//~128
													
											}
											
										}
										v[v[534]].sort Temp7
										@if `agent_AgentBits & AgentBits_FLAG_walldetected {
											agent_MapX.copy Temp11,2
											v[621].copy Temp3,2
											@if Temp4 < -30 {
												v[312] -= 1
												
											} .else bl {
												@if Temp4 > 30 {
													v[312] += 1
													
												}
												
											}

											@if Temp3 > 30 {
												Temp11 += 1
													
											} .else bl {
												@if Temp3 < -30 {
													Temp11 -= 1
													
												}
												
											}

											// checking tile terrain information
											v[286] = v[4529] + Temp11 - v[69] + (v[312] - v[70]) * v[2061]

											@if v[v[286]] > 0 {
												@if `v[v[286]] / 10000 % 10 == 1 { // if there's agent assigned

														Temp2 = v[v[286]] / 100000 // pick it up
														Temp1 = Temp2 * 300 
														val_add(Temp1,N4701) // Temp1 += 4701

														@if v[Temp1] == 11 {
															v[agent_AI_routine_bits] &= -193 // ~192//(64 + 128)

															@if `v[Temp1 + 99] != agent_TeamID {
																@if `v[agent_AI_routine_bits] & AI_routine_bits_FLAG_Pathblocked { // v[v[212] + 34] & 8388608 {
																		v[v[534]] = Temp2

																		def AIFLAG_SkipAndPF = AI_routine_bits_FLAG_AIskip + AI_routine_bits_FLAG_PATHFINDING
																		v[agent_AI_routine_bits] |= AIFLAG_SkipAndPF // 2097152+16384
																		val_add(Temp7,N1) // Temp7 += 1
																		
																} .else bl {
																		@if `v[agent_AI_routine_bits] & 1 { // v[v[212] + 34] & 1 
																				v[agent_StanceOrder] = 2
																				v[v[534]] = Temp2
																				v[agent_AI_routine_bits] |= AI_routine_bits_FLAG_AIskip
																				val_add(Temp7,N1) // Temp7 += 1
																				v[v[212] + 3] |= 37748736 // 33554432 + 4194304 ~ AgentBits_FLAG_PF_walldetection_switch + AgentBits_FLAG_ForcemoveFlag
																				
																		} .else bl {
																				//@comment "stuck"
																				@if agent_AAType == 0 { // melee
																						TT1 = agent_TeamID != 0 ? rnd(0, 99) : 100
																						@if TT1 <= 30 { // target stucked wall
																								v[v[534]] = Temp2
																								v[v[212] + 34] |= AI_routine_bits_FLAG_AIskip
																								val_add(Temp7,N1) // Temp7 += 1
																								
																						} .else bl {
																								v[agent_AI_routine_bits] |= AgentBits_FLAG_PF_walldetection_switch + AI_routine_bits_FLAG_PATHFINDING
																							
																						}
																						
																				} .else bl {
																						v[v[212] + 3] |= AgentBits_FLAG_PF_walldetection_switch
																						v[agent_AI_routine_bits] |= AI_routine_bits_FLAG_PATHFINDING
																						
																				}
																				
																		}
																		
																}
																
															} .else bl {
																v[v[212] + 3] |= AgentBits_FLAG_PF_walldetection_switch
																v[agent_AI_routine_bits] |= AI_routine_bits_FLAG_PATHFINDING
																
															}
															
														}
														
												} .else bl {
													@if `!(v[agent_AI_routine_bits] & AI_routine_bits_FLAG_tracing_flag) {
														v[v[212] + 3] |= AgentBits_FLAG_PF_walldetection_switch
														v[agent_AI_routine_bits] |= AI_routine_bits_FLAG_PATHFINDING
														
													}
													
												}
												
											} .else bl { 
												def KILL_AI_routine_bits_FLAG_tracing_flag = ~AI_routine_bits_FLAG_tracing_flag
												v[agent_AI_routine_bits] &= KILL_AI_routine_bits_FLAG_tracing_flag //-4097//~4096
											
											}
											
										}
										@if v[v[534]] < 999999999 {
											v[v[534]..v[534] + Temp7 - 1] %= 1000
											v[Ptr20] = v[v[534]]
											def KILL_AI_routine_bits_FLAG_IdleAfterEnemySearch = ~AI_routine_bits_FLAG_IdleAfterEnemySearch
											v[agent_AI_routine_bits] &= KILL_AI_routine_bits_FLAG_IdleAfterEnemySearch //-65//~64

											// debug 
											debug_selecting_agt(v[536],{
													func_devlog(__str("I finally decided to chase \v[\v[",__id(Ptr20),"]]"))
											})
								
										} .else bl {
											Temp7 = 0
											
										}

										Temp6 = 0
										TT1 = v[534] + v[1012]
										Temp6.copy v[TT1], 2

										@if v[Ptr20] == 0 {
												v[agent_AI_routine_bits] |= AI_routine_bits_FLAG_IdleAfterEnemySearch

												@if agent_StanceOrder == 3 { //`v[v[212] + 241] == 3 {
														@if agent_MovementOrder != -2 { //`v[v[212] + 242] != -2 {
																@if agent_MilPixMoveOrderedPointDist > 11000 { //`v[v[212] + 23] > 11000 {
																		v[v[212] + 245] = 0
																		
																}
																
														}
														
												}

												// If agent has not been in combat for a long time
												@if agent_InCombatTimer <= -5000 { //`v[v[212] + 80] <= -5000 {
														v[agent_AI_routine_bits] |= AI_routine_bits_FLAG_AIskip // reduce enemy search frequency
														
												}
												
										}
										
								}
								
						}
						
				}
				
		}
		increment_var(v[536]) // v[536] += 1
		
}

// These processes missing comments, so idk wtf is going lmao
@if s[2] .isOff() {

		//ACTION TIMER MANAGEMENT AND SO ON
		v[536] = v[4532]
		@while v[v[536]] != 0 {

			Ptr1 = v[v[536]] * 300
			val_add(Ptr1,N4701) // Ptr1 += 4701
			v[Ptr1].copy agent_AgentType,300

			@if agent_ActionTimer <= 0 {
				agent_ActionTimer = v[1195] //init ActionTimer

				@if `agent_AgentBits & AgentBits_FLAG_EnableCivAI { //peasant
					agent_Morale = agent_InCombatTimer > 0 && !(agent_BaseObjBit & BaseObjBit_FLAG_Immune_to_bleed) ? 3 : 0
					//finish?

				}.else bl {
					@if `agent_AgentBits & AgentBits_FLAG_EnableBasicAI { //mil units
						@if agent_TargetAgentID == 0 { // have no target
							@if agent_MovementOrder < MovementOrder_TYPE_prioritize_moving { // and can go for his enemy agent...
								
								// then
								// try to pick from own list 
								v[211] = v[v[536]] - 1
								v[534] = v[4579] + (v[1012] + 2) * v[211]
								//pointer offset
								v[297] = v[534] + v[1012]
								//get obj amount in the list
								Temp2 = v[v[297] + 1] - v[v[297]]
								v[296] = v[534] + v[v[297]]
								v[371] = 0
								@loop Temp2 {
										TT1 = v[v[296]] * 300 
										val_add(TT1,N4701) // TT1 += 4701
										@if v[TT1] > 0  {
											agent_TargetAgentID = v[v[296]]
											val_asg(v[371],N1) // v[371] = 1
											@break
											
										}
										v[v[297]] += 1
										increment_var(v[296]) // v[296] += 1
										
								}
								
								agent_TargetAgentID = v[371] == 0 ? 0 : agent_TargetAgentID

							}
						}

					}

				}
				agent_AgentType.copy v[Ptr1],300
			}
			increment_var(v[536]) // v[536] += 1
						
		}


		//STATIC AI
		v[536] = v[4533]
		v[4031] = v[1146]
		v[4032..4033] = v[1145]
		v[4034] = v[206]
		v[4035..4036] = v[205]

		@while v[v[536]] != 0 {
				v[211] = v[v[536]] - 1
				v[212] = v[211] * 300 
				val_add(v[212],N5000) // v[212] += 5000
				v[v[212]].copy Address_agent_array_head,agent_Basic_Array_size

				@if agent_ActionTimer <= 0 {
						TT1 = v[212] + 84 // temp agent_ActionTimer ptr
						v[TT1] = v[1195] * 2

						@if `agent_StaticBits & 1048576 {
							Ptr20 = v[212] + 18
							v[299] = v[212] + 241 // ?
							Temp1 = v[212] + 100

							__if DIS_EXPERIMENTAL == -1 {
								macro_get_agent_MetaTeam_into_var(v[v[536]],Temp14) // AEBA
							}.else bl {
								Temp14 = Const_AgentMetaTeam_begin + v[211]
								Temp14.deref Temp14,1
							}

							// a naru.
							Temp2 = 4031 + Temp14
							Temp2.deref Temp2,1
							Temp2.copy Temp7,1 // Temp7 = Temp2
							Temp8 = 4034 + Temp14
							// Temp8 = v[4034 + Temp14]
							Temp8.deref Temp8,1


							v[534] = v[4579] + (v[1012] + 2) * v[211]
							v[v[534]] = 0

							Temp6 = 3601 // deploy v[3601] 'n check it
							Temp7 = 0
							@doWhile v[Temp2] != 0 {
									Temp1 = v[Temp2] * 300 
									val_add(Temp1,N4700) // Temp1 += 4700
									calc_victim_distance_and_camo_to_Temp4(Temp1)
									@if Temp4 < agent_UnitEyeSight_for_AgentSearch { // kore teki huesugitara bagurun to tyauw
											ptr_asg(Temp6,Temp4) // set the value to v[Temp6]
											TT1 = v[534] + Temp7
											v[TT1] = v[Temp6] * 1000 
											v[TT1].add v[Temp2],1
											Temp6.add N1,2
											
									}
									increment_var(Temp2) // Temp2 += 1
									
							}
							
							v[v[534]].sort Temp7
							v[Ptr20] = v[v[534]] < 999999999 ? v[v[534]] % 1000 : 0
							
						}
				}
				
				@if `agent_StaticBits & 32768 {
					@if agent_static_ReserveAmount <= 0 {
						// auto queue checker
						@call .cev 1748
						var1 = v[v[536]]
						@call .cev 1747
						var1 = v[212] + 213
						var1.deref var1,1
						@if var1 >= 1 {
								@call .cev 1730
								@call .cev 1748
								
						} .else bl {
								v[v[212] + 3] &= -32769//~32768
								
						}
						
>>>>>>> 88b5194136650670640ef002a8086e2b5f7f7357
					}
					
				}
				increment_var(v[536]) // v[536] += 1

				
<<<<<<< HEAD
                            
                        } .else bl {
                            v[v[634]] &= -129//~128
                            
                        }
                        
                    }
                    v[v[534]].sort v[307]
                    @if `v[v[212] + 3] & 8388608 {
                        v[342] = v[212] + 26
                        v[v[342]].copy v[311], 2
                        v[342] = v[212] + 21
                        v[v[342]].copy v[303], 2
                        @if v[304] < -30 {
                            v[312] -= 1
                            
                        } .else bl {
                            @if v[304] > 30 {
                                v[312] += 1
                                
                            }
                            
                        }
                        @if v[303] > 30 {
                            v[311] += 1
                            
                        } .else bl {
                            @if v[303] < -30 {
                                v[311] -= 1
                                
                            }
                            
                        }
                        v[286] = v[4529] + v[311] - v[69] + (v[312] - v[70]) * v[2061]
                        @if v[v[286]] > 0 {
                            @if `v[v[286]] / 10000 % 10 == 1 {
                                v[302] = v[v[286]] / 100000
                                v[301] = v[302] * 300 
				v[301] += 4701
                                @if v[v[301]] == 11 {
                                    v[v[634]] &= -193//~192//(64 + 128)
                                    @if `v[v[301] + 99] != v[v[212] + 100] {
                                        @if `v[v[212] + 34] & 8388608 {
                                            v[v[534]] = v[302]
                                            v[v[634]] |= 2113536//2097152+16384
                                            v[307] += 1
                                            
                                        } .else bl {
                                            @if `v[v[212] + 34] & 1 {
                                                v[v[841]] = 2
                                                v[v[534]] = v[302]
                                                v[v[634]] |= 2097152
                                                v[307] += 1
                                                v[v[212] + 3] |= 37748736//33554432 + 4194304
                                                
                                            } .else bl {
                                                //@comment "stuck"
                                                @if `v[v[212] + 103] == 0 {
                                                    v[341] = v[v[212] + 100] != 0 ? rnd(0, 99) : 100
                                                    @if v[341] <= 20 {
                                                        v[v[534]] = v[302]
                                                        v[v[212] + 34] |= 2097152
                                                        v[307] += 1
                                                        
                                                    } .else bl {
                                                        v[v[212] + 3] |= 33554432
                                                        v[v[634]] |= 16384
                                                        
                                                    }
                                                    
                                                } .else bl {
                                                    v[v[212] + 3] |= 33554432
                                                    v[v[634]] |= 16384
                                                    
                                                }
                                                
                                            }
                                            
                                        }
                                        
                                    } .else bl {
                                        v[v[212] + 3] |= 33554432
                                        v[v[634]] |= 16384
                                        
                                    }
                                    
                                }
                                
                            } .else bl {
                                @if `!(v[v[212] + 34] & 4096) {
                                    v[v[212] + 3] |= 33554432
                                    v[v[634]] |= 16384
                                    
                                }
                                
                            }
                            
                        } .else bl {
                            v[v[634]] &= -4097//~4096
                            
                        }
                        
                    }
                    @if v[v[534]] < 999999999 {
                        v[v[534]..v[534] + v[307] - 1] %= 1000
                        v[v[300]] = v[v[534]]
                        v[v[634]] &= -65//~64
                        
                    } .else bl {
                        v[307] = 0
                        
                    }
                    v[306] = 0
                    v[341] = v[534] + v[1012]
                    v[306].copy v[v[341]], 2
                    @if v[v[300]] == 0 {
                        v[v[634]] |= 64
                        @if `v[v[212] + 241] == 3 {
                            @if `v[v[212] + 242] != -2 {
                                @if `v[v[212] + 23] > 11000 {
                                    v[v[212] + 245] = 0
                                    
                                }
                                
                            }
                            
                        }
                        @if `v[v[212] + 80] <= -5000 {
                            v[v[634]] |= 2097152
                            
                        }
                        
                    }
                    
                }
                
            }
            
        }
        
    }
    v[536] += 1
    
}

//These processes missing comments and idk wtf doing lmao
@if s[2] .isOff() {
    v[536] = v[4532]
    @while v[v[536]] != 0 {
        v[683] = v[v[536]] * 300 
	v[683] += 4784
        @if v[v[683]] <= 0 {
            v[211] = v[v[536]] - 1
            v[v[683]] = v[1195]
            v[212] = v[211] * 300 
	    v[212] += 5000
            @if `v[v[212] + 3] & 2097152 {
                v[v[212] + 260] = v[v[212] + 80] > 0 && !(v[v[212] + 140] & 4096) ? 3 : 0
                
            } .else bl {
                @if `v[v[212] + 3] & 1048576 {
                    v[300] = v[212] + 18
                    //Have no target then
                    @if v[v[300]] == 0 {
                        //try to pick from own list 
                        v[534] = v[4579] + (v[1012] + 2) * v[211]
                        //pointer offset
                        v[297] = v[534] + v[1012]
                        //get obj amount in the list
                        v[302] = v[v[534] + v[1012] + 1] - v[v[297]]
                        v[296] = v[534] + v[v[297]]
                        v[371] = 0
                        @loop v[302] {
                            @if `0 < v[v[v[296]] * 300 + 4701] {
                                v[v[300]] = v[v[296]]
                                v[371] = 1
                                @break
                                
                            }
                            v[v[297]] += 1
                            v[296] += 1
                            
                        }
                        
                        @if v[371] == 0 {
                            v[v[300]] = 0
                            
                        }
                        
                    }
                    
                }
                
            }
            
        }
        v[536] += 1
        
    }
    //STATIC AI
    v[536] = v[4533]
    v[0] = v[4031..4033] = [v[1146], v[1145], v[1145]]
    v[0] = v[4034..4036] = [v[206], v[205], v[205]]
    @while v[v[536]] != 0 {
        v[683] = v[v[536]] * 300 
	v[683] += 4784
        v[211] = v[v[536]] - 1
        v[212] = v[211] * 300 
	v[212] += 5000
        @if `v[v[683]] <= 0 {
            v[v[683]] = v[1195] * 2
            @if `v[v[212] + 3] & 1048576 {
                v[300] = v[212] + 18
                v[299] = v[212] + 241
                v[301] = v[212] + 100
		v[314] = v[Const_AgentMetaTeam_begin+v[211]] //v[v[301]] % 3
                v[302] = v[4031 + v[314]] //v[v[301]] % 3
                v[307] = v[302]
                v[309] = v[212] + 7
                v[308] = v[4034 + v[314]] //v[v[301]] % 3
                v[4001..4030] = 0
                v[307] = 0
                v[308] = v[v[212] + 230]
                v[3401..3600] = 999999999
                @doWhile v[v[302]] != 0 {
                    v[306] = v[307] + 3601
                    v[301] = v[v[302]] * 300 
		    v[301] += 4701
                    v[350] = v[v[301]]
                    v[301] += 6
                    v[v[309]].copy v[304], 2
                    v[304] .sub v[v[301]], 2
                    v[304] .mul v[304], 2
                    v[v[306]] = v[304] + v[305] + v[v[v[302]] * 300 + 4976]
                    @if v[v[306]] < v[308] {
                        v[341] = 3401 + v[307]
                        v[v[341]] = v[v[306]] * 1000 + v[v[302]]
                        v[307] += 1
                        
                    }
                    v[302] += 1
                    
                }
                
                v[3401].sort v[307]
                v[v[300]] = v[3401] < 999999999 ? v[3401] % 1000 : 0
                
            }
            
        }
        @if `v[v[212] + 3] & 32768 {
            v[301] = v[212] + 170
            @if v[v[301]] <= 0 {
                @call .cev 1748
                v[11] = v[v[536]]
                @call .cev 1747
		v[11] = v[212]+213
                v[11] = v[v[11]]
                @if v[11] >= 1 {
                    @call .cev 1730
                    @call .cev 1748
                    
                } .else bl {
                    v[v[212] + 3] &= -32769//~32768
                    
                }
                
            }
            
        }
        v[536] += 1
        
    }
    
    
=======
		}
		
		
}



__fn agent_AI_check_current_target {
	//If the agent has target agent initially
	@if v[Ptr20] > 0 {
			//If the unit has cohort order flag

			//if the target is set by cohort order, then agent's sight radius is considered 2 times bigger than actual in this process. Besides if the agent has a target already, the sight radius gets halved..
			Temp8 <<= v[agent_AI_routine_bits] & AI_routine_bits_FLAG_AICohortGatheringAttack ? 1 : 0

			//Try checking if current target is in sight radius  
			Temp1 = v[Ptr20] * v[1117] 
			val_add(Temp1,N4700) // Temp11 += 4700
			calc_victim_distance_and_camo_to_Temp4(Temp1)

			@if Temp4 < Temp8 {
				//and if it's in the agent's sight, let it keep following to the target.
				ptr_asg(Temp6,Temp4) // set the value to v[Temp6]
				TT1 = v[534] + Temp7
				v[TT1] = v[Temp6] * 1000
				v[TT1].add v[Ptr20],1 // v[TT1] += v[Ptr20] 
				Temp6.add N1,2 // v[306..307] += 1

				// debug 
				debug_selecting_agt(v[536],{
						func_devlog(__str("Agent decided to keep chasing current target: \v[\v[",__id(Ptr20),"]] "))
				})
				
			}.else bl{
				//If the target is out of agent sight, then break cohort order flag and wait new cohort order
				v[agent_AI_routine_bits] &= -129//~128
			}
			
	}
>>>>>>> 88b5194136650670640ef002a8086e2b5f7f7357
}

__fn calc_victim_distance_and_camo_to_Temp4 $ptrToHead {
	v[$ptrToHead].copy address_victim_buffer_head, agent_Basic_Array_size
	agent_RelativeX.copy Temp4, 2
	Temp4 .sub victim_RelativeX, 2
	Temp4 .mul Temp4, 2
	val_add(Temp4,Temp5)
	val_add(Temp4,victim_ProcessCamoValue)
}

