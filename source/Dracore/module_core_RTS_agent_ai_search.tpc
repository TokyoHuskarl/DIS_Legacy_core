def Const_AgentMetaTeam_beginMINUSONE = Const_AgentMetaTeam_begin -1 

v[4599] = 0
v[535] += 1
v[533] = (v[204] / 52 + 1) * v[1134]
v[535] %= v[533]
v[536] = v[4532]
//v[0] = v[4031..4033] = [v[1146], v[1145], v[1145]]
v[4031] = v[1146]
v[4032..4033] = v[1145]
//v[0] = v[4034..4036] = [v[206], v[205], v[205]]
v[4034] = v[206]
v[4035..4036] = v[205]
//Check ground type troops agents all

// set expanding temp array for copying
v[4101..4130] = 100000000

@while v[v[536]] != 0 {
    v[211] = v[v[536]] - 1
    v[212] = v[211] * 300 
    v[212] += 5000
    v[v[212]].copy v[600], 301
    //Check agent timer to run search AI
    @if `(v[900] + v[535]) % v[533] == 0 {//9.5.23
        v[v[212] + 3] &= -134217729//~134217728
	//If worker AI flag is on
        @if `v[603] & 2097152 {//9.5.23
            @if `v[603] & 8388608 {//9.5.23
                @if `!(v[634] & 4096) {//9.5.23
                    s[280].on
                    v[v[212] + 34] |= 16384
                    
                }
                
            }
            
        } .else bl {
            @if `v[603] & 1048576 {//9.5.23
                v[634] = v[212] + 34
                @if `v[v[634]] & 2097152 {
                    v[v[634]] &= -2097153//~2097152
                    
                } .else bl {
                    v[307] = v[v[634]]
                    v[300] = v[212] + 18
                    v[299] = v[212] + 241
		    //get team ID
                    v[301] = v[212] + 100
		    //team ID % 3
		    //opt 28.4.23
		    //v[314] = v[Const_AgentMetaTeam_begin+v[211]] //v[v[301]] % 3
		    __if DIS_EXPERIMENTAL == 1 {
		    	macro_get_agent_MetaTeam_into_var(v[v[536]],v[314])
		    }.else bl {
		    	v[314] = Const_AgentMetaTeam_begin+v[211]
		    	v[314] = v[v[314]]
		    }
                    v[309] = v[212] + 7
                    //v[308] = v[4034 + v[314]]
		    v[308] = 4034 + v[314]
		    v[308] = v[v[308]]
                    //v[302] = v[4031 + v[314]]
		    v[302] = 4031 + v[314]
		    v[302] = v[v[302]]

                    //v[4001..4030] = 100000000
		    v[4101].copy v[4001],30

                    LEGS_Common_Switch5.off
                    @if `v[307] & 1 {
                        v[4001..4029] += 700000000
                        v[4011] -= 750000000
                        LEGS_Common_Switch5.on
                        
                    }
                    @if `v[307] & 2 {
                        v[4002] -= 50000000
                        LEGS_Common_Switch5.on
                        
                    }
                    @if `v[307] & 4 {
                        v[4005] -= 50000000
                        LEGS_Common_Switch5.on
                        
                    }
                    v[307] = 0
                    //v[3401..3600] = 999999999
		    v[3401] = 999999999
		    v[3401].copy v[3402], 199
                    v[534] = v[4579] + (v[1012] + 2) * v[211]
                    v[v[534]] = 0
		    //v[308] = v[212] + 230 9.5.23
                    v[308] = v[830]
                    //@comment "##############"
		    v[315] = v[211] + v[4806]
                    v[315] = v[v[315]]

		    //If the agent has target agent  
                    @if v[v[300]] >= 1 {
			//then halve search radius
                        v[315] /= 2
			//If it's in melee combat, 
                        @if v[681] >= 1 {
			    //AND melee unit
                            @if v[703] == 0 {//9.5.23
				//then halve search radius once more
                                v[315] /= 2 //9.5.23
                                
                            }
                            
                        }
                        
                    }
                    /*@comment "#########################
		    #2002 Crd->Mort V1V2 reg1
		    ##########################"*/
                    v[v[309]].copy TT1, 2
                    v[341..342] -= v[315]
                    TT1 .add v[53], 2
                    TT1 .sub v[76], 2
                    TT1 .div v[74], 2
                    TT1 = max(TT1, 0)
                    TT2 = max(TT2, 0)
                    /*@comment "TT1=MortX
		   TT2=MortY
		   ビット演算して処理するよ"*/
                    TT1 = (TT1 | TT1 << 8) & 0xFF00FF
                    TT1 = (TT1 | TT1 << 4) & 0xF0F0F0F
                    TT1 = (TT1 | TT1 << 2) & 0x33333333
                    TT1 = (TT1 | TT1 << 1) & 0x55555555
                    TT2 = (TT2 | TT2 << 8) & 0xFF00FF
                    TT2 = (TT2 | TT2 << 4) & 0xF0F0F0F
                    TT2 = (TT2 | TT2 << 2) & 0x33333333
                    TT2 = ((TT2 | TT2 << 1) & 0x55555555)<<1
                    //@comment "yは1bitシフトで終わり"
                    //TT2 <<= 1
                    //@comment "最後にTT1 OR TT2"
		    //opt 28.4.23
                    //v[21] = TT1 | TT2
                    /*@comment "#########################
		   #2002 Crd->Mort V1V2 reg1 end
		   ##########################"*/
                    v[351] = TT1 | TT2
                    /*@comment "#########################
#2002 Crd->Mort V1V2 reg1
##########################"*/
                    v[v[309]].copy TT1, 2
                    v[341..342] += v[315]
                    TT1 .add v[53], 2
                    TT1 .sub v[76], 2
                    TT1 .div v[74], 2
                    TT1 = min(TT1, 31)
                    TT2 = min(TT2, 31)
                    /*@comment "TT1=MortX
		    TT2=MortY
	 	    ビット演算して処理するよ"*/
                    TT1 = (TT1 | TT1 << 8) & 0xFF00FF
                    TT1 = (TT1 | TT1 << 4) & 0xF0F0F0F
                    TT1 = (TT1 | TT1 << 2) & 0x33333333
                    TT1 = (TT1 | TT1 << 1) & 0x55555555
                    TT2 = (TT2 | TT2 << 8) & 0xFF00FF
                    TT2 = (TT2 | TT2 << 4) & 0xF0F0F0F
                    TT2 = (TT2 | TT2 << 2) & 0x33333333
                    TT2 = ((TT2 | TT2 << 1) & 0x55555555)<<1
                    //@comment "yは1bitシフトで終わり"
                    //TT2 <<= 1
                    //@comment "最後にTT1 OR TT2"

		    //opt 28.4.23
                    //v[21] = TT1 | TT2
		    TT2 = TT1 | TT2
                    TT1 = v[351]
                    //TT2 = v[21]
                    /*@comment "TT1 = upper left morton
			TT2 = bottom right morton
			TT5 = shift num"*/
                    v[343] = TT1 ^ TT2
                    //@comment "#mask with 11000000"
                    //@comment "#mask with 110000"
                    //@comment "#mask with 001100"
                    //@comment "#mask with 000011"

		    //If going to check the morton root space
                    @if `v[343] & 768 {
			//then just check team list - but this seemingly not good design, so maybe change this later
                        v[306] = 3601
                        @if LEGS_Common_Switch5 .isOn() {
                            @doWhile v[v[302]] != 0 {
                                v[v[309]].copy v[304], 2
                                //optimizing 25.4.23
				//v[301] = v[v[302]] * 300 + 4707
				v[301] = v[v[302]] * 300 
				v[301] += 4707
                                v[304] .sub v[v[301]], 2
                                v[304] .mul v[304], 2
                                v[v[306]] = v[304] + v[305] + v[v[v[302]] * 300 + 4976]
                                @if v[v[306]] < v[308] {
                                    v[v[534] + v[307]] = v[v[306]] * 1000 + v[v[302]] + v[4001 + min(v[v[301] + 95], 29)]
                                    v[306..307] += 1
                                    
                                }
                                v[302] += 1
                                
                            }
                            
                            
                        } .else bl {
                            @doWhile v[v[302]] != 0 {
                                v[v[309]].copy v[304], 2
                                //optimizing 25.4.23
				//v[301] = v[v[302]] * 300 + 4707
				v[301] = v[v[302]] * 300 
				v[301] += 4707
                                v[304] .sub v[v[301]], 2
                                v[304] .mul v[304], 2
                                v[v[306]] = v[304] + v[305] + v[v[v[302]] * 300 + 4976]
                                @if v[v[306]] < v[308] {
                                    v[v[534] + v[307]] = v[v[306]] * 1000 + v[v[302]]
                                    v[306..307] += 1
                                    
                                }
                                v[302] += 1
                                
                            }
                            
                            
                        }
                        
                    } .else bl {
                        //@comment "#TT6 = morton id"
			//Isn't this formula retarded? 8.Mar
                        v[345] = v[343] & 192 ? 8 : v[343] & 48 ? 6 : v[343] & 12 ? 4 : v[343] & 3 ? 2 : 0
                        v[346] = TT2 >> v[345]
                        //@comment "#mask end"
                        v[340] = v[4546 - v[345] / 2] + v[346] * v[1004]
                        v[327] = v[v[4552 - v[345] / 2] + v[346]]
                        v[700] = [1, 0, -2][(v[314])] /*v[v[301]] % 3*/
                        v[306] = 3601
                        @loop v[327] .dst v[310] {
                            v[312] = v[340] + v[310]


			    __if DIS_EXPERIMENTAL == 1 { 
				    macro_get_agent_MetaTeam_into_var(v[v[312]],TT1)
			    }.else bl {
				    TT1 = Const_AgentMetaTeam_beginMINUSONE+v[v[312]]
			    }

                            @if  v[700] == TT1 {
                            //@if  v[700] == v[TT1] { // NOT EXPERIMENTAL

                                v[311] = v[v[312]] * v[1117] 
				v[311] += 4700
                                v[v[309]].copy v[304], 2
                                v[301] = v[311] + 7
                                v[304] .sub v[v[301]], 2
                                v[304] .mul v[304], 2
                                v[v[306]] = v[304] + v[305] + v[v[311] + 276]
                                @if v[v[306]] < v[308] {
                                    v[v[534] + v[307]] = v[v[306]] * 1000 + v[v[312]] + v[4001 + min(v[v[301] + 95], 29)]
                                    v[306..307] += 1
                                    
                                }
                                
                            }
                            
                        }
                        
                        
                    }

		    //Has upper than 16 enemies in the search radius
                    @if v[307] >= 16 {
			//set next search skip flag 
                        v[v[634]] |= v[703] == 0 ? 2097152 : 0 //v[v[212] + 103] == 0 ? 2097152 : 0
                        //break the flag
			v[v[634]] &= -129 //~128
                        
                    } .else bl {
			//found none in the radius
                        @if v[307] == 0 {
				//If the agent has target agent initially
				@if v[v[300]] > 0 {
				    //If the unit has cohort order flag
				    @if `v[v[634]] & 128 {
					//if the target is set by cohort order, then sight radius is 2.5 times bigger - if an agent have a target already, its sight radius is halved - see above. 
					v[308] *= 5
					
				    }

					//Try checking if current target is in sight radius  
					v[311] = v[v[300]] * v[1117] 
					v[311] += 4700
					v[v[309]].copy v[304], 2
					v[301] = v[311] + 7
					v[304] .sub v[v[301]], 2
					v[304] .mul v[304], 2
					v[v[306]] = v[304] + v[305] + v[v[311] + 276]
					@if v[v[306]] < v[308] {
					    //and if it's in the agent's sight, let it keep following to the target.
					    v[v[534] + v[307]] = v[v[306]] * 1000 + v[v[300]] //+ v[4001 + min(v[v[301] + 95], 29)] this part is needless, cuz the agent has no other possible target
					    v[306..307] += 1
					    
					}.else bl{
						//If the target is out of agent sight, then break cohort order flag and wait new cohort order
						v[v[634]] &= -129//~128
					}
					
				    }
				
                            
                        } .else bl {
                            v[v[634]] &= -129//~128
                            
                        }
                        
                    }
                    v[v[534]].sort v[307]
                    @if `v[603] & 8388608 { //v[v[212] + 3] & 8388608 {
                        //TT2 = v[212] + 26
                        //v[TT2].copy v[311], 2
			v[626].copy v[311],2
                        //TT2 = v[212] + 21
                        //v[TT2].copy v[303], 2
			v[621].copy v[303],2
                        @if v[304] < -30 {
                            v[312] -= 1
                            
                        } .else bl {
                            @if v[304] > 30 {
                                v[312] += 1
                                
                            }
                            
                        }
                        @if v[303] > 30 {
                            v[311] += 1
                            
                        } .else bl {
                            @if v[303] < -30 {
                                v[311] -= 1
                                
                            }
                            
                        }
                        v[286] = v[4529] + v[311] - v[69] + (v[312] - v[70]) * v[2061]
                        @if v[v[286]] > 0 {
                            @if `v[v[286]] / 10000 % 10 == 1 {
                                v[302] = v[v[286]] / 100000
                                v[301] = v[302] * 300 
				v[301] += 4701
                                @if v[v[301]] == 11 {
                                    v[v[634]] &= -193//~192//(64 + 128)
                                    @if `v[v[301] + 99] != v[v[212] + 100] {
                                        @if `v[v[634]] & 8388608 { //v[v[212] + 34] & 8388608 {
                                            v[v[534]] = v[302]
                                            v[v[634]] |= 2113536//2097152+16384
                                            v[307] += 1
                                            
                                        } .else bl {
                                            @if `v[v[634]]  & 1 { //v[v[212] + 34] & 1 {
                                                v[v[841]] = 2
                                                v[v[534]] = v[302]
                                                v[v[634]] |= 2097152
                                                v[307] += 1
                                                v[v[212] + 3] |= 37748736//33554432 + 4194304
                                                
                                            } .else bl {
                                                //@comment "stuck"
                                                @if v[703] == 0 { //v[v[212] + 103] == 0 {
                                                    TT1 = v[v[212] + 100] != 0 ? rnd(0, 99) : 100
                                                    @if TT1 <= 20 {
                                                        v[v[534]] = v[302]
                                                        v[v[212] + 34] |= 2097152
                                                        v[307] += 1
                                                        
                                                    } .else bl {
                                                        v[v[212] + 3] |= 33554432
                                                        v[v[634]] |= 16384
                                                        
                                                    }
                                                    
                                                } .else bl {
                                                    v[v[212] + 3] |= 33554432
                                                    v[v[634]] |= 16384
                                                    
                                                }
                                                
                                            }
                                            
                                        }
                                        
                                    } .else bl {
                                        v[v[212] + 3] |= 33554432
                                        v[v[634]] |= 16384
                                        
                                    }
                                    
                                }
                                
                            } .else bl {
                                @if `!(v[v[634]] & 4096) {
                                    v[v[212] + 3] |= 33554432
                                    v[v[634]] |= 16384
                                    
                                }
                                
                            }
                            
                        } .else bl {
                            v[v[634]] &= -4097//~4096
                            
                        }
                        
                    }
                    @if v[v[534]] < 999999999 {
                        v[v[534]..v[534] + v[307] - 1] %= 1000
                        v[v[300]] = v[v[534]]
                        v[v[634]] &= -65//~64
                        
                    } .else bl {
                        v[307] = 0
                        
                    }
                    v[306] = 0
                    TT1 = v[534] + v[1012]
                    v[306].copy v[TT1], 2
                    @if v[v[300]] == 0 {
                        v[v[634]] |= 64
                        @if v[841] == 3 {//`v[v[212] + 241] == 3 {
                            @if v[842] != -2 {//`v[v[212] + 242] != -2 {
                                @if v[823] > 11000 {//`v[v[212] + 23] > 11000 {
                                    v[v[212] + 245] = 0
                                    
                                }
                                
                            }
                            
                        }
                        @if v[680] <= -5000 { //`v[v[212] + 80] <= -5000 {
                            v[v[634]] |= 2097152
                            
                        }
                        
                    }
                    
                }
                
            }
            
        }
        
    }
    v[536] += 1
    
}

//These processes missing comments and idk wtf doing lmao
@if s[2] .isOff() {

    //ACTION TIMER MANAGEMENT AND SO ON
    v[536] = v[4532]
    @while v[v[536]] != 0 {
	Ptr1 = v[v[536]] * 300
	Ptr1 += 4701
	v[Ptr1].copy agent_ObjectType,300
        @if agent_ActionTimer <= 0 {
		agent_ActionTimer = v[1195] //init ActionTimer

		@if `agent_AgentBits & 2097152 { //peasant
			agent_Morale = agent_InCombatTimer > 0 && !(agent_BaseObjBit&4096) ? 3:0
			//finish?
		}.else bl {
			@if `agent_AgentBits & 1048576 { //mil units
				@if agent_TargetAgentID == 0 { // have no target
					//try to pick from own list 
					v[211] = v[v[536]] - 1
					v[534] = v[4579] + (v[1012] + 2) * v[211]
					//pointer offset
					v[297] = v[534] + v[1012]
					//get obj amount in the list
					v[302] = v[v[297] + 1] - v[v[297]]
					v[296] = v[534] + v[v[297]]
					v[371] = 0
					@loop v[302] {
					    @if `0 < v[v[v[296]] * 300 + 4701] {
						agent_TargetAgentID = v[v[296]]
						v[371] = 1
						@break
						
					    }
					    v[v[297]] += 1
					    v[296] += 1
					    
					}
					
					@if v[371] == 0 {
					    agent_TargetAgentID = 0
					    
					}
                     


				}

			}

		}
		agent_ObjectType.copy v[Ptr1],300
		
	}
	v[536] += 1
        
    }
    //STATIC AI
    v[536] = v[4533]
    v[4031] = v[1146]
    v[4032..4033] = v[1145]
    v[4034] = v[206]
    v[4035..4036] = v[205]
    @while v[v[536]] != 0 {
        v[683] = v[v[536]] * 300 
	v[683] += 4784
        v[211] = v[v[536]] - 1
        v[212] = v[211] * 300 
	v[212] += 5000
        @if v[v[683]] <= 0 {
            v[v[683]] = v[1195] * 2
            @if `v[v[212] + 3] & 1048576 {
                v[300] = v[212] + 18
                v[299] = v[212] + 241
                v[301] = v[212] + 100
		__if DIS_EXPERIMENTAL == 1 {
			macro_get_agent_MetaTeam_into_var(v[v[536]],v[314])
		}.else bl {
			v[314] = v[Const_AgentMetaTeam_begin+v[211]] //v[v[301]] % 3
		}

                v[302] = v[4031 + v[314]] //v[v[301]] % 3
                v[307] = v[302]
                v[309] = v[212] + 7
                v[308] = v[4034 + v[314]] //v[v[301]] % 3
                v[4001..4030] = 0
                v[307] = 0
                v[308] = v[v[212] + 230]
                v[3401..3600] = 999999999
                @doWhile v[v[302]] != 0 {
                    v[306] = v[307] + 3601
                    v[301] = v[v[302]] * 300 
		    v[301] += 4701
                    v[350] = v[v[301]]
                    v[301] += 6
                    v[v[309]].copy v[304], 2
                    v[304] .sub v[v[301]], 2
                    v[304] .mul v[304], 2
                    v[v[306]] = v[304] + v[305] + v[v[v[302]] * 300 + 4976]
                    @if v[v[306]] < v[308] {
                        TT1 = 3401 + v[307]
                        v[TT1] = v[v[306]] * 1000 + v[v[302]]
                        v[307] += 1
                        
                    }
                    v[302] += 1
                    
                }
                
                v[3401].sort v[307]
                v[v[300]] = v[3401] < 999999999 ? v[3401] % 1000 : 0
                
            }
            
        }
        @if `v[v[212] + 3] & 32768 {
            v[301] = v[212] + 170
            @if v[v[301]] <= 0 {
                @call .cev 1748
                v[11] = v[v[536]]
                @call .cev 1747
		v[11] = v[212]+213
                v[11] = v[v[11]]
                @if v[11] >= 1 {
                    @call .cev 1730
                    @call .cev 1748
                    
                } .else bl {
                    v[v[212] + 3] &= -32769//~32768
                    
                }
                
            }
            
        }
        v[536] += 1
        
    }
    
    
}
