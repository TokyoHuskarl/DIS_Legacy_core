defv SpawnAgentID = 537

//get drawing functions

__if LOAD_HEADER_DRAW != 1 {
	YOU_MUST_INCLUDE_DRAWING_HEADER // Since behavior of TPC #include directive is SHIT, you must manually #include header_drawing.tpc whenever you use these functions  
}

//temp
struct("weapon",{
	defv  {
		weapon_Ammo = 1920
	}
})

//cev .id(300), .name("Agent:Spawn Basic"), {



__fn func_generate_agent {
	@if `s[152] == 0 && v[254] < 80 {
	    //legacy common event call spawn
	    @call .cev v[254]
	    
	} .elif v[254] > 0 {
	    str3 .asg ""
	    str5 .asg t[20034]
	    // "Load"
	    v[1942] = v[254]
	    v[1942] -= s[152] == 0 ? 200 : 0
	    v[1941] = v[1215] + v[1942]
	    t[2998] .asg t[v[1941]]
	    t[2998] .split ",", t[2998], v[1941]
	    str3 .asg t[2999]
	    @if spawnSet_Team == 0 {
				@if v[258] == 0 {
						t[3000] .toNum v[258]
						
				}
	    }

	    str5 .asg t[3000]
	    t[2999..3000] .asg ""
	    str1 .asg str3
	    // "Production Speed"
	    t[3075] .toNum var3
	    // "Resource costs"
	    t[3076] .toNum v[31]
	    t[3077] .toNum v[32]
	    t[3078] .toNum v[33]
	    t[3079] .toNum v[34]
	    @if str3 .neq "" {
		@if s[151] .isOff() {
		    @if v[204] < v[1004] {
			v[204] += 1
			@loop v[1004] .dst Temp20 {
			    ptr_SpawnAgentMainSpace_Head %= v[1004]
			    Temp1 = ptr_SpawnAgentMainSpace_Head * 300 
			    Temp1 += 5000
			    Ptr20 = Temp1 + 1
			    @if v[Ptr20] <= 0 {
				// "##################Init start"
				// "まず清掃"
				v[1301].copy v[601], 300
				v[1301].copy v[Ptr20], 300
				// "ORDER SET"
				v[841] = v[277]
				// "チームセット"
				agent_TeamID = spawnSet_Team
				v[624] = between(agent_TeamID, 0, 2) ? agent_TeamID + 1 : 3
				// "WP消しておく"
				v[655] = -1
				// "出る場所セット"
				spawnSet_x.copy v[605], 2
				// "生成場所の数値を入れる"
				v[605].copy v[607], 2
				v[605].copy v[641], 2
				v[310..311] = 10000
				v[605] .mul Temp10, 2
				// "Init end##################"
				agent_UnitID = v[254]
				agent_UnitID -= s[152] == 0 ? 200 : 0
				// "ObjTyp"
				t[3001] .toNum v[601]
				// "#SpriteSet"
				//v[v[1216]..v[1216] + 100] = 0
				v[1301].copy v[v[1216]], 100

				t[3200..3300] .asg ""
				t[3002] .split "|", t[3200], v[1941]
				@loop v[1941] .dst v[1945] {
				    v[1942] = 3200 + v[1945]
				    v[1943] = v[1216] + v[1945]
				    t[v[1942]] .toNum v[1944]
				    v[v[1943]] = v[1944]
				    
				}
				
				v[602] = v[v[1216] + rnd(0, v[1941] - 1)]
				// "###"
				t[3003] .toNum v[664]
				t[3004] .toNum v[1941]
				// "SkinSet"
				@if v[1941] >= 1 {
				    @call .cev v[1941]
				    
				} .else bl {
				    // "Hair and Face"
				    // "#Skin"
				    v[663] = 0
				    // "#Head"
				    v[669] = 0
				    v[887] = v[669] + v[663] * 1000000
				    v[887] += v[663] != -1 ? v[664] * 10000000 : 0
				    // "#Hair"
				    v[670] = 0
				    
				}
				@call .cev 309
				// "Hit Box"
				t[3005] .toNum v[610]
				t[3006] .toNum v[611]
				// "#Passive"
				t[3007] .toNum v[822]
				t[3008] .toNum v[821]
				// "#Simplification#Unit Type to MS Add"
				@loop 13 .dst v[1941] {
				    v[1942] = 3009 + v[1941]
				    v[1943] = 1901 + v[1941]
				    t[v[1942]] .toNum v[1944]
				    v[v[1943]] = v[1944]
				    
				}
				
				v[0] = v[702..716] += [v[1901], 0, v[1902], v[1903], v[1903], v[1904], v[1904], v[1905], v[1906], v[1907], v[1908], v[1909], v[1910], v[1911], v[1912]]
				// "##WILL"
				v[739] += v[1913]
				// "#HP/SPreg set"
				t[3050] .toNum v[1941]
				v[731] = v[1941] != 0 ? v[1941] : v[731]
				t[3051] .toNum v[1941]
				v[732] = v[1941] != 0 ? v[1941] : v[732]
				// "#Movetype set"
				t[3053] .toNum v[638]
				// "#Skills"
				t[3036] .toNum v[741]
				t[3037] .toNum v[761]
				t[3038] .toNum v[781]
				t[3039] .toNum v[801]
				// "#Passive"
				t[3040] .toNum v[824]
				@if v[824] >= v[1186] {
				    s[118].on
				    @call .cev v[824]
				    s[118].off
				    
				}
				// "#SetPerks"
				v[4101..4120] = 0
				Temp2 = 4101 - 6
				// "#Perks1"
				@loop 4 .dst v[1950] {
				    v[v[1216]..v[1216] + 100] = 0
				    v[1949] = v[1950] + 3041
				    t[v[1949]] .split "|", t[3200], v[1941]
				    @loop v[1941] .dst v[1945] {
					v[1942] = 3200 + v[1945]
					v[1943] = v[1216] + v[1945]
					t[v[1942]] .toNum v[1944]
					v[v[1943]] = v[1944]
					
				    }
				    
				    @loop v[1941] .dst v[1945] {
					v[1943] = v[1216] + v[1945]
					v[4101 + v[1950]] |= pow(2, v[v[1943]] - 1)
					
				    }
				    
				    
				}
				
				v[665] = v[Temp2 + 6]
				v[666] = v[Temp2 + 7]
				// "##########Extra########"
				t[3048] .toNum v[1944]
				@if v[1944] > 200 {
				    @call .cev v[1944]
				    
				}
				//@call .cev 301
				GenAgent_BaseStatsPerk()
				// "###################Equipment Begin###################"
				t[__id(Str_slot_armorfile)..__id(Str_slot_subsetL)].asg "" // init weapon file buffers

				// "#wea"
				@if v[851] == 0 {
				    v[v[1216]..v[1216] + 100] = 0
				    t[3200..3300] .asg ""
				    t[3022] .split "|", t[3200], v[1941]
				    @loop v[1941] .dst v[1945] {
					v[1942] = 3200 + v[1945]
					v[1943] = v[1216] + v[1945]
					t[v[1942]] .toNum v[1944]
					v[v[1943]] = v[1944]
					
				    }
				    
				    v[851] = v[v[1216] + rnd(0, v[1941] - 1)]
				    
				}
				// "#Shield"
				@if v[852] == 0 {
				    v[v[1216]..v[1216] + 100] = 0
				    t[3200..3300] .asg ""
				    t[3024] .split "|", t[3200], v[1941]
				    @loop v[1941] .dst v[1945] {
					v[1942] = 3200 + v[1945]
					v[1943] = v[1216] + v[1945]
					t[v[1942]] .toNum v[1944]
					v[v[1943]] = v[1944]
					
				    }
				    
				    v[852] = v[v[1216] + rnd(0, v[1941] - 1)]
				    
				}
				@if v[853] == 0 {
				    // "#Armor"
				    v[v[1216]..v[1216] + 100] = 0
				    t[3200..3300] .asg ""
				    t[3026] .split "|", t[3200], v[1941]
				    @loop v[1941] .dst v[1945] {
					v[1942] = 3200 + v[1945]
					v[1943] = v[1216] + v[1945]
					t[v[1942]] .toNum v[1944]
					v[v[1943]] = v[1944]
					
				    }
				    
				    v[853] = v[v[1216] + rnd(0, v[1941] - 1)]
				    
				}
				// "#Helm"
				@if v[854] == 0 {
				    v[v[1216]..v[1216] + 100] = 0
				    t[3200..3300] .asg ""
				    t[3028] .split "|", t[3200], v[1941]
				    @loop v[1941] .dst v[1945] {
					v[1942] = 3200 + v[1945]
					v[1943] = v[1216] + v[1945]
					t[v[1942]] .toNum v[1944]
					v[v[1943]] = v[1944]
					
				    }
				    
				    v[854] = v[v[1216] + rnd(0, v[1941] - 1)]
				    
				}
				// "#Acc"
				@if v[855] == 0 {
				    v[v[1216]..v[1216] + 100] = 0
				    t[3200..3300] .asg ""
				    t[3030] .split "|", t[3200], v[1941]
				    @loop v[1941] .dst v[1945] {
					v[1942] = 3200 + v[1945]
					v[1943] = v[1216] + v[1945]
					t[v[1942]] .toNum v[1944]
					v[v[1943]] = v[1944]
					
				    }
				    
				    v[855] = v[v[1216] + rnd(0, v[1941] - 1)]
				    
				}
				// "#res1"
				@if v[856] == 0 {
				    v[v[1216]..v[1216] + 100] = 0
				    t[3200..3300] .asg ""
				    t[3032] .split "|", t[3200], v[1941]
				    @loop v[1941] .dst v[1945] {
					v[1942] = 3200 + v[1945]
					v[1943] = v[1216] + v[1945]
					t[v[1942]] .toNum v[1944]
					v[v[1943]] = v[1944]
					
				    }
				    
				    v[856] = v[v[1216] + rnd(0, v[1941] - 1)]
				    
				}
				// "#res2"
				@if v[857] == 0 {
				    v[v[1216]..v[1216] + 100] = 0
				    t[3200..3300] .asg ""
				    t[3034] .split "|", t[3200], v[1941]
				    @loop v[1941] .dst v[1945] {
					v[1942] = 3200 + v[1945]
					v[1943] = v[1216] + v[1945]
					t[v[1942]] .toNum v[1944]
					v[v[1943]] = v[1944]
					
				    }
				    
				    v[857] = v[v[1216] + rnd(0, v[1941] - 1)]
				    
				}
				

				// "#Get Variations"
				t[3023] .toNum v[4001]
				t[3025] .toNum v[4002]
				t[3027] .toNum v[4003]
				t[3029] .toNum v[4004]
				t[3031] .toNum v[4005]
				// "#Set Equipments Parameter"
				//Check reserve ammo first
				@if v[856] > 0 {
					var1 = v[856]
					var2 = 0
					@call .cev v[1150]
					Str_slot_subsetR.asg Str_slot_weaponfile
					Str_slot_weaponfile.asg ""

					func_convert_weapon_ammo_into_four_byte_ammo_data(weapon_Ammo)
					agent_Ammo = reg1 << 16
					macro_set_agent_AI_decision_Sub_WEP_Type(v[1907])//set subset
					//also...
					agent_AI_decision_bits |= AI_decision_bits_FLAG_Have_reserve_set
				}.else bl{
					agent_Ammo = 0
				}
				//Set Weapon
				var1 = v[851]
				var2 = v[4001]
				@call .cev v[1150]
				@call .cev 1923
				Str_slot_mainsetR.asg Str_slot_weaponfile
				Str_slot_weaponfile.asg ""
				//Main weapon ammo Set!
				//if v[1920] == 0, just ignore.
				func_convert_weapon_ammo_into_four_byte_ammo_data(weapon_Ammo)
				agent_Ammo += reg1


				@if v[1901] < 100 {
				    var1 = v[852]
				    var2 = v[4002]
				    @call .cev v[1151]
				    @call .cev 1923
						Str_slot_mainsetL.asg Str_slot_weaponfile
						Str_slot_weaponfile.asg ""
				    
				} .else bl {
						Str_slot_mainsetL.asg ""
				    v[859] = v[858]
				    v[852] = 0
				    
				}
				var1 = v[853]
				var2 = v[4003]
				@call .cev v[1152]
				@call .cev 1923
				var1 = v[854]
				var2 = v[4004]
				@call .cev v[1153]
				@call .cev 1923
				var1 = v[855]
				var2 = v[4005]
				@call .cev v[1154]
				@call .cev 1923
				// "###################Equipment End###################"
				// "########################################################"
				// "##AA Function"
				// "#ExtraAA Setting"
				// "##Range Max/Min"
				t[3054] .toNum v[1941]
				v[717] = v[1941] != 0 ? v[1941] : v[717]
				t[3055] .toNum v[1941]
				agent_BaseRange_min = v[1941] != 0 ? v[1941] : agent_BaseRange_min
				// "#AS set"
				t[3052] .toNum v[1941]
				v[719] = v[1941] != 0 ? v[1941] : v[719]
				t[3058] .toNum v[1941]
				v[730] = v[1941] != 0 ? v[1941] : v[730]
				// "##Without Weapon, change AA type into Function"
				@if `v[851] <= 0 && v[1941] > 0 {
				    v[703] = 4
				    
				}
				// "##AA Reserve"
				t[3059] .toNum v[1941]
				v[727] = v[1941] != 0 ? v[1941] : v[727]
				// "##Attack Time"
				t[3060] .toNum v[1941]
				v[728] = v[1941] != 0 ? v[1941] : v[728]



				// "##Motion"
				t[3056] .toNum v[1941]
				v[720] = v[1941] != 0 ? v[1941] : v[720]
				// "##AACost"
				t[3057] .toNum v[1941]
				v[721] = v[1941] != 0 ? v[1941] : v[721]
				// "##Eff"
				t[3061] .toNum v[1941]
				v[736] = v[1941] != 0 ? v[1941] : v[736]
				// "##Pen"
				t[3062] .toNum v[1941]
				v[737] = v[1941] != 0 ? v[1941] : v[737]
				// "########################################################"
				// "##AI Flag"
				v[v[1216]..v[1216] + 100] = 0
				t[3065] .split "|", t[3200], v[1941]
				@loop v[1941] .dst v[1945] {
				    v[1942] = 3200 + v[1945]
				    v[1943] = v[1216] + v[1945]
				    t[v[1942]] .toNum v[1944]
				    v[v[1943]] = v[1944]
				    
				}
				
				@loop v[1941] .dst v[1945] {
				    v[1943] = v[1216] + v[1945]
				    v[634] |= pow(2, v[v[1943]] - 1)
				    
				}
				
				// "##Skills"
				s[118].on
				@if v[741] >= v[1186] {
				    @call .cev v[741]
				    v[581].copy v[741], 20
				    
				}
				@if v[761] >= v[1186] {
				    @call .cev v[761]
				    v[581].copy v[761], 20
				    
				}
				@if v[781] >= v[1186] {
				    @call .cev v[781]
				    v[581].copy v[781], 20
				    
				}
				@if v[801] >= v[1186] {
				    @call .cev v[801]
				    v[581].copy v[801], 20
				    
				}
				s[118].off
				// "#Obj Bits"
				// @call .cev 302
				GenAgent_PerksAndObjBits()
				v[v[1216]..v[1216] + 100] = 0
				t[3200..3300] .asg ""
				t[3046] .split "|", t[3200], v[1941]
				@loop v[1941] .dst v[1945] {
				    v[1942] = 3200 + v[1945]
				    v[1943] = v[1216] + v[1945]
				    t[v[1942]] .toNum v[1944]
				    v[v[1943]] = v[1944]
				    
				}
				
				@loop v[1941] .dst v[1945] {
				    v[1943] = v[1216] + v[1945]
				    agent_BaseObjBit |= pow(2, v[v[1943]] - 1)
				    
				}
				
				// "#AA Bits"
				v[v[1216]..v[1216] + 100] = 0
				t[3200..3300] .asg ""
				t[3047] .split "|", t[3200], v[1941]
				@loop v[1941] .dst v[1945] {
				    v[1942] = 3200 + v[1945]
				    v[1943] = v[1216] + v[1945]
				    t[v[1942]] .toNum v[1944]
				    v[v[1943]] = v[1944]
				    
				}
				
				@loop v[1941] .dst v[1945] {
				    v[1943] = v[1216] + v[1945]
				    v[724] |= pow(2, v[v[1943]] - 1)
				    
				}
				
				// "Motion"
				v[v[1216]..v[1216] + 100] = 0
				t[3200..3300] .asg ""
				t[3045] .split "|", t[3200], v[1941]
				@loop v[1941] .dst v[1945] {
				    v[1942] = 3200 + v[1945]
				    v[1943] = v[1216] + v[1945]
				    t[v[1942]] .toNum v[1944]
				    v[v[1943]] = v[1944]
				    
				}
				
				@loop v[1941] .dst v[1945] {
				    v[1943] = v[1216] + v[1945]
				    v[726] |= pow(2, v[v[1943]] - 1)
				    
				}
				
				// "Horse"
				Temp2 = 4101 - 6
				//@call .cev 303
				GenAgent_Horse_Setting()





				// "dir"
				v[844] = v[280]
				// "DEBUG"
				@if agent_TeamID == 0 {
				    @if s[19] .isOff() {
					@if s[319] .isOn() {
					    @if s[477] .isOff() {
						@if agent_TeamID == 0 {
						    // "Elf"
						    @if agent_UnitID == 23 {
							// "＃＃＃＃＃＃＃＃＃＃＃＃"
							v[229] = 34
							s[240].on
							// "＃＃＃＃＃＃＃＃＃＃＃＃"
							
						    }
						    @if agent_UnitID == 159 {
							// "＃＃＃＃＃＃＃＃＃＃＃＃"
							v[229] = 35
							s[240].on
							// "＃＃＃＃＃＃＃＃＃＃＃＃"
							
						    }
						    
						}
						
					    }
					    
					}
					@if t[3081] .eq "" {
					    t[3081] .asg "sword1"
					    @if agent_UnitType == 1 {
						t[3081] .asg "barrier1"
						
					    }
					    @if agent_UnitType == 2 {
						t[3081] .asg "horse"
						
					    }
					    @if agent_UnitType == 4 {
						t[3081] .asg "magic2"
						
					    }
					    @if agent_UnitType == 5 {
						t[3081] .asg "earth4"
						
					    }
					    
					}
					v[472] = divmul(70, 100, v[2216])
					@se.play t[3081] .opt v[472], 100, 50
					
				    }
				    
				}
				@call .cev 1903
				@break
				
			    }
			    @if Temp20 >= v[1004] {
				// "Obj多すぎ"
				@break
				
			    }
			    ptr_SpawnAgentMainSpace_Head += 1
			    
			}
			
			
		    }
		    
		} .else bl {
		    t[3082] .toNum v[35]
		    @if v[35] > 200 {
			@call .cev v[35]
			
		    }
		    
		}
		
	    } .else bl {
		str3 .asg "UNDEFINED"
		func_errlog("The troop attempted to be spawned is UNDEFINED.")
	    }
	    
	}
	s[152].off

}


//cev .id(1903), .name("Agent:Spawn Finish"), {
__fn func_generate_agent_finish_set {
	SpawnAgentID = ptr_SpawnAgentMainSpace_Head + 1 //

	__if DIS_EXPERIMENTAL == -1 {
		@if s[150].isOff() {
			init_AEAB_array(SpawnAgentID)
			reg2 = 4701
			reg2 += SpawnAgentID * 300 
			set_AEAB_element(SpawnAgentID,__id(reg2),AgentExBuffer_SLOT_Ptr_To_BasicArray)
		
		}
	}
	@comment "#reg1 = ObjID #reg2 = UnitID #reg3 = UnitType"
	@comment "Set Dir"
	v[656] = v[280] * 180000
	@comment "Stop Morale System below hard mode"
	@if `(s[7] == 1 || s[474] == 1) && v[2401] < 3 || s[470] == 1 {
	    agent_BaseObjBit |= BaseObjBit_FLAG_No_mind
	    
	} .else bl {
	    @if s[7] .isOn() {
		@if agent_TeamID == 1 {
		    v[739] += 8
		    
		}
		
	    }
	    
	}
	@if v[601] < 11 {
	    v[752] = v[752] == 0 ? -1 : v[752]
	    v[772] = v[772] == 0 ? -1 : v[772]
	    v[792] = v[792] == 0 ? -1 : v[792]
	    v[812] = v[812] == 0 ? -1 : v[812]
	    v[726] |= 524288
	    
	} .else bl {
	    //cache flag
	    v[725] |= 512

	    v[607].copy reg1, 2
	    reg1 .add v[53], 2
	    reg1 .sub v[76], 2
	    reg1 .div v[74], 2
	    @comment "TT1=MortX  TT2=MortY ビット演算して処理するよ"
	    reg1 = (reg1 | reg1 << 8) & 0xFF00FF
	    reg1 = (reg1 | reg1 << 4) & 0xF0F0F0F
	    reg1 = (reg1 | reg1 << 2) & 0x33333333
	    reg1 = (reg1 | reg1 << 1) & 0x55555555
	    reg2 = (reg2 | reg2 << 8) & 0xFF00FF
	    reg2 = (reg2 | reg2 << 4) & 0xF0F0F0F
	    reg2 = (reg2 | reg2 << 2) & 0x33333333
	    reg2 = (reg2 | reg2 << 1) & 0x55555555
	    @comment "yは1bitシフトで終わり"
	    reg2 <<= 1
	    @comment "最後にTT1 OR TT2"
	    v[609] = reg1 | reg2
	    @if `between(agent_UnitType, 104, 105) {
		@comment "Flat Static"
		v[726] |= 1048576
		
	    }
	    str3 .asg ""
	    str5 .asg t[20034]
	    @comment "Load"
	    v[1942] = agent_UnitID
	    v[1941] = v[4576] + v[1942] - 1
	    t[2998] .asg t[v[1941]]
	    t[2998] .split "|", t[2999], v[1941]
	    str3 .asg t[2999]
	    t[2999..3000] .asg ""
	    str1 .asg str3



	    //save map tile infomation where the Static built
	    v[605].copy Temp11, 2
	    Temp11 .add v[1061], 2
	    Temp11.copy Temp3, 2
	    macro_cord_diff(Temp11 Temp12)
	    Temp13 = v[v[1182] + Temp11 - Map_LimitCoordX_min + (Temp12 - Map_LimitCoordY_min) * var_Map_Width]
	    v[657] = Temp13 / 100000000
	    v[640] = Temp13 % 100

	}
	@comment "Enabling Skill AI"
	@if v[601] <= 8 {
	    @comment "standard bearer"
	    v[823] |= agent_BaseObjBit & BaseObjBit_FLAG_Standard_Bearer ? 4 : 0
	    @comment "Access19 = Obj's Behavior Access20 = Obj's target ID"
	    @if agent_UnitType <= 7 {
		v[603] |= [1048576, 1048576, 0, 1048576, 0][v[841]]
		@if `v[752] > -1 || v[772] > -1 || v[792] > -1 || v[812] > -1 {
		    v[603] |= 524288
		    
		}
		
	    }
	    @comment "Blacksmith Bonus"
	    @if agent_UnitType <= 4 {
		@if `agent_UnitType == 1 || agent_UnitType == 2 && v[703] > 0 {
		    @comment "Arrow"
		    v[709] += v[2409 + spawnSet_Team % 3] & 0x200 ? muldiv(v[709], 10, 100) : 0
		    v[719] += v[2409 + spawnSet_Team % 3] & 0x400 ? muldiv(v[719], 10, 100) : 0
		    v[713] += v[2409 + spawnSet_Team % 3] & 0x400 ? 5 : 0
		    v[713] += v[2409 + spawnSet_Team % 3] & 0x8000 ? 3 : 0
		    
		} .else bl {
		    @comment "Melee"
		    v[709] += v[2409 + spawnSet_Team % 3] & 0x80 ? muldiv(v[709], 10, 100) : 0
		    v[713] += v[2409 + spawnSet_Team % 3] & 0x80 ? 2 : 0
		    v[709] += v[2409 + spawnSet_Team % 3] & 0x100 ? muldiv(v[709], 8, 100) : 0
		    v[713] += v[2409 + spawnSet_Team % 3] & 0x100 ? 3 : 0
		    
		}
		v[711] += v[2409 + spawnSet_Team % 3] & 0x800 ? muldiv(v[711], 8, 100) : 0
		v[711] += v[2409 + spawnSet_Team % 3] & 0x1000 ? muldiv(v[711], 6, 100) : 0
		@if agent_UnitType == 3 {
		    v[710] += v[2409 + spawnSet_Team % 3] & 0x2000 ? 18 : 0
		    v[705..706] += v[2409 + spawnSet_Team % 3] & 0x4000 ? muldiv(v[706], 18, 100) : 0
		    v[707..708] += v[2409 + spawnSet_Team % 3] & 0x4000 ? muldiv(v[708], 18, 100) : 0
		    @comment "can support tactics if the unit is mage with function AA"
		    agent_BaseObjBit |= v[703] == 4 ? 8388608 : 0
		    
		}
		@if agent_UnitType == 4 {
		    agent_BaseObjBit |= v[703] == 4 ? 8388608 : 0
		    v[739] += v[2409 + spawnSet_Team % 3] & 0x4000000 ? 25 : 0
		    
		}
		
	    }
	    
	}
	@if agent_UnitType == 9 {
	    v[603] &= ~(1048576 + 524288)
	    v[603] |= 2097152
	    v[603] |= 256
	    agent_BaseObjBit |= 256
	    @comment "cart"
	    v[711] += v[2409 + spawnSet_Team % 3] & 0x10 ? 25 : 0
	    v[705..706] += v[2409 + spawnSet_Team % 3] & 0x20 ? 100 : 0
	    
	}
	@comment "Imperials"
	@if v[822] == 1 {
	    @if `v[2412 + spawnSet_Team % 3] & 0x40 {
		@if `between(agent_UnitType, 0, 6) {
		    v[712] += 800
		    
		}
		
	    }
	    @comment "Arcane Composite Armor"
	    @if `v[2412 + spawnSet_Team % 3] & 0x8 {
		@comment "Cataphract"
		@if agent_UnitID == 21 {
		    agent_BaseObjBit |= 32
		    
		}
		
	    }
	    
	}
	@comment "Rus"
	@if v[822] == 9 {
	    @comment "Inf"
	    @if agent_UnitType == 0 {
		@if `v[2409 + spawnSet_Team % 3] & 0x10000000 {
		    v[705..706] += muldiv(v[706], 1, 10)
		    
		}
		
	    }
	    
	}
	@comment "Sushi"
	@if v[822] == 12 {
	    @comment "Divine Wind"
	    @if `v[2412 + spawnSet_Team % 3] & 0x2 {
		@if `between(agent_UnitType, 0, 4) {
		    @if `between(v[664], 1, 2) {
			@comment "KAMIKAZE"
			agent_BaseObjBit |= BaseObjBit_FLAG_Explosive
			v[710] += 60
			agent_BaseMS += 8
			@comment "Will"
			v[739] += 15
			
		    }
		    
		}
		
	    }
	    @comment "Tengger Cavalry"
	    @if `v[2412 + spawnSet_Team % 3] & 1 {
		@if agent_UnitType == 2 {
		    agent_BaseMS = muldiv(agent_BaseMS, 108, 100)
		    
		}
		
	    }
	    
	}
	s[118].off
	//Set Agent Name
	v[899] = ptr_SpawnAgentMainSpace_Head + Address_str_agent_name_array_head
	v[899] += 1
	t[v[899]] .asg str1





	@comment "###################Set New Picture System###################"
	Temp2 = ptr_SpawnAgentMainSpace_Head * 6 + v[1185] //ACHTUNG you need to remove this system eventually - it's obsolete legacy system, almost no meaning now
	@comment "#init"
	v[Temp2..Temp2 + 5] = 0
	v[Temp2] = v[602] > 0 ? v[602] : agent_UnitID
	@comment "v[899]=Layers"
	v[899] = 7
	@comment "#STATIC"
	@if v[601] == 11 {

	    @if agent_AAType == 2 {
		func_get_ranged_weapon_velocity(agent_BaseRange_max,1)
		agent_AAvelocity = reg1
	    }

	    Bool_Refresh_Static_Minimap.on //request refresh minimap static
	    v[834..835] = 0
	    //MapXY/5 for minimap
	    v[600+AGENT_STATIC_SLOT_MINIMAP_X]=agent_MapX/5
	    v[600+AGENT_STATIC_SLOT_MINIMAP_Y]=agent_MapY/5
	    @comment "Node check"
	    @comment "walls"
	    @if agent_UnitType == 107 {


	    	v[600+AGENT_STATIC_SLOT_MINIMAP_X]=(v[803]+agent_Width/16)/5
	        v[600+AGENT_STATIC_SLOT_MINIMAP_Y]=(v[804]+agent_Height/16)/5
		@if `v[603] & 256 {
		    

		    v[803].copy var1, 2
		    @call .cev 2017
		    v[807] = reg1
		    v[808..809] = 0
		    v[807] = max(v[807], 0)
		    v[808] += v[610] * 2 / 32
		    v[809] += v[611] * 2 / 32

		    /*v[803].copy v[856], 2
	    	    v[856]=(v[856]+v[610]/16)/5
	    	    v[857]=(v[857]+v[611]/16)/5*/

		    @loop v[809] .dst v[2064] {
			Ptr6 = v[4564] * (v[807] + v[433] * v[2064]) + v[4569] - 1
			@loop v[808] .dst v[2065] {
			    @comment "init"
			    Ptr7 = Ptr6 + 3
			    @comment "setup"
			    @if v[Ptr7] == 0 {
				Ptr7 += 1
				
			    }
			    @comment "Cost Set"
			    @comment "setup"
			    @comment "Cost Set"
			    v[Ptr7] -= 30
			    @comment "static built"
			    v[Ptr6 + 11] |= 32
			    @comment "1"
			    Ptr6 += v[4564]
			    
			}
			
			
		    }
		    
		    
		} .else bl {
		    v[803].copy var1, 2
		    @call .cev 2017
		    v[807] = reg1
		    v[808..809] = 0
		    @if v[610] >= v[611] {
			v[834] = 1
			
		    } .else bl {
			v[835] = 1
			
		    }
		    v[807] = max(v[807], 0)
		    v[808] += v[610] * 2 / 32
		    v[809] += v[611] * 2 / 32
		    @loop v[809] .dst v[2064] {
			Ptr6 = v[4564] * (v[807] + v[433] * v[2064]) + v[4569] - 1
			@loop v[808] .dst v[2065] {
			    @comment "init"
			    Ptr7 = Ptr6 + 3
			    @comment "setup"
			    @if v[Ptr7] == 0 {
				Ptr7 += 1
				
			    }
			    @comment "Cost Set"
			    @comment "setup"
			    @comment "Cost Set"
			    @if s[1] .isOn() {
				Ptr8 = Ptr6 + 1
				Ptr9 = Ptr6 + 2
				@loop 2 .dst v[2067] {
				    v[2068] = v[Ptr9] + v[2067]
				    @loop 2 .dst v[2066] {
					v[2069] = v[Ptr8] + v[2066]
					Temp13 = v[v[1182] + v[2069] - Map_LimitCoordX_min + (v[2068] - Map_LimitCoordY_min) * var_Map_Width] % 100
					@if Temp13 == 21 {
					    
					}
					
				    }
				    
				    
				}
				
				
			    }
			    v[Ptr7] += 24
			    @comment "static built"
			    v[Ptr6 + 11] |= 32
			    @comment "1"
			    Ptr6 += v[4564]
			    
			}
			
			
		    }
		    
		    
		}
		
	    } .else bl {
		@if `!between(agent_UnitType, 104, 105) {
		    v[607].copy var1, 2
		    var1 .sub v[610], 2
		    v[11..12] *= 10000
		    @call .cev 1999
		    v[803] = reg1
		    v[804] = reg2
		    v[804] += 1
		    reg1.copy v[803], 2
		    v[803].copy var1, 2
		    @call .cev 2017
		    v[807] = reg1
		    v[808..809] = 1
		    v[808] += v[610] * 2 / 32
		    v[809] += v[611] * 2 / 32
		    @loop v[809] .dst v[2064] {
			Ptr6 = v[4564] * (v[807] + v[433] * v[2064]) + v[4569] - 1
			@loop v[808] .dst v[2065] {
			    @comment "init"
			    Ptr7 = Ptr6 + 3
			    @comment "setup"
			    @if v[Ptr7] == 0 {
				Ptr7 += 1
				
			    }
			    @comment "Cost Set"
			    v[Ptr7] += 5
			    @comment "static built"
			    v[Ptr6 + 11] |= 32
			    @comment "1"
			    Ptr6 += v[4564]
			    
			}
			
			
		    }
		    
		    
		} .else bl {
		    v[607].copy var1, 2
		    var1 .sub v[610], 2
		    v[11..12] *= 10000
		    @call .cev 1999
		    v[803] = reg1
		    v[804] = reg2
		    v[804] += 1
		    reg1.copy v[803], 2
		    v[803].copy var1, 2
		    @call .cev 2017
		    v[807] = reg1
		    v[808..809] = 1
		    v[808] += v[610] * 2 / 32
		    v[809] += v[611] * 2 / 32
		    
		}
		
	    }
	    @comment "#minimap"
	    v[833] = max(min(muldiv(v[803], 100, v[430]) - 1, v[1277]), 0) + max(min(muldiv(v[804], 100, v[431]) - 1, v[1276]), 0) * v[1277]
	    v[834] += v[610] / 7 / v[413] + 1
	    v[835] += v[611] / 7 / v[416] + 1
	    @comment "####"
	    v[602] |= v[602] == 0 ? agent_UnitID : v[602]
	    v[841] = 1
	    v[603] |= 1048576
	    v[899] = 8
	    @comment "AVD=-100"
	    v[714] = -100
	    @comment "CritRedu"
	    v[839] = 100
	    @comment "Clean up production space"
	    v[770..800] = 0
	    agent_BaseObjBit |= 64
	    agent_BaseObjBit |= 128
	    @comment "no_fatigue"
	    v[726] |= 2048
	    @comment "Big flag"
	    agent_BaseObjBit |= 524288
	    @comment "No mind"
	    agent_BaseObjBit |= BaseObjBit_FLAG_No_mind
	    @comment "Halve Ranged"
	    agent_BaseObjBit |= 32
	    @comment "do not bleed"
	    agent_BaseObjBit |= BaseObjBit_FLAG_Immune_to_bleed
	    v[844] = 3
	    @comment "Design Flaw, temp fix"
	    v[820] = agent_BaseObjBit
	    @comment "Cost"
	    v[31].copy v[851], 4
	    @comment "##Team Bonus"
	    @if agent_UnitType != 105 {
		@if agent_UnitType != 104 {
		    v[711] += 50
		    v[705..706] += muldiv(v[706], 2, 10)
		    @comment "##Empire"
		    @if v[822] == 1 {
			v[705..706] += muldiv(v[706], 4, 10)
			
		    }
		    @comment "##Sushi"
		    @if v[822] == 12 {
			v[705..706] -= muldiv(v[706], 12, 100)
			
		    }
		    @comment "Artitecture"
		    v[705..706] += v[2409 + spawnSet_Team % 3] & 0x40000 ? muldiv(v[706], 20, 100) : 0
		    v[711] += v[2409 + spawnSet_Team % 3] & 0x40000 ? 50 : 0
		    
		}
		
	    }
	    
	}
	@comment "#classic minions"
	@if v[601] == 1 {
	    v[726] |= 2097152
	    
	}
	@comment "#Weapon Switchable Units"
	@if v[601] == 4 {
	    v[0] = v[Temp2..Temp2 + 5] = [v[602], 0, 0, v[858], v[859], 0]
	    @if v[851] >= 1 {
		@comment "#Have Weapon"
		@if s[154] .isOn() {
		    v[899] = 74
		    
		} .else bl {
		    v[899] = 47
		    
		}
		@if v[852] >= 1 {
		    @comment "#Have Shield"
		    v[899] = 574
		    
		}
		
	    }
	    
	}
	@comment "#User Units"
	@if v[601] == 3 {
	    @comment "Human"
	    @if v[664] == 0 {
		@comment "NOT female"
		@if v[663] != 6 {
		    @comment "temp, beard"
		    @if v[669] >= 3 {
			@if s[159] .isOff() {
			    s[160].on
			    
			}
			
		    }
		    
		}
		
	    }
	    @comment "Goblins"
	    @if v[664] == 1 {
		s[160].on
		s[159].off
		@comment "skin set"
		v[886] = v[886] == 0 ? -1 : v[886]
		
	    }
	    @comment "Orks"
	    @if v[664] == 2 {
		s[160].on
		s[159].off
		
	    }
	    @if v[664] == 5 {
		s[160].on
		s[159].off
		
	    }
	    @if v[664] == 6 {
		s[160].on
		s[159].off
		
	    }
	    @if s[160] .isOn() {
		@comment "Have Big Head"
		v[899] = 321
		@comment "Have acc with picture"
		@if v[889] >= 1 {
		    @comment "#Have Shield"
		    @if v[852] >= 1 {
			v[899] = 563214
			@comment "#Show Hair"
			@if v[888] == 0 {
			    v[899] += 6000
			    v[888] = v[670]
			    
			}
			
		    } .else bl {
			@if s[154] .isOn() {
			    v[899] = 63214
			    @comment "#Show Hair"
			    @if v[888] == 0 {
				v[899] += 6000
				v[888] = v[670]
				
			    }
			    
			} .else bl {
			    v[899] = 46321
			    @comment "#Show Hair"
			    @if v[888] == 0 {
				v[899] += 600
				v[888] = v[670]
				
			    }
			    
			}
			
		    }
		    
		} .else bl {//no acc
		    @comment "#Have Shield"
		    @if v[852] >= 1 {
			v[899] = 53214
			@comment "#Show Hair"
			@if v[888] == 0 {
			    v[899] += 6000
			    v[888] = v[670]
			    
			}
			
		    } .else bl {
			@if s[154] .isOn() {
			    v[899] = 3214
			    @comment "#Show Hair"
			    @if v[888] == 0 {
				v[899] += 6000
				v[888] = v[670]
				
			    }
			    
			} .else bl {
			    v[899] = 4321
			    @comment "#Show Hair"
			    @if v[888] == 0 {
				v[899] += 600
				v[888] = v[670]
				
			    }
			    
			}
			
		    }
		    
		}
		
	    } .else bl {//have no big head
		v[899] = 312
		@comment "Have acc with picture"
		@if v[889] >= 1 {
		    @comment "#Have Shield"
		    @if v[852] >= 1 {
			v[899] = 563124
			@comment "#Show Hair"
			@if v[888] == 0 {
			    v[899] += 6000
			    v[888] = v[670]
			    
			}
			
		    } .else bl { // have space for hair
			@if s[154] .isOn() {
			    v[899] = 63124
			    @comment "#Show Hair"
			    @if v[888] == 0 {
				v[899] += 6000
				v[888] = v[670]
				
			    }
			    
			} .else bl {
			    v[899] = 46312
			    @comment "#Show Hair"
			    @if v[888] == 0 {
				v[899] += 600
				v[888] = v[670]
				
			    }
			    
			}
			
		    }
		    
		} .else bl {
		    @if v[670]>0 {// have hair
			    @comment "#Have Shield"
			    @if v[852] >= 1 {
				v[899] = 539124
				@comment "#no helm"
				@if v[888] == 0 {
				    v[899] = 59124
				    
				}
				
			    } .else bl {
				@if s[154] .isOn() {
				    v[899] = 39124
				    @comment "#Show Hair"
				    @if v[888] == 0 {
				    	v[899] = 9124
					
				    }
				    
				} .else bl {
				    v[899] = 43912
				    @comment "#Show Hair"
				    @if v[888] == 0 {
				    	v[899] = 4912
					
				    }
				    
				}
				
			    }
		    }.else bl{//no hair
			    @comment "#Have Shield"
			    @if v[852] >= 1 {
				v[899] = 53124
				@comment "#No Hair No helm"
				@if v[888] == 0 {
				    v[899] = 5124
				    
				}
				
			    } .else bl {
				@if s[154] .isOn() {
				    v[899] = 3124
				    @comment "#Show Hair"
				    @if v[888] == 0 {
					    v[899] = 124
					
					
				    }
				    
				} .else bl {
				    v[899] = 4312
				    @comment "#Show Hair"
				    @if v[888] == 0 {
				    	v[899] = 412
					
				    }
				    
				}
				
			    }

		    }
		    
		}
		@if s[159] .isOn() {
		    @if s[155] .isOn() {
			reg1 = v[899]
			@if reg1 != 0 {
			    @while reg1 > 0 .dst reg3 {
				reg2 = reg1 % 10
				@if reg2 == 2 {
				    @break
				    
				}
				reg1 /= 10
				
			    }
			    
			    v[725] |= 524288
			    v[899] = v[899] / pow(10, reg3 + 1) * pow(10, reg3) + v[899] % pow(10, reg3)
			    
			}
			
		    }
		    
		}
		
	    }
	    v[0] = v[Temp2..Temp2 + 5] = [v[886], v[887], v[888], v[858], v[859], v[889]]


	    @comment "If Without Weapon"
	    @if v[851] == 0 {
		@comment "nor any AA function"
		@if v[730] == 0 {
		    @comment "#Range Melee"
		    v[717] = 19000
		    @comment "#Range Ranged"
		    v[718] = -999999
		    @comment "#AttackSpeed"
		    v[719] += 50
		    @comment "#AttackMotion"
		    v[720] = 1
		    
		}
		
	    }
	    
	}
	s[154].off
	s[155].off
	s[159].off
	s[160].off
	@comment "having no min range"
	v[718] = v[718] <= 0 ? -999999 : v[718]

	/*
	@comment "#Set SpriteOrder"
	v[0] = v[302..306] = [3, 2, 4, 3, 2]
	@comment "Has move sprite?"
	Temp3 = (v[726] & 2) == 2 ? 5 : Temp3
	Temp3 = (v[726] & 16) == 16 ? 4 : Temp3
	@comment "Skill Moition"
	Temp2 = (v[726] & 4) == 4 ? 5 : 3
	*/

	v[0] = v[302..306] = [2, 3, 4, 2, 3]
	@comment "Has move sprite?"
	Temp5 = (v[726] & 2) == 2 ? 5 : Temp5
	Temp5 = (v[726] & 16) == 16 ? 4 : Temp5
	@comment "Skill Moition"
	Temp6 = (v[726] & 4) == 4 ? 5 : 3
	__if DIS_EXPERIMENTAL == -1 {
		set_AEAB_array(SpawnAgentID,302,AgentExBuffer_SLOT_ActionSprite_1,5)
	}.else bl{
		// sprite order -> save AEBA 
		v[883] = Temp2 * 1 + Temp3 * 10 + Temp4 * 100 + Temp5 * 1000 + Temp6 * 10000
	}
	//ATTENTION
	function_agent_init_set_picture_strs()
	v[886..889] = 0
	@comment "###################	Set New Picture System END###################"
	@if s[1] .isOff() {
	    v[635] = v[258]
	    @comment "#Racial Traits"
	    @comment "##Human"
	    @if v[664] == 0 {
		@comment "###Custom Unit"
		@if v[601] == 3 {
		    @comment "#Crushable head"
		    v[726] |= 64
		    @comment "Crushable"
		    @if `v[726] & 64 {
			@comment "Skull"
			v[726] |= 128
			
		    }
		    
		}
		
	    }
	    @comment "##Dragons"
	    @if v[664] == 3 {
		@comment "#Gain Additional AR"
		v[711] += v[704] * 8
		@comment "#Gain Additional HPreg"
		v[731] += muldiv(v[705], 1, 100)
		
	    }
	    @comment "#Obj Bits"
	    @comment "##If this is SiegeUnit, then flag bleed immunity"
	    agent_BaseObjBit |= agent_UnitType == 5 ? 4096 : 0
	    agent_BaseObjBit |= v[601] == 11 ? 4096 : 0
	    @comment "#Cavalry Penalty"
	    @comment "##Init FootStepSound"
	    v[887] = 0
	    @if agent_UnitType == 2 {
		@comment "#If not flying"
		@if `(v[638] & 1) == 0 {
		    @comment "#Horse Type Move Flag"
		    v[638] |= 2
		    @comment "#Won't get MS penalty from fatigue "
		    agent_BaseObjBit |= 32768
		    @comment "#SP Bonus"
		    v[707..708] += 20
		    @comment "#HIT/AVD Penalty"
		    v[713..714] -= 5
		    @comment "#Melee Range Penalty&Crit Bonus"
		    @if v[703] == 0 {
			v[717] -= 4000
			v[717] = max(19000, v[717])
			v[715] += 1
			
		    }
		    v[610] += 2
		    v[611] += 3
		    @comment "Cant ShieldWall nor PikeWall"
		    agent_BaseObjBit = agent_BaseObjBit & ~6
		    @comment "Big flag"
		    agent_BaseObjBit |= 524288
		    @comment "Difficult to get hit on the head"
		    v[839] += 1
		    @comment "#set FootStepSound horse"
		    v[887] = 1
		    @comment "#Hold weapon"
		    v[726] |= 2097152
		    @comment "#Hold Weapon lock"
		    v[726] |= 8388608
		    @comment "#Horseback"
		    v[726] |= 16777216
		    @comment "#Tech:Husbandry"
		    v[705..706] += v[2409 + spawnSet_Team % 3] & 0x80000 ? 200 : 0
		    
		} .else bl {
		    @comment "#Flying Troops usually treated as Cav"
		    agent_UnitType = agent_UnitType == 0 ? 2 : agent_UnitType
		    
		}
		
	    }
	    @comment "#Siege Weapons"
	    @if agent_UnitType == 5 {
		@comment "no_fatigue"
		v[726] |= 2048
		@comment "immune to stun"
		agent_BaseObjBit |= BaseObjBit_FLAG_Immune_to_stun
		@comment "Big flag"
		agent_BaseObjBit |= 524288
		@comment "No mind"
		agent_BaseObjBit |= BaseObjBit_FLAG_No_mind
		agent_BaseObjBit |= 32
		@comment "do not bleed"
		agent_BaseObjBit |= BaseObjBit_FLAG_Immune_to_bleed
		v[709] += v[2409 + spawnSet_Team % 3] & 0x10000 ? muldiv(v[709], 10, 100) : 0
		@comment "##Sushi"
		@if v[822] == 12 {
		    agent_BaseMS = muldiv(agent_BaseMS, 150, 100)
		    
		}
		
	    }
	    @comment "set Ammo"
	    //v[832] = v[831]
	    @comment "#AS Bonus#[Lv]"
	    v[719] += agent_UnitType < 3 ? v[704] : 0
	    @comment "Crit"
	    v[715] += 1
	    @comment "set least parameter"
	    v[739] = v[739] <= 0 ? v[1164] : v[739]
	    @comment "#Skill AutoCast Lock Check"
	    @if v[601] < 9 {
		@loop 4 .dst v[1941] {
		    v[760 + v[1941] * 20] |= v[744 + v[1941] * 20] == -1 ? 33 : 0
		    
		}
		
		
	    }
	    @comment "############	Camo"
	    @if v[601] < 11 {
		v[617] = 4000
		v[617] -= (agent_BaseObjBit & 524288) > 1 ? 2000 : 0
		@if v[601] == 9 {
		    v[617] += 8000
		    
		}
		
	    } .else bl {
		@if agent_UnitType == 106 {
		    @comment "Turret"
		    v[617] = 10000
		    
		} .else bl {
		    v[617] = agent_UnitType != 107 ? 18000 : 80000
		    @comment "GATE"
		    @if `v[603] & 256 {
			v[617] = 8500
			
		    }
		    
		}
		
	    }
	    @comment "####################EyeSight####################"
	    v[830] = max(v[1019], pow(v[717] / 1000, 2))
	    

	    // Agent eyesight for minimap fow check 

	    @if `between(agent_UnitType, 104, 105) {
		@comment "In sight?"
		v[0] = s[2001 + ptr_SpawnAgentMainSpace_Head] = 1
		
	    }

	    @comment "Civilians have better AI eyesight in order to find basement"
	    @if agent_UnitType == 9 {
		v[830] *= 2
		
	    }

	    
	}
	@comment "############Perks Check############"
	@comment "#SkillCaster"
	@if `(v[666] & 131072) >= 1 {
	    v[748] /= 2
	    v[768] /= 2
	    v[788] /= 2
	    v[808] /= 2
	    
	}
	@comment "#Deffensive perks"
	@comment "#TakenDamageMul"
	v[829] = 100
	@comment "##Nimble #How should I make brawny affect nimble calculation?"
	@if `v[665] & 8 {
	    v[829] = min(100, max(100 - 55 + muldiv(v[838] - 15, 12, 100), 45))
	    @comment "#Nimble"
	    @comment "#Speed Bonus"
	    agent_BaseObjBit |= v[829] == 45 ? 134217728 : 0
	    
	}
	@comment "##Stalwart ###Knockback immunity"
	agent_BaseObjBit |= v[665] & 16 ? 8 : 0
	@comment "#Aggressive perks"
	@comment "############	Perks Check End############"
	@comment "Set Common Exp [Lv]*50"
	v[659] = v[659] <= 0 ? v[1194] * v[704] : v[659]
	@comment "パラメータ等入力end"
	@comment "Set No Passive"
	@comment "Set AR Max"
	v[738] = v[711]
	@comment "Set GenID"
	v[900] = v[154]
	@comment "Set Timer"
	@comment "Set SkipFrame"
	v[625] = 2
	@comment "#AITimer"
	@if v[601] < 10 {
	    @comment "Have minion troop AI"
	    v[684] = v[154] % v[1195]
	    
	} .else bl {
	    @if agent_UnitType == 106 {
		@comment "Turret"
		v[603] |= 1048576
		v[684] = v[154] % v[1195]
		
	    } .else bl {
		@comment "No AI"
		v[684] = 999999999
		
	    }
	    
	}
	@comment "#Set Actual Team #underdev, just save in reg1"
	v[658] = agent_TeamID

	@comment "#PassiveTimer"
	v[694] = v[154] % v[1139]
	@comment "#FootStepTimer"
	v[886] = (v[726] & 1024) == 0 ? agent_BaseMS / 4 + v[684] : 999999999
	//Get Luck(rand)
	v[604]=rnd(0,999)

	@if s[150] .isOff() {
	    @comment "mapxyset"
	    v[605].copy v[626], 2
	    v[626] .add v[1061], 2
	    v[626..627] /= 10000
	    @comment "ずれ計算"
	    v[626] .sub v[403], 2
	    @comment "ずれおわり"
	    v[626..627] /= 16
	    @if s[151] .isOff() {


		// abolished
		vname[4806], "ConstAgentRootSightArrayHead"
		__if DIS_EXPERIMENTAL == -1 { 
			reg2 = sqrt(v[830], 1)
			set_AEAB_element(SpawnAgentID,__id(reg2),AgentExBuffer_SLOT_BaseSight_Root)
		} .else bl {
			v[v[4806] + ptr_SpawnAgentMainSpace_Head] = sqrt(v[830], 1)
		}

		@comment "avoid false data"
		reg1 = -1
		@if v[706] >= 1 {
			//3.11.23
			//initializing agent enemy table to avoid false target
			//using regs as temp var  
			reg1 = v[4579] + (v[1012] + 2) * ptr_SpawnAgentMainSpace_Head
			v[reg1..reg1+(v[1012] + 1)] = 0
			//Then set basic parameter to agent slots
		    v[601].copy v[Ptr20], 300
		    @comment "Collision Counter"
		    v[196] += v[639] != -1 ? 1 : 0
		    @comment "Save ColBox"
		    v[886] = v[4523] + 2 * ptr_SpawnAgentMainSpace_Head
		    @if v[639] == -1 {
			v[1301].copy v[v[886]], 2
			
		    } .else bl {

			//SET ColBox!!!!
			v[610] = muldiv(v[610], 3, 4)
			v[611] = muldiv(v[611], 3, 4)
			v[610].copy v[v[886]], 2

			// Experimental - this might be far faster
			__if DIS_EXPERIMENTAL == -1 {
				set_AEAB_array(SpawnAgentID,610,AgentExBuffer_SLOT_ColBoxWidth,2)
			}
			
		    }
		    @comment "#############Search and remove from body list"
		    reg1 = v[4531]
		    @doWhile v[reg1] > 0 {
			@if `v[reg1] == ptr_SpawnAgentMainSpace_Head + 1 {
			    v[reg1] = 0
			    v[v[4531] + v[1004]] -= 1
			    v[v[4531]].sortDescending v[1004]
			    @break
			    
			}
			reg1 += 1
			
		    }
		    
		    @comment "Set into UnitTypeList"
		    @if v[601] <= 10 {
			v[v[4532] + v[1004] - 1] = ptr_SpawnAgentMainSpace_Head + 1
			v[v[4532] + v[1004]] += 1
			v[v[4532]].sortDescending v[1004]
			v[v[4804] + ptr_SpawnAgentMainSpace_Head] = [(agent_TeamID == 0 ? 0xFF0A3AFF : 0xFFC926C9) - 14671872, -65536 + 8224, 0xFFFBF236][(agent_TeamID % 3)]
			
		    } .else bl {
			v[v[4533] + v[1004] - 1] = ptr_SpawnAgentMainSpace_Head + 1
			v[v[4533] + v[1004]] += 1
			v[v[4533]].sortDescending v[1004]
			@comment "BASEMENT"
			@comment "#temp, this is not made for enemy team "
			@if agent_UnitType == 104 {
			    v[v[4561] + v[1012] - 1] = ptr_SpawnAgentMainSpace_Head + 1
			    v[v[4561] + v[1012]] += 1
			    v[v[4561]].sortDescending v[1012]
			    
			}
			v[v[4804] + ptr_SpawnAgentMainSpace_Head] = [agent_TeamID == 0 ? 0xFF0A3AFF : 0xFFC926C9, -65536, 0xFFD6CD20][(agent_TeamID % 3)]
			
		    }
		


		   // ACHTUNG this will be removed after replace every MetaTeam reference
		   v[Const_AgentMetaTeam_begin + ptr_SpawnAgentMainSpace_Head] = agent_TeamID % 3


		    @comment "敵味方峻別リストに登録"
		    @if s[157] .isOff() {
			   __if DIS_EXPERIMENTAL == -1 {
				    // set MetaTeam in AEAB
				    reg2 = agent_TeamID % 3
				    set_AEAB_element(SpawnAgentID,__id(reg2),AgentExBuffer_SLOT_MetaTeam)
			   }
				 
		    __if DIS_EXPERIMENTAL == -2 { // even if AEAB command bug in MP itself is solved, this part won't return, since the traditional way below (what in else block) is faster
			    // EyeSightForminimaps const =62500
			    reg2 = min(v[830] / 31250, 6)
			    // "#Cavs  have better sight"
			    @if `between(agent_UnitType, 1, 2) {
				reg2 += 1
				
			    }
			    // "towers"
			    @if agent_UnitType == 106 {
				reg2 += 2
				
			    }
			    reg1 -= v[828]
			    // "walls"
			    @if agent_UnitType == 107 {
				reg2 = 1
				
			    }
			    reg2 = max(reg2, 1)
			    // regsiter to AEAB
			    set_AEAB_element(SpawnAgentID,__id(reg2),AgentExBuffer_SLOT_BaseEyeSight)

		    }.else bl { // this is faster
			    @comment "EyeSightForminimaps const =62500"
			    v[v[4528] + ptr_SpawnAgentMainSpace_Head] = min(v[830] / 31250, 6)
			    @comment "#Cavs  have better sight"
			    @if `between(agent_UnitType, 1, 2) {
				v[v[4528] + ptr_SpawnAgentMainSpace_Head] += 1
				
			    }
			    @comment "towers"
			    @if agent_UnitType == 106 {
				v[v[4528] + ptr_SpawnAgentMainSpace_Head] += 2
				
			    }
			    v[v[4528] + ptr_SpawnAgentMainSpace_Head] -= v[828]
			    @comment "walls"
			    @if agent_UnitType == 107 {
				v[v[4528] + ptr_SpawnAgentMainSpace_Head] = 1
				
			    }
			    v[v[4528] + ptr_SpawnAgentMainSpace_Head] = max(v[v[4528] + ptr_SpawnAgentMainSpace_Head], 1)
		    }

			@if v[601] == 11 {
			    @if agent_UnitType != 105 {
				@if agent_UnitType != 104 {
				    v[v[4580] + agent_TeamID % 3] += 1
				    
				}
				
			    }
			    @if `v[603] & 64 {
				v[v[4580] + agent_TeamID % 3] += 6
				@comment "#Potetons"
				@if `v[2403 + agent_TeamID % 3] == 8 {
				    v[v[4580] + agent_TeamID % 3] += 2
				    
				}
				
			    }
			    
			}

			// "##Economy Buildings e.g. farm won't be registered to the team List
			agent_TeamID = agent_UnitType == 104 ? -1 : agent_TeamID
			agent_TeamID = agent_UnitType == 105 ? -2 : agent_TeamID
			agent_TeamID %= 3
			@if agent_TeamID == 0 {
			    @comment "Register Battle ally units list"
			    @comment "Safety"
			    @if v[205] < v[1012] {
				v[v[1145] + v[1012] - 1] = ptr_SpawnAgentMainSpace_Head + 1
				v[v[1145]].sortDescending v[1012]
				v[205] += 1
				@comment "Records"
				@if s[19] .isOff() {
				    v[2522] += agent_UnitType == 9 ? 1 : 0
				    v[2523] += agent_UnitType <= 7 ? 1 : 0
				    
				}
				
			    } .else bl {
				@comment "最大数超過したらなかったことに"
				v[1301].copy v[Ptr20], 300
				
			    }
			    
			} .else bl {
			    @if agent_TeamID == 1 {
				@if v[206] < v[1012] {
				    @comment "敵リストに登録"
				    v[v[1146] + v[1012] - 1] = ptr_SpawnAgentMainSpace_Head + 1
				    v[v[1146]].sortDescending v[1012]
				    v[206] += 1
				    
				} .else bl {
				    @comment "最大数超過したらなかったことに"
				    v[1301].copy v[Ptr20], 300
				    
				}
				
			    } .else bl {
				@comment "中立Obj"
				
			    }
			    
			}
			@comment "Register UnitsID joining battle List"
			@if `between(v[658], 0, 1) && agent_UnitType < 7 {
			    reg1 = v[1259] + 4 * (agent_UnitID - 1) + v[658] * v[1260] * 4
			    v[reg1] += 1
			    
			}
			
			// relocated AEBA
			/*@if v[661] == 0 {
			    @comment "NOT unique unit"
			    
			} .else bl {
			    reg2 = v[reg1]
			    
			}*/
			
		    }
		    v[0] = s[2001 + ptr_SpawnAgentMainSpace_Head] = agent_TeamID % 3 == 2 ? 1 : 0
		    @if Is_SightSystem_On .isOff() {
			v[0] = s[2001 + ptr_SpawnAgentMainSpace_Head] = 1
			
		    } .else bl {
			@comment "Reset sight timer"
			v[v[4518] + ptr_SpawnAgentMainSpace_Head] = 0
			
		    }


			// set agent AI target priority
			def classtypesetend = 4101 + ClassType_Amount
			defv static_target_set = classtypesetend 

			v[4101..classtypesetend] = 100000000
		
			// lower value = more priority

			// siege ram type
			@if `agent_AI_routine_bits & 1 {
				v[4101..classtypesetend] += 700000000
				static_target_set -= 750000000 
				
			}

			@if `agent_AI_routine_bits & 2 {
				v[4102] -= 50000000
				
			}

			@if `agent_AI_routine_bits & 4 {
				v[4105] -= 50000000
			}
		    __if DIS_EXPERIMENTAL == -1 {
            	    	set_AEAB_array(SpawnAgentID,4101,AgentExBuffer_SLOT_Class_Target_Priority_Array,ClassType_Amount)
		    }


		    ptr_SpawnAgentMainSpace_Head += 1
		    reg1 = ptr_SpawnAgentMainSpace_Head
				gl_lastSpawnedAgent = reg1
		    reg2 = agent_UnitID
		    reg3 = agent_UnitType
		    @if s[19] .isOff() {
			@if agent_TeamID == 0 {
			    @if v[601] < 11 {
				@if v[2218] <= 2 {
				    @call .cev 1924
				    TT1 = 2
				    v[601] = 1
				    @pic[v[1155]].strpic {
					t[20243]
					.pos TT1, v[1126] .bottomLeft
					.size 0, 0                                .chromakey 1
					.scale 100
					.trans 30
					.rgbs 100, 100, 100, 100
					.font Font_UI, Font_UI_size
					.spacing 0, 4
					.skin "" .nobg .noframe .noPadding
					.mapLayer 8
					.eraseWhenTransfer
					.affectedByFlash
					.affectedByShake
				    }
				    @call .cev 1925
				    
				}
				@if `v[205] >= min(v[1080], v[v[4580]]) {
				    @if agent_UnitType < 100 {
					@call .cev 1924
					TT1 = 2
					v[601] = 1
					agent_UnitID = v[agent_TeamID + 1]
					str1 .asg t[Ptr20]
					TT2 = v[agent_TeamID] == 1 ? 5 : 10
					@pic[v[1155]].strpic {
					    "\c[17]\t[20195]"
					    .pos TT1, v[1126] .bottomLeft
					    .size 0, 0                                    .chromakey 1
					    .scale 100
					    .trans 30
					    .rgbs 100, 100, 100, 100
					    .font Font_UI, Font_UI_size
					    .spacing 0, 4
					    .skin "" .nobg .noframe .noPadding
					    .mapLayer 8
					    .eraseWhenTransfer
					    .affectedByFlash
					    .affectedByShake
					}
					@call .cev 1925
					v[472] = divmul(100, 100, v[2216])
					@se.play "ui\UI_Quirky4" .opt v[472], 100, 50
					
				    }
				    
				}
				
			    } .else bl {
				@if v[2218] <= 2 {
				    @if v[602] != 104 {
					@call .cev 1924
					TT1 = 2
					v[601] = 1
					@pic[v[1155]].strpic {
					    t[20244]
					    .pos TT1, v[1126] .bottomLeft
					    .size 0, 0                                    .chromakey 1
					    .scale 100
					    .trans 30
					    .rgbs 100, 100, 100, 100
					    .font Font_UI, Font_UI_size
					    .spacing 0, 4
					    .skin "" .nobg .noframe .noPadding
					    .mapLayer 8
					    .eraseWhenTransfer
					    .affectedByFlash
					    .affectedByShake
					}
					@call .cev 1925
					
				    }
				    
				}
				
			    }
			    @if s[117] .isOn() {
				@call .cev 84
				
			    }
			    
			}
			
		    }
		    @comment "Avoid PictID0 Bug"
		    s[80].off
		    @comment "Pict set"
		    v[154] += 1
		    
		}
		
	    }
	    v[258] = 0
	    
	} .else bl {
	    ptr_SpawnAgentMainSpace_Head = 0
	    
	}
	s[157].off

}


// Legacy cev 301
__fn GenAgent_BaseStatsPerk {

	@comment "#SecondWind"
	v[732] += (v[Temp2 + 8] & 1024) == 1024 ? 2 : 0
	@comment "#IronFresh"
	v[706] += (v[Temp2 + 8] & 512) == 512 ? divmul(v[705], 100, 25) : 0
	v[705] += (v[Temp2 + 8] & 512) == 512 ? divmul(v[705], 100, 25) : 0
	@comment "#SteelWill"
	v[739] += (v[Temp2 + 8] & 2048) > 0 ? divmul(v[739], 100, 25) : 0
	@comment "#Battlemage"
	v[710] += (v[Temp2 + 8] & 4096) > 0 ? 20 : 0
	@comment "#Warmage"
	v[710] += (v[Temp2 + 8] & 16384) > 0 ? 40 : 0
	@comment "#MageBlaster"
	v[712] += (v[Temp2 + 8] & 8192) > 0 ? 50 : 0
}

//legacy cev 302
__fn GenAgent_PerksAndObjBits {

	@comment "#RockHead"
	@if `(v[Temp2 + 8] & 65536) > 0 {
			v[839] += 1
			v[840] += 85
			
	}
	@comment "###Strider"
	v[724] |= (v[Temp2 + 6] & 8192) == 8192 ? 32768 : 0
	@comment "Stalwart"
	v[740] |= (v[Temp2 + 6] & 16) >= 16 ? 8 : 0
	@comment "Fearsome"
	v[740] |= (v[Temp2 + 6] & 256) >= 256 ? 16384 : 0
	@comment "##Horse"
	@if v[702] == 2 {
			@comment "###Logistica"
			v[724] |= (v[Temp2 + 8] & 262144) == 262144 ? 4096 : 0
			
	}
	@comment "##EXTRA PERKS"
	@comment "###BattleMaster"
	v[740] |= (v[Temp2 + 8] & 1) == 1 ? 128 : 0
	@comment "###Determination"
	v[740] |= (v[Temp2 + 8] & 2) == 2 ? 256 : 0
	@comment "###Devastating Strikes"
	v[724] |= (v[Temp2 + 8] & 4) == 4 ? 2048 : 0
	@comment "#MageBlaster"
	v[724] |= (v[Temp2 + 8] & 8192) > 0 ? 8 : 0
	@comment "#Unstoppable"
	v[740] |= v[Temp2 + 8] & 32768 ? 65536 : 0
	@comment "#Bannerlord"
	v[823] |= v[Temp2 + 6] & 16384 ? 4 : 0
}


// legacy cev 303
__fn GenAgent_Horse_Setting {

	@if v[702] == 2 {
			@comment "#Not flying"
			@if v[638] != 1 {
					@comment "##Riding Perks"
					@comment "###MountainBlade"
					@if `(v[Temp2 + 8] & 64) == 0 {
							v[836] = muldiv(v[836], 88, 100)
							v[714] = muldiv(v[714], 92, 100)
							
					} .else bl {
							@comment "#Speed Bonus"
							v[740] |= 134217728
							
					}
					@comment "###HorseArchery"
					@if `(v[Temp2 + 8] & 128) == 0 {
							v[837] /= 2
							
					} .else bl {
							v[837] -= 5
							
					}
					@comment "###Parthian Shot"
					@if `(v[Temp2 + 8] & 256) == 0 {
							@if s[211] .isOn() {
									@comment "AS penalty"
									v[719] -= 6
									@comment "Motion penalty"
									v[720] += 2
									@comment "Cannot Skirmish"
									v[740] &= ~16
									
							}
							
					} .else bl {
							
					}
					@if v[601] == 3 {
							@comment "Sprite Offset Y"
							v[882] -= 9
							
					}
					
			}
			
	}

}


// leg cev 1928 - not replaced with meta func yet
__fn GenAgent_Perk_WeaponMastery {
	v[1942] = v[1901] % 100
	v[1943] = 8 * pow(2, v[1942])
	v[1941] = v[666] & v[1943]
	@if v[1941] >= 1 {
			@comment "Crit+1%"
			v[1906] += 1
			@comment "AS+10%"
			v[1910] = muldiv(v[1910], 11, 10)
			@comment "Cost-20%"
			v[1912] = muldiv(v[1912], 8, 10)
			@comment "#Dagger"
			@if v[1943] == 1024 {
					@comment "AS+50%"
					v[1910] = muldiv(v[1910], 150, 100)
					
			}
			@comment "#Throw"
			@if v[1943] == 2048 {
					@comment "AD+25%"
					v[1902] = muldiv(v[1902], 125, 100)
					
			}
			@comment "#Bow"
			@if v[1943] == 16384 {
					@comment "Range+35000"
					v[1908] += 35000
					
			}
			@comment "#Crossbow"
			@if v[1943] == 32768 {
					@comment "Pen+25%"
					v[1904] += 25
					
			}
			
	}
}


// cev_2160
// make wall to be built fit to the map pathfinding node system
__fn generateWall_preparation $begX $begY $endX $endY $team {
	t[__id($begX)] .toNum TT11
	t[__id($begY)] .toNum TT12
	t[__id($endX)] .toNum TT13
	t[__id($endY)] .toNum TT14
	TT11.copy TT1, 2
	TT11 += Map_LimitCoordX_min % 2
	TT12 += Map_LimitCoordY_min % 2
	TT13 += Map_LimitCoordX_min % 2
	TT14 += Map_LimitCoordY_min % 2
	v[351..354] /= 2
	v[351..354] *= 2
	TT15 = (TT11 + TT13 + Map_LimitCoordX_min % 2) / 2
	TT16 = (TT12 + TT14 + Map_LimitCoordY_min % 2) / 2
	@call .cev 2001
	reg2.copy spawnSet_x, 2
	TT13.copy TT1, 2
	@call .cev 2001
	v[11..12] = 0
	var1 .add TT11, 2
	var1 .sub TT13, 2
	v[11..12] *= 16
	@if var1 == var2 {
			var1 *= 2
			var2 *= 2
			
	} .else bl {
			@if var1 > var2 {
					var1 *= 2
					
			} .else bl {
					var2 *= 2
					
			}
			
	}
	var1 = abs(var1)
	var2 = abs(var2)
	v[11..12] += 16
	v[11..12] += 16
	TT15.copy TT1, 2
	@call .cev 2001
	reg2 += 8 - 16 * (Map_LimitCoordX_min % 2)
	reg3 += 8 - 16 * (Map_LimitCoordY_min % 2)
	reg2.copy spawnSet_x, 2
	t[__id($team)] .toNum spawnSet_Team

}

