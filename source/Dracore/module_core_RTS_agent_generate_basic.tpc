defv SpawnAgentID = 537

//get drawing functions

__if LOAD_HEADER_DRAW != 1 {
	YOU_MUST_INCLUDE_DRAWING_HEADER // Since behavior of TPC #include directive is SHIT, you must manually #include header_drawing.tpc whenever you use these functions  
}

// temp korehido
struct("weapon",{
		defv  {
		weapon_Ammo = 1920
		}
		})


__fn func_get_troopinfo_from_csv $int_trpid {
		v[1941] = Const_save_var_Adrt_TroopDatabaseHEAD + int_trpid
		// load csv line to CSVELM_AGENT_id
		CSVELM_AGENT_id .asg t[v[1941]]
		CSVELM_AGENT_id .split ",", CSVELM_AGENT_id, v[1941] // deploy to CSVELM buffer
}

__fn func_generate_agent {
	@if `s[152] == 0 && v[254] < 80 {
		//legacy common event call spawn
		@call .cev v[254]

	} .elif v[254] > 0 {


		str3 .asg ""
			str5 .asg t[20034]
			// "Load"
			v[1942] = v[254]
			v[1942] -= s[152] == 0 ? 200 : 0
			v[1941] = v[1215] + v[1942]
			// load csv line to CSVELM_AGENT_id
			CSVELM_AGENT_id .asg t[v[1941]]
			CSVELM_AGENT_id .split ",", CSVELM_AGENT_id, v[1941]
			str3 .asg CSVELM_AGENT_name
			@if spawnSet_Team == 0 {
				@if v[258] == 0 {
					CSVELM_AGENT_agentDefaultGrp .toNum v[258]

				}
			}

			str5 .asg CSVELM_AGENT_agentDefaultGrp
			t[2999..3000] .asg ""
			str1 .asg str3
			
			get_troop_cost_infomation_after_deployment_to_str()

			@if str3 .neq "" {
				@if s[151] .isOff() {
					@if v[204] < v[1004] {
						increment_var(v[204]) // v[204] += 1
							@loop v[1004] .dst Temp20 {
								ptr_SpawnAgentMainSpace_Head %= v[1004]
									Temp1 = ptr_SpawnAgentMainSpace_Head * 300 
									Temp1 += 5000
									Ptr20 = Temp1 + 1
									@if v[Ptr20] <= 0 {
										// "##################Init start"
										// "まず清掃"
										v[1301].copy agent_ObjectType, 300
											v[1301].copy v[Ptr20], 300

											// clear all file string buffers
											t[__id(Str_slot_armorfile)..__id(Str_slot_subsetL)].asg "" // init weapon file buffers

											// "ORDER SET"
											agent_StanceOrder = v[277]

											// "チームセット"
											agent_TeamID = spawnSet_Team
											v[624] = between(agent_TeamID, 0, 2) ? agent_TeamID + 1 : 3

											// "WP消しておく"
											agent_LeftWPtoChase = -1

											// "出る場所セット"
											spawnSet_x.copy agent_MilPixX, 2

											// "生成場所の数値を入れる"
											agent_MilPixX.copy agent_RelativeX, 2
											agent_MilPixX.copy agent_HoldPointX, 2
											v[310..311] = 10000
											agent_MilPixX .mul Temp10, 2

											// "Init end##################"

											agent_UnitID = v[254]
											agent_UnitID -= s[152] == 0 ? 200 : 0

											// "ObjTyp"
											CSVELM_AGENT_agentType .toNum agent_ObjectType
											
											// "#SpriteSet"
											agentgen_sprite_setting()

											// "###"
											agentgen_race_and_skin_setting()

											@call .cev 309 // ???

											// "Hit Box"
											CSVELM_AGENT_size_0 .toNum agent_Width
											CSVELM_AGENT_size_1 .toNum agent_Height

											// "#Passive"

											// set culture
											CSVELM_AGENT_faction .toNum agent_Culture
											@if agent_Culture == 0 { // if the agent has no culture
												// then set player faction as its culture
												func_get_player_faction_to_r1(agent_TeamID) 
												val_asg(agent_Culture,reg1)

											}


											CSVELM_AGENT_passiveId .toNum agent_Passive_Text

											// "#Simplification #Unit Type to MS Add"
											@loop 13 .dst v[1941] {
												v[1942] = 3009 + v[1941]
													v[1943] = 1901 + v[1941]
													t[v[1942]] .toNum v[1944]
													v[v[1943]] = v[1944]

											}


										// wtf
										v[0] = v[702..716] += [v[1901], 0, v[1902], v[1903], v[1903], v[1904], v[1904], v[1905], v[1906], v[1907], v[1908], v[1909], v[1910], v[1911], v[1912]]
											// "##WILL"
											agent_BaseWill += v[1913]
											// "#HP/SPreg set"
											CSVELM_AGENT_Hpreg .toNum v[1941]
											agent_BaseRegHP = v[1941] != 0 ? v[1941] : agent_BaseRegHP
											CSVELM_AGENT_Spreg .toNum v[1941]
											v[732] = v[1941] != 0 ? v[1941] : v[732]

											// "#Movetype flag set" <- this needs to be changed into flag type
											CSVELM_AGENT_MoveTypeBits .toNum agent_MoveTypeBIts

											// "#Skills"
											get_skill_FunctionCallID_to_v(CSVELM_AGENT_ActiveSkill_0,v[741])
											get_skill_FunctionCallID_to_v(CSVELM_AGENT_ActiveSkill_1,v[761])
											get_skill_FunctionCallID_to_v(CSVELM_AGENT_ActiveSkill_2,v[781])
											get_skill_FunctionCallID_to_v(CSVELM_AGENT_ActiveSkill_3,v[801])

											// "#Passive"
											CSVELM_AGENT_PassiveSkill .toNum v[824]
											@if v[824] >= v[1186] {
												s[118].on
													@call .cev v[824]
													s[118].off

											}

										// "#SetPerks"
										v[4101..4120] = 0
											Temp2 = 4101 - 6

											// "#Perks1"
											@loop 4 .dst v[1950] {
												v[v[1216]..v[1216] + 100] = 0
													v[1949] = v[1950] + 3041
													t[v[1949]] .split "|", t[3200], v[1941]
													@loop v[1941] .dst v[1945] {
														v[1942] = 3200 + v[1945]
															v[1943] = v[1216] + v[1945]
															t[v[1942]] .toNum v[1944]
															v[v[1943]] = v[1944]

													}

												@loop v[1941] .dst v[1945] {
													v[1943] = v[1216] + v[1945]
														v[4101 + v[1950]] |= pow(2, v[v[1943]] - 1)

												}


											}

											agent_PerkFlagBits1 = v[Temp2 + 6]
											agent_PerkFlagBits2 = v[Temp2 + 7]
											// "##########Extra########"
											CSVELM_AGENT_ExtraSettingEv .toNum v[1944]
											@if v[1944] > 200 {
												@call .cev v[1944]

											}

											//@call .cev 301
											GenAgent_BaseStatsPerk()
											// "###################Equipment Begin###################"

											// "#wea"
											@if agent_MainWeaponID == 0 {
												v[v[1216]..v[1216] + 100] = 0
													t[3200..3300] .asg ""
													CSVELM_AGENT_MainWeapon .split "|", t[3200], v[1941]
													@loop v[1941] .dst v[1945] {
														v[1942] = 3200 + v[1945]
															v[1943] = v[1216] + v[1945]
															t[v[1942]] .toNum v[1944]
															v[v[1943]] = v[1944]

													}

												agent_MainWeaponID = v[v[1216] + rnd(0, v[1941] - 1)]

											}
										// "#Shield"
										@if agent_MainShieldID == 0 {
											v[v[1216]..v[1216] + 100] = 0
												t[3200..3300] .asg ""
												CSVELM_AGENT_Shield .split "|", t[3200], v[1941]
												@loop v[1941] .dst v[1945] {
													v[1942] = 3200 + v[1945]
														v[1943] = v[1216] + v[1945]
														t[v[1942]] .toNum v[1944]
														v[v[1943]] = v[1944]

												}

											agent_MainShieldID = v[v[1216] + rnd(0, v[1941] - 1)]

										}
										@if agent_ArmorID == 0 {
											// "#Armor"
											v[v[1216]..v[1216] + 100] = 0
												t[3200..3300] .asg ""
												CSVELM_AGENT_Armor .split "|", t[3200], v[1941]
												@loop v[1941] .dst v[1945] {
													v[1942] = 3200 + v[1945]
														v[1943] = v[1216] + v[1945]
														t[v[1942]] .toNum v[1944]
														v[v[1943]] = v[1944]

												}

											agent_ArmorID = v[v[1216] + rnd(0, v[1941] - 1)]

										}
										// "#Helm"
										@if agent_HelmID == 0 {
											v[v[1216]..v[1216] + 100] = 0
												t[3200..3300] .asg ""
												CSVELM_AGENT_Helmet .split "|", t[3200], v[1941]
												@loop v[1941] .dst v[1945] {
													v[1942] = 3200 + v[1945]
														v[1943] = v[1216] + v[1945]
														t[v[1942]] .toNum v[1944]
														v[v[1943]] = v[1944]

												}

											agent_HelmID = v[v[1216] + rnd(0, v[1941] - 1)]

										}
										// "#Acc"
										@if agent_AccID == 0 {
											v[v[1216]..v[1216] + 100] = 0
												t[3200..3300] .asg ""
												CSVELM_AGENT_Accessory .split "|", t[3200], v[1941]
												@loop v[1941] .dst v[1945] {
													v[1942] = 3200 + v[1945]
														v[1943] = v[1216] + v[1945]
														t[v[1942]] .toNum v[1944]
														v[v[1943]] = v[1944]

												}

											agent_AccID = v[v[1216] + rnd(0, v[1941] - 1)]

										}
										// "#res1"
										@if agent_ReserveWeaponID == 0 {
											v[v[1216]..v[1216] + 100] = 0
												t[3200..3300] .asg ""
												CSVELM_AGENT_SubWeapon .split "|", t[3200], v[1941]
												@loop v[1941] .dst v[1945] {
													v[1942] = 3200 + v[1945]
														v[1943] = v[1216] + v[1945]
														t[v[1942]] .toNum v[1944]
														v[v[1943]] = v[1944]

												}

											agent_ReserveWeaponID = v[v[1216] + rnd(0, v[1941] - 1)]

										}
										// "#res2"
										@if agent_ReserveShieldID == 0 {
											v[v[1216]..v[1216] + 100] = 0
												t[3200..3300] .asg ""
												CSVELM_AGENT_ReserveSetL .split "|", t[3200], v[1941]
												@loop v[1941] .dst v[1945] {
													v[1942] = 3200 + v[1945]
														v[1943] = v[1216] + v[1945]
														t[v[1942]] .toNum v[1944]
														v[v[1943]] = v[1944]

												}

											agent_ReserveShieldID = v[v[1216] + rnd(0, v[1941] - 1)]

										}


											// "#Get Variations"
											CSVELM_AGENT_WEPvariations .toNum v[4001]
											CSVELM_AGENT_SHDvariations .toNum v[4002]
											CSVELM_AGENT_AMRvariations .toNum v[4003]
											CSVELM_AGENT_HELvariations .toNum v[4004]
											CSVELM_AGENT_ACCvariations .toNum v[4005]

											// "#Set Equipments Parameter"
											//Check reserve ammo first
											@if agent_ReserveWeaponID > 0 {
													var1 = agent_ReserveWeaponID
													var2 = 0
													@call .cev v[1150]
													Str_slot_subsetR.asg Str_slot_weaponfile
													Str_slot_weaponfile.asg ""

													func_convert_weapon_ammo_into_four_byte_ammo_data(weapon_Ammo)
													agent_Ammo = reg1 << 16
													macro_set_agent_AI_decision_Sub_WEP_Type(v[1907]) // set subset
													// also...
													agent_AI_decision_bits |= AI_decision_bits_FLAG_Have_reserve_set
													
											}.else bl{
												agent_Ammo = 0
											}

										//Set Weapon
										var1 = agent_MainWeaponID
											var2 = v[4001]
											@call .cev v[1150]
											@call .cev 1923
											@if var1 <= 0 { Str_slot_weaponfile.cat "0" }
										Str_slot_mainsetR.asg Str_slot_weaponfile
											Str_slot_weaponfile.asg ""

											//Main weapon ammo Set!
											//if v[1920] == 0, just ignore.
											func_convert_weapon_ammo_into_four_byte_ammo_data(weapon_Ammo)
											agent_Ammo += reg1


											@if v[1901] < 100 {
												var1 = agent_MainShieldID
													var2 = v[4002]
													@call .cev v[1151]
													@call .cev 1923
													Str_slot_mainsetL.asg Str_slot_weaponfile
													Str_slot_weaponfile.asg ""

											} .else bl {
												Str_slot_mainsetL.asg ""
													agent_Formbits = agent_HorseID
													agent_MainShieldID = 0

											}

										var1 = agent_ArmorID
											var2 = v[4003]
											@call .cev v[1152]
											@call .cev 1923
											var1 = agent_HelmID
											var2 = v[4004]
											@call .cev v[1153]
											@call .cev 1923
											var1 = agent_AccID
											var2 = v[4005]
											@call .cev v[1154]
											@call .cev 1923
											// "###################Equipment End###################"


											agentgen_extra_AA_setting()


											// "##AI Flag"
											v[v[1216]..v[1216] + 100] = 0
											CSVELM_AGENT_AIFlag .split "|", t[3200], v[1941]
											@loop v[1941] .dst v[1945] {
												v[1942] = 3200 + v[1945]
													v[1943] = v[1216] + v[1945]
													t[v[1942]] .toNum v[1944]
													v[v[1943]] = v[1944]

											}


										@loop v[1941] .dst v[1945] {
											v[1943] = v[1216] + v[1945]
												agent_AI_routine_bits |= pow(2, v[v[1943]] - 1)

										}

										// "##Skills"
										agentgen_register_skill_to_slot(v[741],0)
										agentgen_register_skill_to_slot(v[761],1)
										agentgen_register_skill_to_slot(v[781],2)
										agentgen_register_skill_to_slot(v[801],3)




											// "#Obj Bits"
											// @call .cev 302
											GenAgent_PerksAndObjBits()
											v[v[1216]..v[1216] + 100] = 0
											t[3200..3300] .asg ""
											CSVELM_AGENT_objFlags .split "|", t[3200], v[1941]
											@loop v[1941] .dst v[1945] {
												v[1942] = 3200 + v[1945]
													v[1943] = v[1216] + v[1945]
													t[v[1942]] .toNum v[1944]
													v[v[1943]] = v[1944]

											}

										@loop v[1941] .dst v[1945] {
											v[1943] = v[1216] + v[1945]
												agent_BaseObjBit |= pow(2, v[v[1943]] - 1)

										}

										// "#AA Bits"
										v[v[1216]..v[1216] + 100] = 0
											t[3200..3300] .asg ""
											CSVELM_AGENT_AABits .split "|", t[3200], v[1941]
											@loop v[1941] .dst v[1945] {
												v[1942] = 3200 + v[1945]
													v[1943] = v[1216] + v[1945]
													t[v[1942]] .toNum v[1944]
													v[v[1943]] = v[1944]

											}

										@loop v[1941] .dst v[1945] {
											v[1943] = v[1216] + v[1945]
												agent_AABits |= pow(2, v[v[1943]] - 1)

										}

										// "Motion"
										v[v[1216]..v[1216] + 100] = 0
											t[3200..3300] .asg ""
											CSVELM_AGENT_motionFlags .split "|", t[3200], v[1941]
											@loop v[1941] .dst v[1945] {
												v[1942] = 3200 + v[1945]
													v[1943] = v[1216] + v[1945]
													t[v[1942]] .toNum v[1944]
													v[v[1943]] = v[1944]

											}

										@loop v[1941] .dst v[1945] {
											v[1943] = v[1216] + v[1945]
												agent_ExMotionFlags |= pow(2, v[v[1943]] - 1)

										}

											// "Horse"
											Temp2 = 4101 - 6
											//@call .cev 303
											GenAgent_Horse_Setting()





											// "dir"
											agent_Direction = v[280]
											// "DEBUG"
											@if agent_TeamID == 0 {
												@if s[19] .isOff() {
													@if s[319] .isOn() {
														@if s[477] .isOff() {
															@if agent_TeamID == 0 {
																// "Elf"
																@if agent_UnitID == 23 {
																	// "＃＃＃＃＃＃＃＃＃＃＃＃"
																	v[229] = 34
																		s[240].on
																		// "＃＃＃＃＃＃＃＃＃＃＃＃"

																}
																@if agent_UnitID == 159 {
																	// "＃＃＃＃＃＃＃＃＃＃＃＃"
																	v[229] = 35
																		s[240].on
																		// "＃＃＃＃＃＃＃＃＃＃＃＃"

																}

															}

														}

													}
													@if CSVELM_AGENT_spawnsound .eq "" {
														CSVELM_AGENT_spawnsound .asg "sword1"
															@if agent_UnitType == 1 {
																CSVELM_AGENT_spawnsound .asg "barrier1"

															}
														@if agent_UnitType == 2 {
															CSVELM_AGENT_spawnsound .asg "horse"

														}
														@if agent_UnitType == 4 {
															CSVELM_AGENT_spawnsound .asg "magic2"

														}
														@if agent_UnitType == 5 {
															CSVELM_AGENT_spawnsound .asg "earth4"

														}

													}

													v[472] = divmul(70, 100, v[2216])
														@se.play CSVELM_AGENT_spawnsound .opt v[472], 100, 50

												}

											}
										@call .cev 1903
											@break

									}
								@if Temp20 >= v[1004] {
									// "Obj多すぎ"
									@break

								}
								ptr_SpawnAgentMainSpace_Head += 1

							}


					}

				} .else bl {
					CSVELM_AGENT_ex_spawn_cev .toNum v[35]
						@if v[35] > 200 {
							@call .cev v[35]

						}

				}

			} .else bl {
				str3 .asg "UNDEFINED"
				@if .testPlay() {
					func_errlog("The troop attempted to be spawned is UNDEFINED.")
				}

			}

	}
	s[152].off

}

/**
 *
 * if given skill id is below 0, get string database to set it.
 * otherwise just call cev to set skill as usual
 * {var} $id
 *
 */
__fn agentgen_register_skill_to_slot $id $slot {
	// set ptr
	$ptr_to_agent_skl_slot = $slot 
	$ptr_to_agent_skl_slot *= 20
	$ptr_to_agent_skl_slot += 741

	v[ptr_null].copy v[581],20 // erase buffer
	@if v[__id($id)] >= v[1186] { // preset
		// classic proc
		s[118].on
		@call .cev $id
		s[118].off
		v[581].copy v[$ptr_to_agent_skl_slot],20
	
	}.elif v[__id($id)] < 0 { // custom
		// get data from string database
		// underconstruction
		deblog("agentgen_register_skill_to_slot() in module_core_RTS_agent_generate_basic.tpc is underconstruction.")

	}.elif v[__id($id)] != 0 { // error
		__if DEBUG_BUILD == 1 {
			@if v[__id($id)] != 17 { // if not preset construction
				errlog("Irregular common event called in agent skill registoration.")
					errlog($id)
			}
		}
	}
	
}


__fn agentgen_sprite_setting {

	v[1301].copy v[v[1216]], 100

		// set minion sprite
		t[3200..3300] .asg ""
		@if agent_ObjectType != 3 {
			deploy_DIStable(CSVELM_AGENT_agentSprite)
				var1 = 3201 + rnd(0,reg3 - 1)
				checkItemPicFileName(var1,Str_slot_minionfile,Const_str_minion)
				// this is needed more or less 
				t[var1].toNum agent_PicID

		}.else bl{
			// kore iru?
			@loop v[1941] .dst v[1945] {
				v[1942] = 3200 + v[1945]
					v[1943] = v[1216] + v[1945]
					t[v[1942]] .toNum v[1944]
					v[v[1943]] = v[1944]

			}
			agent_PicID = v[v[1216] + rnd(0, v[1941] - 1)]

		}
	// set sprite offsets
		CSVELM_AGENT_spriteOffset_x .toNum agent_InitialOffsetX
		CSVELM_AGENT_spriteOffset_y .toNum agent_InitialOffsetY
}

__fn agentgen_race_and_skin_setting {
	// "###"
	CSVELM_AGENT_race .toNum agent_Race

		@if CSVELM_AGENT_skin.contains "SKIN_" { // has SKIN prefix
			// load skin data from js database
				inputstr.asg .cat("DATA.SKIN.ptrs[skinid.convert('", CSVELM_AGENT_skin, "')].sendSkinData(887);")
				eval_js(inputstr)
				

		}.else bl{

			// skin pattern
			CSVELM_AGENT_skin .toNum v[1941]

				// "SkinSet"
				@if v[1941] >= 1 {
					@call .cev v[1941]

				} .else bl { // no skin setting 
					// "Hair and Face"
					// "#Skin"
					agent_Skin = 0
						// "#Head"
						agent_HeadID = 0
						agent_FootstepSoundType = agent_HeadID + agent_Skin * 1000000
						agent_FootstepSoundType += agent_Skin != -1 ? agent_Race * 10000000 : 0
						// "#Hair"
						agent_GENERATION_Hair = 0



				}
		}
}


__fn agentgen_extra_AA_setting {
	// "########################################################"
	// "##AA Function"
	// "#ExtraAA Setting"
	// "##Range Max/Min"
		CSVELM_AGENT_AArangeMax .toNum v[1941]
		agent_BaseRange_max = v[1941] != 0 ? v[1941] : agent_BaseRange_max
		CSVELM_AGENT_AArangeMin .toNum v[1941]
		agent_BaseRange_min = v[1941] != 0 ? v[1941] : agent_BaseRange_min
		// "#AS set"
		CSVELM_AGENT_AS .toNum v[1941]
		agent_BaseAS = v[1941] != 0 ? v[1941] : agent_BaseAS
		CSVELM_AGENT_AAfunction .toNum v[1941]
		agent_AAFunction = v[1941] != 0 ? v[1941] : agent_AAFunction


		// "##Without Weapon, change AA type into Function"
		@if `agent_MainWeaponID <= 0 && v[1941] > 0 {
			agent_AAType = 4

		}

	// "##AA Reserve"
	CSVELM_AGENT_reserve .toNum v[1941]
		agent_AAamount = v[1941] != 0 ? v[1941] : agent_AAamount
		// "##Attack Time"
		CSVELM_AGENT_AtkTime .toNum v[1941]
		agent_AAtime = v[1941] != 0 ? v[1941] : agent_AAtime

		// "##Motion"
		CSVELM_AGENT_AAmotiontime .toNum v[1941]
		agent_AAMotion = v[1941] != 0 ? v[1941] : agent_AAMotion
		// "##AACost"
		CSVELM_AGENT_AAcost .toNum v[1941]
		agent_AACost = v[1941] != 0 ? v[1941] : agent_AACost
		// "##Eff"
		CSVELM_AGENT_AAarmorEff .toNum v[1941]
		agent_AA_AR_effectiveness = v[1941] != 0 ? v[1941] : agent_AA_AR_effectiveness
		// "##Pen"
		CSVELM_AGENT_AAarmorPen .toNum v[1941]
		agent_AA_AR_penetration = v[1941] != 0 ? v[1941] : agent_AA_AR_penetration

		// "########################################################"
}



//cev .id(1903), .name("Agent:Spawn Finish"), {
__fn func_generate_agent_finish_set {
	SpawnAgentID = ptr_SpawnAgentMainSpace_Head + 1 //

	@if BOOL_Gen_GetMinionData.isOff() {
		init_AEB_array(SpawnAgentID)
			reg2 = 4701
			reg2 += SpawnAgentID * 300 
			set_AEB_element(SpawnAgentID,__id(reg2),AgentExBuffer_SLOT_Ptr_To_BasicArray) // really

	}
	@comment "#reg1 = ObjID #reg2 = UnitID #reg3 = UnitType"
		@comment "Set Dir"
		agent_MarchingDirection = v[280] * 180000
		@comment "Stop Morale System below hard mode"
		@if `(s[7] == 1 || s[474] == 1) && v[2401] < 3 || s[470] == 1 {
			agent_BaseObjBit |= BaseObjBit_FLAG_No_mind

		} .else bl {
			@if s[7] .isOn() {
				@if agent_TeamID == 1 {
					agent_BaseWill += 8

				}

			}

		}

	// NOT STATIC
	@if agent_ObjectType < 11 {
		v[752] = v[752] == 0 ? -1 : v[752]
			v[772] = v[772] == 0 ? -1 : v[772]
			v[792] = v[792] == 0 ? -1 : v[792]
			v[812] = v[812] == 0 ? -1 : v[812]
			agent_ExMotionFlags |= 524288

		@comment "If Without Weapon"
		@if agent_MainWeaponID == 0 {
			@comment "nor any AA function"
				@if agent_AAFunction == 0 {
					// not a siege weapon
					@if agent_UnitType != 5 {
					@comment "#Range Melee"
						agent_BaseRange_max = 19000
						@comment "#Range Ranged"
						agent_BaseRange_min = -999999
						@comment "#AttackSpeed"
						agent_BaseAS += 50
						@comment "#AttackMotion"
						agent_AAMotion = 1
					}

				}

		}
	// STATIC
	} .else bl {
		agent_static_set_adjustments_for_finish_set()
	}

	@comment "Enabling Skill AI"
		@if agent_ObjectType <= 8 { // land type mil agent
			@comment "standard bearer"
				agent_Passive_Type_Flag |= agent_BaseObjBit & BaseObjBit_FLAG_Standard_Bearer ? 4 : 0
				@comment "Access19 = Obj's Behavior Access20 = Obj's target ID"
				@if agent_UnitType <= 7 {
					agent_AgentBits |= [1048576, 1048576, 0, 1048576, 0][agent_StanceOrder]
						@if `v[752] > -1 || v[772] > -1 || v[792] > -1 || v[812] > -1 {
							agent_AgentBits |= 524288

						}

				}
			@comment "Blacksmith Bonus"
				@if agent_UnitType <= 4 {
					@if `agent_UnitType == 1 || agent_UnitType == 2 && agent_AAType > 0 {
						@comment "Arrow"
							agent_BaseAD += v[2409 + spawnSet_Team % 3] & 0x200 ? muldiv(agent_BaseAD, 10, 100) : 0
							agent_BaseAS += v[2409 + spawnSet_Team % 3] & 0x400 ? muldiv(agent_BaseAS, 10, 100) : 0
							agent_BaseHIT += v[2409 + spawnSet_Team % 3] & 0x400 ? 5 : 0
							agent_BaseHIT += v[2409 + spawnSet_Team % 3] & 0x8000 ? 3 : 0

					} .else bl {
						@comment "Melee"
							agent_BaseAD += v[2409 + spawnSet_Team % 3] & 0x80 ? muldiv(agent_BaseAD, 10, 100) : 0
							agent_BaseHIT += v[2409 + spawnSet_Team % 3] & 0x80 ? 2 : 0
							agent_BaseAD += v[2409 + spawnSet_Team % 3] & 0x100 ? muldiv(agent_BaseAD, 8, 100) : 0
							agent_BaseHIT += v[2409 + spawnSet_Team % 3] & 0x100 ? 3 : 0

					}
					agent_BaseAR += v[2409 + spawnSet_Team % 3] & 0x800 ? muldiv(agent_BaseAR, 8, 100) : 0
						agent_BaseAR += v[2409 + spawnSet_Team % 3] & 0x1000 ? muldiv(agent_BaseAR, 6, 100) : 0
						@if agent_UnitType == 3 {
							agent_BaseAP += v[2409 + spawnSet_Team % 3] & 0x2000 ? 18 : 0
								v[705..706] += v[2409 + spawnSet_Team % 3] & 0x4000 ? muldiv(agent_HP, 18, 100) : 0
								v[707..708] += v[2409 + spawnSet_Team % 3] & 0x4000 ? muldiv(agent_SP, 18, 100) : 0
								@comment "can support tactics if the unit is mage with function AA"
								agent_BaseObjBit |= agent_AAType == 4 ? 8388608 : 0

						}
					@if agent_UnitType == 4 {
						agent_BaseObjBit |= agent_AAType == 4 ? 8388608 : 0
							agent_BaseWill += v[2409 + spawnSet_Team % 3] & 0x4000000 ? 25 : 0

					}

				}

		}

	@if agent_UnitType == 9 {
		agent_AgentBits &= ~(1048576 + 524288)
			agent_AgentBits |= 2097152
			agent_AgentBits |= 256
			agent_BaseObjBit |= 256
			@comment "cart"
			agent_BaseAR += v[2409 + spawnSet_Team % 3] & 0x10 ? 25 : 0
			v[705..706] += v[2409 + spawnSet_Team % 3] & 0x20 ? 100 : 0

	}

	
	@comment "Imperials"
		@if agent_Culture == 1 {
			@if `v[2412 + spawnSet_Team % 3] & 0x40 {
				@if `between(agent_UnitType, 0, 6) {
					agent_BaseMR += 800

				}

			}
			@comment "Arcane Composite Armor"
				@if `v[2412 + spawnSet_Team % 3] & 0x8 {
					@comment "Cataphract"
						@if agent_UnitID == 21 {
							agent_BaseObjBit |= 32

						}

				}

		}
	@comment "Rus"
		@if agent_Culture == 9 {
			@comment "Inf"
				@if agent_UnitType == 0 {
					@if `v[2409 + spawnSet_Team % 3] & 0x10000000 {
						v[705..706] += muldiv(agent_HP, 1, 10)

					}

				}

		}
	@comment "Sushi"
		@if agent_Culture == 12 {
			@comment "Divine Wind"
				@if `v[2412 + spawnSet_Team % 3] & 0x2 {
					@if `between(agent_UnitType, 0, 4) {
						@if `between(agent_Race, 1, 2) {
							@comment "KAMIKAZE"
								agent_BaseObjBit |= BaseObjBit_FLAG_Explosive
								agent_BaseAP += 60
								agent_BaseMS += 8
								@comment "Will"
								agent_BaseWill += 15

						}

					}

				}
			@comment "Tengger Cavalry"
				@if `v[2412 + spawnSet_Team % 3] & 1 {
					@if agent_UnitType == 2 {
						agent_BaseMS = muldiv(agent_BaseMS, 108, 100)

					}

				}

		}
	s[118].off


			//Set Agent Name

		@if BOOL_Gen_GetMinionData.isOff() {
			set_agent_name(SpawnAgentID,str1)
		}



	@comment "###################Set New Picture System###################"
		agent_troops_set_picture_system()


		// } // ATTENTION!!! suspicious as fugg

		@comment "###################	Set New Picture System END###################"


		@comment "having no min range"
		agent_BaseRange_min = agent_BaseRange_min <= 0 ? -999999 : agent_BaseRange_min


		@if s[1] .isOff() {
			agent_Cohort_ID = v[258]
				@comment "#Racial Traits"
				@comment "##Human"
				@if agent_Race == 0 {
					@comment "###Custom Unit"
						@if agent_ObjectType == 3 {
							@comment "#Crushable head"
								agent_ExMotionFlags |= 64
								@comment "Crushable"
								@if `agent_ExMotionFlags & 64 {
									@comment "Skull"
										agent_ExMotionFlags |= 128

								}

						}

				}
			@comment "##Dragons"
				@if agent_Race == 3 {
					@comment "#Gain Additional AR"
						agent_BaseAR += agent_Level * 8
						@comment "#Gain Additional HPreg"
						agent_BaseRegHP += muldiv(agent_MaxHP, 1, 100)

				}
			@comment "#Obj Bits"
				@comment "##If this is SiegeUnit, then flag bleed immunity"
				agent_BaseObjBit |= agent_UnitType == 5 ? 4096 : 0
				agent_BaseObjBit |= agent_ObjectType == 11 ? 4096 : 0
				@comment "#Cavalry Penalty"
				@comment "##Init FootStepSound"
				agent_FootstepSoundType = 0
				@if agent_UnitType == 2 {
					@comment "#If not flying"
						@if `(agent_MoveTypeBIts & 1) == 0 {
							@comment "#Horse Type Move Flag"
								agent_MoveTypeBIts |= 2
								@comment "#Won't get MS penalty from fatigue "
								agent_BaseObjBit |= BaseObjBit_FLAG_Relentless
								@comment "#SP Bonus"
								v[707..708] += 20
								@comment "#HIT/AVD Penalty"
								v[713..714] -= 5
								@comment "#Melee Range Penalty&Crit Bonus"
								@if agent_AAType == 0 {
									agent_BaseRange_max -= 2000
										agent_BaseRange_max = max(19500, agent_BaseRange_max)
										agent_BaseCrit += 1

								}
							agent_Width += 2
								agent_Height += 3
								@comment "Cant ShieldWall nor PikeWall"
								agent_BaseObjBit = agent_BaseObjBit & ~6
								@comment "Big flag"
								agent_BaseObjBit |= 524288
								@comment "Difficult to get hit on the head"
								agent_CritChanceReduction += 1
								@comment "#set FootStepSound horse"
								agent_FootstepSoundType = 1
								@comment "#Hold weapon"
								agent_ExMotionFlags |= 2097152
								@comment "#Hold Weapon lock"
								agent_ExMotionFlags |= 8388608
								@comment "#Horseback"
								agent_ExMotionFlags |= 16777216
								@comment "#Tech:Husbandry"
								v[705..706] += v[2409 + spawnSet_Team % 3] & 0x80000 ? 200 : 0

						} .else bl {
							@comment "#Flying Troops usually treated as Cav"
								agent_UnitType = agent_UnitType == 0 ? 2 : agent_UnitType

						}

				}
			@comment "#Siege Weapons"
				@if agent_UnitType == 5 {
					@comment "no_fatigue"
						agent_ExMotionFlags |= 2048
						@comment "immune to stun"
						agent_BaseObjBit |= BaseObjBit_FLAG_Immune_to_stun
						@comment "Big flag"
						agent_BaseObjBit |= 524288
						@comment "No mind"
						agent_BaseObjBit |= BaseObjBit_FLAG_No_mind
						agent_BaseObjBit |= 32
						@comment "do not bleed"
						agent_BaseObjBit |= BaseObjBit_FLAG_Immune_to_bleed

						// TECH CHECK
						agent_BaseAD += v[2409 + spawnSet_Team % 3] & 0x10000 ? muldiv(agent_BaseAD, 10, 100) : 0

						@comment "##Sushi"
						@if agent_Culture == 12 {
							agent_BaseMS = muldiv(agent_BaseMS, 150, 100)

						}

				}
			@comment "set Ammo"
				//agent_Ammo = v[831]
				@comment "#AS Bonus#[Lv]"
				agent_BaseAS += agent_UnitType < 3 ? agent_Level : 0
				@comment "Crit"
				agent_BaseCrit += 1
				@comment "set least parameter"
				agent_BaseWill = agent_BaseWill <= 0 ? v[1164] : agent_BaseWill
				@comment "#Skill AutoCast Lock Check"
				@if agent_ObjectType < 9 {
					@loop 4 .dst v[1941] {
						v[760 + v[1941] * 20] |= v[744 + v[1941] * 20] == -1 ? 33 : 0

					}


				}
			@comment "############	Camo"
				@if agent_ObjectType < 11 {
					agent_BaseCamoValue = 4000
						agent_BaseCamoValue -= (agent_BaseObjBit & 524288) > 1 ? 2000 : 0
						@if agent_ObjectType == 9 {
							agent_BaseCamoValue += 8000

						}

				} .else bl {
					@if agent_UnitType == 106 {
						@comment "Turret"
							agent_BaseCamoValue = 10000

					} .else bl {
						agent_BaseCamoValue = agent_UnitType != 107 ? 18000 : 80000
							@comment "GATE"
							@if `agent_AgentBits & 256 {
								agent_BaseCamoValue = 8500

							}

					}

				}
			@comment "####################EyeSight####################"
				agent_UnitEyeSight_for_AgentSearch = max(v[1019], pow(agent_BaseRange_max / 1000, 2))


				// Agent eyesight for minimap fow check 

				@if `between(agent_UnitType, 104, 105) {
					@comment "In sight?"
						v[0] = s[2001 + ptr_SpawnAgentMainSpace_Head] = 1

				}

			@comment "Civilians have better AI eyesight in order to find constcrution site"
				@if agent_UnitType == 9 {
					agent_UnitEyeSight_for_AgentSearch *= 2

				}


		}
	@comment "############Perks Check############"
		@comment "#SkillCaster"
		@if `(agent_PerkFlagBits2 & 131072) >= 1 {
			agent_skill1_CD /= 2
				v[768] /= 2
				v[788] /= 2
				v[808] /= 2

		}

		@comment "#Deffensive perks"
		@comment "#TakenDamageMul"
		agent_TakenDamageMultiplier = 100

		@comment "##Nimble #How should I make brawny affect nimble calculation?"
		@if `agent_PerkFlagBits1 & PerkFlagBits1_FLAG_Nimble {
			agent_TakenDamageMultiplier = min(100, max(100 - 55 + muldiv(v[838] - 15, 12, 100), 45))
				@comment "#Nimble"
				@comment "#Speed Bonus"
				agent_BaseObjBit |= agent_TakenDamageMultiplier == 45 ? 134217728 : 0

		}
	@comment "##Stalwart ###Knockback immunity"
		agent_BaseObjBit |= agent_PerkFlagBits1 & 16 ? 8 : 0
		@comment "#Aggressive perks"
		@comment "############	Perks Check End############"
		@comment "Set Common Exp [Lv]*50"
		agent_saveFoWPoint = agent_saveFoWPoint <= 0 ? v[1194] * agent_Level : agent_saveFoWPoint
		@comment "パラメータ等入力end"
		@comment "Set No Passive"
		@comment "Set AR Max"
		agent_MaxAR = agent_BaseAR
		@comment "Set GenID"
		agent_generated_ID = v[154]

		// init formbits
		val_init(agent_Formbits)

		@comment "Set Timer"
		agent_RegTimer = v[154] % REG_INIT_FRAME

		@comment "Set SkipFrame"
		agent_ObjectCollideSkipFrame = 2
		@comment "#AITimer"
		@if agent_ObjectType < 10 {
			@comment "Have minion troop AI"
				agent_ActionTimer = v[154] % v[1195]

		} .else bl {
			@if agent_UnitType == 106 {
				@comment "Turret"
					agent_StaticBits |= 1048576
					agent_ActionTimer = v[154] % v[1195]

			} .else bl {
				@comment "No AI"
					agent_ActionTimer = 999999999

			}

		}

	@comment "#Set Actual Team #underdev, just save in reg1"
		agent_SaveActualTeamID = agent_TeamID //  can we move this to AEB?

		@comment "#PassiveTimer"
		agent_PassiveTimer = v[154] % v[1139]
		@comment "#FootStepTimer"
		agent_FootstepSoundTimer = (agent_ExMotionFlags & ExMotionFlags_FLAG_no_footstepsound) == 0 ? agent_BaseMS / 4 + agent_ActionTimer : 999999999
		//Get Luck(rand)
		agent_Luck=rnd(0,999)

		@if BOOL_Gen_GetMinionData .isOff() {
			@comment "mapxyset"
				agent_MilPixX.copy agent_MapX, 2
				agent_MapX .add v[1061], 2
				v[626..627] /= 10000
				@comment "ずれ計算"
				agent_MapX .sub v[403], 2
				@comment "ずれおわり"
				v[626..627] /= 16

				@if s[151] .isOff() {


					// reintroduce?
					vname[4806], "ConstAgentRootSightArrayHead"

					agent_reset_BaseSight_Root(SpawnAgentID)

					@comment "avoid false data"
						reg1 = -1
						@if agent_HP >= 1 {
							//3.11.23
							//initializing agent enemy table to avoid false target
							//using regs as temp var  
							reg1 = v[4579] + (v[1012] + 2) * ptr_SpawnAgentMainSpace_Head
								v[reg1..reg1+(v[1012] + 1)] = 0
								//Then set basic parameter to agent slots
								agent_ObjectType.copy v[Ptr20], 300
								@comment "Collision Counter"
								v[196] += agent_ColDimension != -1 ? 1 : 0
								@comment "Save ColBox"
								@if agent_ColDimension == -1 {
										set_AEB_array($agentid, __id(v[1301]), AgentExBuffer_SLOT_ColBoxWidth,2)

								} .else bl {
										agent_set_ColBox(SpawnAgentID)

								}

							@comment "#############Search and remove from body list"
								reg1 = v[4531]
								@doWhile v[reg1] > 0 {
									@if `v[reg1] == ptr_SpawnAgentMainSpace_Head + 1 {
										v[reg1] = 0
											v[v[4531] + v[1004]] -= 1
											v[v[4531]].sortDescending v[1004]
											@break

									}
									reg1 += 1

								}

							@comment "Set into UnitTypeList"
								@if agent_ObjectType <= 10 {
									v[v[4532] + v[1004] - 1] = ptr_SpawnAgentMainSpace_Head + 1
										v[v[4532] + v[1004]] += 1
										v[v[4532]].sortDescending v[1004]
										v[v[4804] + ptr_SpawnAgentMainSpace_Head] = [(agent_TeamID == 0 ? 0xFF0A3AFF : 0xFFC926C9) - 14671872, -65536 + 8224, 0xFFFBF236][(agent_TeamID % 3)]

								} .else bl {
									v[v[4533] + v[1004] - 1] = ptr_SpawnAgentMainSpace_Head + 1
										v[v[4533] + v[1004]] += 1
										v[v[4533]].sortDescending v[1004]
										@comment "constcrution site"
										@comment "#temp, this is not made for enemy team "
										@if agent_UnitType == 104 {
											v[v[4561] + v[1012] - 1] = ptr_SpawnAgentMainSpace_Head + 1
												v[v[4561] + v[1012]] += 1
												v[v[4561]].sortDescending v[1012]

										}
									v[v[4804] + ptr_SpawnAgentMainSpace_Head] = [agent_TeamID == 0 ? 0xFF0A3AFF : 0xFFC926C9, -65536, 0xFFD6CD20][(agent_TeamID % 3)]

								}


							// set MetaTeam in AEB
							reg2 = agent_TeamID % 3
							set_AEB_element(SpawnAgentID, __id(reg2),AgentExBuffer_SLOT_MetaTeam)

							// ACHTUNG this will be removed after replace every MetaTeam reference
							v[Const_AgentMetaTeam_begin + ptr_SpawnAgentMainSpace_Head] = agent_TeamID % 3


								@comment "敵味方峻別リストに登録"
								@if s[157] .isOff() {


									agent_reset_MapEyeSight(SpawnAgentID)

									@if agent_ObjectType == 11 {
										@if agent_UnitType != 105 {
											@if agent_UnitType != 104 {
												v[v[4580] + agent_TeamID % 3] += 1

											}

										}
										@if `agent_AgentBits & 64 {
											v[v[4580] + agent_TeamID % 3] += 6
												@comment "#Potetons"
												@if `v[2403 + agent_TeamID % 3] == 8 {
													v[v[4580] + agent_TeamID % 3] += 2

												}

										}

									}

									// "##Economy Buildings e.g. farm won't be registered to the team List
									agent_TeamID = agent_UnitType == 104 ? -1 : agent_TeamID
										agent_TeamID = agent_UnitType == 105 ? -2 : agent_TeamID
										agent_TeamID %= 3
										@if agent_TeamID == 0 {
											@comment "Register Battle ally units list"
												@comment "Safety"
												@if v[205] < v[1012] {
													v[v[1145] + v[1012] - 1] = ptr_SpawnAgentMainSpace_Head + 1
														v[v[1145]].sortDescending v[1012]
														v[205] += 1
														@comment "Records"
														@if s[19] .isOff() {
															v[2522] += agent_UnitType == 9 ? 1 : 0
																v[2523] += agent_UnitType <= 7 ? 1 : 0

														}

												} .else bl {
													@comment "最大数超過したらなかったことに"
														v[1301].copy v[Ptr20], 300

												}

										} .else bl {
											@if agent_TeamID == 1 {
												@if v[206] < v[1012] {
													@comment "敵リストに登録"
														v[v[1146] + v[1012] - 1] = ptr_SpawnAgentMainSpace_Head + 1
														v[v[1146]].sortDescending v[1012]
														v[206] += 1

												} .else bl {
													@comment "最大数超過したらなかったことに"
														v[1301].copy v[Ptr20], 300

												}

												// give list information to js system

											} .else bl {
												@comment "中立Obj"

											}

										}
									@comment "Register UnitsID joining battle List"
										@if `between(agent_SaveActualTeamID, 0, 1) && agent_UnitType < 7 {
											reg1 = v[1259] + 4 * (agent_UnitID - 1) + agent_SaveActualTeamID * v[1260] * 4
												v[reg1] += 1

										}

								}
							v[0] = s[2001 + ptr_SpawnAgentMainSpace_Head] = agent_TeamID % 3 == 2 ? 1 : 0
								@if Is_SightSystem_On .isOff() {
									v[0] = s[2001 + ptr_SpawnAgentMainSpace_Head] = 1

								} .else bl {
									@comment "Reset sight timer"
										v[v[4518] + ptr_SpawnAgentMainSpace_Head] = agent_TeamID % 3 == 0 ? 64 : 0 // ally unit is always in player sight 

								}


							// set agent AI target priority
							agent_reset_AI_target_priority_AEB(SpawnAgentID)



								// FINISH
								@if s[19] .isOff() {
									@if agent_TeamID == 0 {
										@if agent_ObjectType < 11 {
											@if v[2218] <= 2 {
												//@call .cev 1924
													TT1 = 2
													agent_ObjectType = 1
													msg(t[20243])

											}
											@if `v[205] >= min(v[1080], v[v[4580]]) {
												@if agent_UnitType < 100 {
													TT1 = 2
														agent_ObjectType = 1
														agent_UnitID = v[agent_TeamID + 1]
														str1 .asg t[Ptr20]
														TT2 = v[agent_TeamID] == 1 ? 5 : 10
														msg("\c[17]\t[20195]")

														v[472] = divmul(100, 100, v[2216])
														@se.play "ui\UI_Quirky4" .opt v[472], 100, 50

												}

											}

										} .else bl {
											@if v[2218] <= 2 {
												@if agent_PicID != 104 {
														TT1 = 2
														agent_ObjectType = 1
														msg(t[20244])

												}

											}

										}
										@if s[117] .isOn() {
											@call .cev 84

										}

									}

								}

								ptr_SpawnAgentMainSpace_Head += 1
								reg1 = ptr_SpawnAgentMainSpace_Head
								gl_lastSpawnedAgent = reg1
								reg2 = agent_UnitID
								reg3 = agent_UnitType

							@comment "Avoid PictID0 Bug"
								s[80].off
								@comment "Pict set"
								v[154] += 1

						}

				}
			v[258] = 0

		} .else bl {
			ptr_SpawnAgentMainSpace_Head = 0

		}
	s[157].off
		deblog("\agent_PictArray")

}


// Legacy cev 301
__fn GenAgent_BaseStatsPerk {

	@comment "#SecondWind"
		v[732] += (v[Temp2 + 8] & 1024) == 1024 ? 2 : 0
		@comment "#IronFresh"
		agent_HP += (v[Temp2 + 8] & 512) == 512 ? divmul(agent_MaxHP, 100, 25) : 0
		agent_MaxHP += (v[Temp2 + 8] & 512) == 512 ? divmul(agent_MaxHP, 100, 25) : 0
		@comment "#SteelWill"
		agent_BaseWill += (v[Temp2 + 8] & 2048) > 0 ? divmul(agent_BaseWill, 100, 25) : 0
		@comment "#Battlemage"
		agent_BaseAP += (v[Temp2 + 8] & 4096) > 0 ? 20 : 0
		@comment "#Warmage"
		agent_BaseAP += (v[Temp2 + 8] & 16384) > 0 ? 40 : 0
		@comment "#MageBlaster"
		agent_BaseMR += (v[Temp2 + 8] & 8192) > 0 ? 50 : 0
}

//legacy cev 302
__fn GenAgent_PerksAndObjBits {

	@comment "#RockHead"
		@if `(v[Temp2 + 8] & 65536) > 0 {
			agent_CritChanceReduction += 1
				agent_CritDamageReduction += 85

		}
	@comment "###Strider"
		agent_AABits |= (v[Temp2 + 6] & 8192) == 8192 ? 32768 : 0
		@comment "Stalwart"
		agent_BaseObjBit |= (v[Temp2 + 6] & 16) >= 16 ? 8 : 0
		@comment "Fearsome"
		agent_BaseObjBit |= (v[Temp2 + 6] & 256) >= 256 ? 16384 : 0
		@comment "##Horse"
		@if agent_UnitType == 2 {
			@comment "###Logistica"
				agent_AABits |= (v[Temp2 + 8] & 262144) == 262144 ? 4096 : 0

		}
	@comment "##EXTRA PERKS"
		@comment "###BattleMaster"
		agent_BaseObjBit |= (v[Temp2 + 8] & 1) == 1 ? 128 : 0
		@comment "###Determination"
		agent_BaseObjBit |= (v[Temp2 + 8] & 2) == 2 ? 256 : 0
		@comment "###Devastating Strikes"
		agent_AABits |= (v[Temp2 + 8] & 4) == 4 ? 2048 : 0
		@comment "#MageBlaster"
		agent_AABits |= (v[Temp2 + 8] & 8192) > 0 ? 8 : 0
		@comment "#Unstoppable"
		agent_BaseObjBit |= v[Temp2 + 8] & 32768 ? 65536 : 0
		@comment "#Bannerlord"
		agent_Passive_Type_Flag |= v[Temp2 + 6] & 16384 ? 4 : 0
}


// legacy cev 303
__fn GenAgent_Horse_Setting {

	@if agent_UnitType == 2 {
		@comment "#Not flying"
			@if agent_MoveTypeBIts != 1 {
				@comment "##Riding Perks"
					@comment "###MountainBlade"
					@if `!(v[Temp2 + 8] & PerkFlagBits3_FLAG_Mountainblade) { // if the troop doesn't have the perk, give it pernalties
						agent_RHitAndMHit = muldiv(agent_RHitAndMHit, 88, 100)
							agent_BaseEVA = muldiv(agent_BaseEVA, 92, 100)

					} .else bl {
						@comment "#Speed Bonus"
							agent_BaseObjBit |= BaseObjBit_FLAG_SpeedBonus

					}
				@comment "###HorseArchery"
					@if `(v[Temp2 + 8] & PerkFlagBits3_FLAG_HorseArcher) == 0 {
						v[837] /= 2

					} .else bl {
						v[837] -= 5

					}
				@comment "###Parthian Shot"
					@if `(v[Temp2 + 8] & PerkFlagBits3_FLAG_Parthian) == 0 {
						@if s[211] .isOn() {
							@comment "AS penalty"
								agent_BaseAS -= 6
								@comment "Motion penalty"
								agent_AAMotion += 2
								@comment "Cannot Skirmish"
								agent_BaseObjBit &= ~16

						}

					} .else bl {

					}
				@if agent_ObjectType == 3 {
					agent_InitialOffsetY -=  10 // Sprite Offset Y
						@if `agent_AABits & AABits_FLAG_Camel { // CAMEL
							agent_InitialOffsetY -= Const_camel_offsetY // Sprite Offset Y..
								agent_Width += 1 // add size since camel is simply tall!
								agent_Height += 3 // add size since camel is simply tall!
								agent_MoveTypeBits |= MoveTypeBits_Sand

						}
				}

			}

	}

}


// leg cev 1928 - not replaced with meta func yet
__fn GenAgent_Perk_WeaponMastery {
	v[1942] = v[1901] % 100
		v[1943] = 8 * pow(2, v[1942])
		v[1941] = agent_PerkFlagBits2 & v[1943]
		@if v[1941] >= 1 {
			@comment "Crit+1%"
				v[1906] += 1
				@comment "AS+10%"
				v[1910] = muldiv(v[1910], 11, 10)
				@comment "Cost-20%"
				v[1912] = muldiv(v[1912], 8, 10)
				@comment "#Dagger"
				@if v[1943] == 1024 {
					@comment "AS+50%"
						v[1910] = muldiv(v[1910], 150, 100)

				}
			@comment "#Throw"
				@if v[1943] == 2048 {
					@comment "AD+25%"
						v[1902] = muldiv(v[1902], 125, 100)

				}
			@comment "#Bow"
				@if v[1943] == 16384 {
					@comment "Range+35000"
						v[1908] += 35000

				}
			@comment "#Crossbow"
				@if v[1943] == 32768 {
					@comment "Pen+25%"
						v[1904] += 25

				}

		}
}


// cev_2160
// make wall to be built fit to the map pathfinding node system
__fn generateWall_preparation $begX $begY $endX $endY $team {
	t[__id($begX)] .toNum TT11
		t[__id($begY)] .toNum TT12
		t[__id($endX)] .toNum TT13
		t[__id($endY)] .toNum TT14
		TT11.copy TT1, 2
		TT11 += Map_LimitCoordX_min % 2
		TT12 += Map_LimitCoordY_min % 2
		TT13 += Map_LimitCoordX_min % 2
		TT14 += Map_LimitCoordY_min % 2
		v[351..354] /= 2
		v[351..354] *= 2
		TT15 = (TT11 + TT13 + Map_LimitCoordX_min % 2) / 2
		TT16 = (TT12 + TT14 + Map_LimitCoordY_min % 2) / 2
		@call .cev 2001
		reg2.copy spawnSet_x, 2
		TT13.copy TT1, 2
		@call .cev 2001
		v[11..12] = 0
		var1 .add TT11, 2
		var1 .sub TT13, 2
		v[11..12] *= 16
		@if var1 == var2 {
			var1 *= 2
				var2 *= 2

		} .else bl {
			@if var1 > var2 {
				var1 *= 2

			} .else bl {
				var2 *= 2

			}

		}
	var1 = abs(var1)
		var2 = abs(var2)
		v[11..12] += 16
		v[11..12] += 16
		TT15.copy TT1, 2
		@call .cev 2001
		reg2 += 8 - 16 * (Map_LimitCoordX_min % 2)
		reg3 += 8 - 16 * (Map_LimitCoordY_min % 2)
		reg2.copy spawnSet_x, 2
		t[__id($team)] .toNum spawnSet_Team

}

__fn get_troop_cost_infomation_after_deployment_to_str {
	// will be rewritten in js

	// "Production Speed"
	CSVELM_AGENT_train_speed .toNum var3
	// "Resource costs"
	CSVELM_AGENT_food .toNum v[31] // food
	CSVELM_AGENT_wood .toNum v[32] // wood
	CSVELM_AGENT_stone .toNum v[33] // stone
	CSVELM_AGENT_gold .toNum v[34] // gold
	CSVELM_AGENT_race .toNum agent_Race
	
	@if agent_Race == 3 { // dragons 
		CSVELM_AGENT_faction .toNum agent_Culture // get faction

		@if Team_Player_Faction != FAC_dra { // if player faction is NOT Dragons

			// then dragon troops costs go higher 
			def GEN_adr_cost_start = __id(v[31])
			$i = GEN_adr_cost_start
			__loop 4 {
				v[$i] += v[$i] >> 2 // + 25%
				$i += 1
			}
			var3 -= var3 >> 4 // create speed -6% 

		}.else bl { // is Dragons
			@if Team_Player_Faction_Hero_Type != 1 { // NOT Orthunass
				var3 -= Team_Player_Faction_Hero_Type != 1 ? var3 >> 5 : 0 // create speed -6% 
			}

		}


	}


}

__fn param_adjustment_dragons {
	@comment "Naskarl"
		@if agent_UnitID == 27 {
			@if `v[2406 + v[251] % 3] & 0x4000 {
				agent_BaseRegHP *= 2

			} .else bl {
				v[801] = 0

			}

		}
	@comment "Firedragon"
		@if `v[2412 + v[251] % 3] & 0x4 {
			@if agent_UnitID == 29 {
				agent_BaseAP += 25

			}

		}
	@comment "J'drago"
		@if `!(v[2412 + v[251] % 3] & 0x1) {
			@if agent_UnitID == 36 {
				v[781] = 0

			}

		}
	@comment "Dragonu"
		@if agent_UnitID == 28 {
			@if `v[2406 + v[251] % 3] & 0x80 {
				@comment "GreatCrossbow"
					agent_MainWeaponID = 40
					agent_BaseAD += 25
					@comment "Hit"
					agent_BaseHIT += 5

			}
			@comment "Tra"
				@if `v[2406 + v[251] % 3] & 0x1000 {
					agent_BaseHIT += 10
						agent_PerkFlagBits2 |= 8
						agent_PerkFlagBits2 |= 32768

				}

		}
	@comment "DragonForge"
		@if `v[2406 + v[251] % 3] & 0x100 {
			@if agent_UnitType < 3 {
				@if agent_UnitType != 1 {
					@comment "AD"
						agent_BaseAD += 10

				}

			}

		}
	@comment "Inf Dragons"
		@if `v[2406 + v[251] % 3] & 0x2000 {
			@comment "Inf Dragons"
				@if agent_UnitType == 0 {
					@comment "Hit/Avd"
						agent_BaseHIT += 6
						agent_BaseEVA += 4

				}

		}
	@comment "Squires"
		@if `v[2406 + v[251] % 3] & 0x200 {
			@comment "Warrior Dragons"
				@if agent_UnitType <= 2 {
					@comment "Not Naskarl"
						@if agent_UnitID != 27 {
							@comment "MS"
								agent_BaseMS = muldiv(agent_BaseMS, 11, 10)
								v[705..706] += 100

						}

				}

		}
	@comment "Armor"
		@if `v[2406 + v[251] % 3] & 0x400 {
			@comment "AR"
				agent_BaseAR += 28
				agent_MaxAR += 28

		}
	@comment "Orthunass"
		@if v[2402] == 1 {
			agent_BaseWill += 9

		}
	@comment "Dragonne"
		@if agent_UnitID == 176 {
			agent_BaseObjBit |= [0, 0, 0, 2097152][rnd(0, 3)]

		}
}



// skin
__fn agent_set_skin $raceid $skinkey $headtype $haircolor $hairstyle {
	
	agent_FootstepSoundType = agent_HeadID + agent_Skin * 1000000
	agent_FootstepSoundType += agent_Skin != -1 ? agent_Race * 10000000 : 0
}

__fn agent_set_ColBox $agentid {
		//SET ColBox!!!!

		var1 = muldiv(agent_Width, 4, 5)
		var2 = muldiv(agent_Height, 4, 5)
		// agent_Width.copy v[agent_FootstepSoundTimer], 2 // maybe obsolete
		set_AEB_array($agentid, __id(var1), AgentExBuffer_SLOT_ColBoxWidth,2)
}


__fn agent_reset_AI_target_priority_AEB $agentid {
	def classtypesetend = 4100 + ClassType_Amount
		defv static_target_set = classtypesetend 

		v[4101..classtypesetend] = 100000000

		// lower value = more priority

		// siege ram type
		@if `agent_AI_routine_bits & AI_routine_bits_FLAG_siegeweapon_flag {
			v[4101..classtypesetend] += 900000000
				static_target_set -= 950000000 
		}

	@if `agent_AI_routine_bits & AI_routine_bits_FLAG_skirmisher {
		v[4102] -= 50000000

	}

	@if `agent_AI_routine_bits & AI_routine_bits_FLAG_assassin {
		v[4105] -= 50000000
	}

	set_AEB_array($agentid,4101,AgentExBuffer_SLOT_Class_Target_Priority_Array,ClassType_Amount)


}

__fn agent_reset_BaseSight_Root $agentid {
	var1 = $agentid - 1
	var1 += v[4806]
	v[var1] = sqrt(agent_UnitEyeSight_for_AgentSearch, 1)
}


__fn agent_reset_MapEyeSight $agentid {
	@comment "EyeSightForminimaps const =62500"
		var1 = $agentid - 1
		var1 += v[4528]
		v[var1] = min(agent_UnitEyeSight_for_AgentSearch / 31250, 6)
		@comment "#Cavs  have better sight"
		@if `between(agent_UnitType, 1, 2) {
			v[var1] += 1

		}
	@comment "towers"
		@if agent_UnitType == 106 {
			v[var1] += 2

		}
	v[var1] -= agent_HeadSPregPenalty
		@comment "walls"
		@if agent_UnitType == 107 {
			v[var1] = 1

		}
	v[var1] = max(v[var1], 1)
}



__fn agent_troops_set_picture_system {
	Temp2 = ptr_SpawnAgentMainSpace_Head * 6 + v[1185] //ACHTUNG you need to remove this system eventually - it's obsolete legacy system, almost no meaning now
		@comment "#init"
		v[Temp2..Temp2 + 5] = 0
		v[Temp2] = agent_PicID > 0 ? agent_PicID : agent_UnitID
		@comment "agent_PictArray=Layers"
		agent_PictArray = 7
		@comment "#STATIC"
		@if agent_ObjectType == 11 {
			agent_static_set_adjustments_for_pic_system()
		}

	@comment "#classic minions"
		@if agent_ObjectType == 1 {
			agent_ExMotionFlags |= 2097152

		}

	@comment "#Weapon Switchable Units"
		@if agent_ObjectType == 4 {
			v[0] = v[Temp2..Temp2 + 5] = [agent_PicID, 0, 0, agent_HorseID, agent_Formbits, 0]
				@if agent_MainWeaponID >= 1 {
					@comment "#Have Weapon"
						@if s[154] .isOn() {
							agent_PictArray = 74

						} .else bl {
							agent_PictArray = 47

						}
					@if agent_MainShieldID >= 1 {
						@comment "#Have Shield"
							agent_PictArray = 574

					}

				}

		}

	@comment "#User Units"
		@if agent_ObjectType == 3 {
			// layered units race settings
			@comment "Human"
				@if agent_Race == 0 {
					@comment "NOT female"
						@if agent_Skin != 6 {
							@comment "temp, beard"
								@if agent_HeadID >= 3 {
									@if s[159] .isOff() {
										s[160].on

									}

								}

						}

				}
			@comment "Goblins"
				@if agent_Race == 1 {
					s[160].on
						s[159].off
						// @comment "default body sprite set"
						@if agent_FootstepSoundTimer == 0 {
							agent_FootstepSoundTimer = -1
							agent_ExMotionFlags |= 512
							
						}
						

				}

			@comment "Orks"
				@if agent_Race == 2 {
					s[160].on
						s[159].off
						@if agent_FootstepSoundTimer == 0 {
							agent_FootstepSoundTimer = -2
							agent_ExMotionFlags |= 512
							
						}
				}

			@if agent_Race == 5 {
				s[160].on
					s[159].off

			}

			@if agent_Race == 6 {
				s[160].on
					s[159].off

			}


			@if s[160] .isOn() {
				@comment "Have Big Head"
					agent_PictArray = 321
					deblog("bighead agent")
					@comment "Have acc with picture"
					@if v[889] >= 1 {
						@comment "#Have Shield"
							@if agent_MainShieldID >= 1 {
								agent_PictArray = 563214
									@comment "#Show Hair"
									@if v[888] == 0 {
										agent_PictArray += 6000
											v[888] = agent_GENERATION_Hair

									}

							} .else bl {
								@if s[154] .isOn() {
									agent_PictArray = 63214
										@comment "#Show Hair"
										@if v[888] == 0 {
											agent_PictArray += 6000
												v[888] = agent_GENERATION_Hair

										}

								} .else bl {
									agent_PictArray = 46321
										@comment "#Show Hair"
										@if v[888] == 0 {
											agent_PictArray += 600
												v[888] = agent_GENERATION_Hair

										}

								}

							}

					} .else bl {//no acc
						@comment "#Have Shield"
							@if agent_MainShieldID >= 1 {
								agent_PictArray = 53214
									@comment "#Show Hair"
									@if v[888] == 0 {
										agent_PictArray += 6000
											v[888] = agent_GENERATION_Hair

									}

							} .else bl {
								@if s[154] .isOn() {
									agent_PictArray = 3214
										@comment "#Show Hair"
										@if v[888] == 0 {
											agent_PictArray += 6000
												v[888] = agent_GENERATION_Hair

										}

								} .else bl {
									agent_PictArray = 4321
										@comment "#Show Hair"
										@if v[888] == 0 {
											agent_PictArray += 600
												v[888] = agent_GENERATION_Hair

										}

								}

							}

					}

			} .else bl {//have no big head
				agent_PictArray = 312
					@comment "Have acc with picture"
					@if v[889] >= 1 {
						@comment "#Have Shield"
							@if agent_MainShieldID >= 1 {
								agent_PictArray = 563124
									@comment "#Show Hair"
									@if v[888] == 0 {
										agent_PictArray += 6000
											v[888] = agent_GENERATION_Hair

									}

							} .else bl { // have space for hair
								@if s[154] .isOn() {
									agent_PictArray = 63124
										@comment "#Show Hair"
										@if v[888] == 0 {
											agent_PictArray += 6000
												v[888] = agent_GENERATION_Hair

										}

								} .else bl {
									agent_PictArray = 46312
										@comment "#Show Hair"
										@if v[888] == 0 {
											agent_PictArray += 600
												v[888] = agent_GENERATION_Hair

										}

								}

							}

					} .else bl {
						@if agent_GENERATION_Hair > 0 {// have hair
							@comment "#Have Shield"
								@if agent_MainShieldID >= 1 {
									agent_PictArray = 539124
										@comment "#no helm"
										@if v[888] == 0 {
											agent_PictArray = 59124

										}

								} .else bl {
									@if s[154] .isOn() {
										agent_PictArray = 39124
											@comment "#Show Hair"
											@if v[888] == 0 {
												agent_PictArray = 9124

											}

									} .else bl {
										agent_PictArray = 43912
											@comment "#Show Hair"
											@if v[888] == 0 {
												agent_PictArray = 4912

											}

									}

								}
						}.else bl{//no hair
							@comment "#Have Shield"
								@if agent_MainShieldID >= 1 {
									agent_PictArray = 53124
										@comment "#No Hair No helm"
										@if v[888] == 0 {
											agent_PictArray = 5124

										}

								} .else bl {
									@if s[154] .isOn() {
										agent_PictArray = 3124
											@comment "#Show Hair"
											@if v[888] == 0 {
												agent_PictArray = 124


											}

									} .else bl {
										agent_PictArray = 4312
											@comment "#Show Hair"
											@if v[888] == 0 {
												agent_PictArray = 412

											}

									}

								}

						}

					}
				@if s[159] .isOn() {
					@if LEGS_GenHeadCovered .isOn() {
						reg1 = agent_PictArray
							@if reg1 != 0 {
								@while reg1 > 0 .dst reg3 {
									reg2 = reg1 % 10
										@if reg2 == 2 {
											@break

										}
									reg1 /= 10

								}

								agent_AddMotionBits |= 524288
									agent_PictArray = agent_PictArray / pow(10, reg3 + 1) * pow(10, reg3) + agent_PictArray % pow(10, reg3)

							}

					}

				}

			}

			v[0] = v[Temp2..Temp2 + 5] = [agent_FootstepSoundTimer, agent_FootstepSoundType, v[888], agent_HorseID, agent_Formbits, v[889]]
		}


		s[154].off
		LEGS_GenHeadCovered.off
		s[159].off
		s[160].off

		/*
			 @comment "#Set SpriteOrder"
			 v[0] = v[302..306] = [3, 2, 4, 3, 2]
			 @comment "Has move sprite?"
			 Temp3 = (agent_ExMotionFlags & 2) == 2 ? 5 : Temp3
			 Temp3 = (agent_ExMotionFlags & 16) == 16 ? 4 : Temp3
			 @comment "Skill Moition"
			 Temp2 = (agent_ExMotionFlags & 4) == 4 ? 5 : 3
		 */

		v[0] = v[302..306] = [2, 3, 4, 2, 3]
		@comment "Has move sprite?"
		Temp5 = (agent_ExMotionFlags & 2) == 2 ? 5 : Temp5
		Temp5 = (agent_ExMotionFlags & 16) == 16 ? 4 : Temp5
		@comment "Skill Moition"
		Temp6 = (agent_ExMotionFlags & 4) == 4 ? 5 : 3

		// AEB returns

			@if BOOL_Gen_NoListAssigningFlag.isOff() {
				set_AEB_array(SpawnAgentID,302,AgentExBuffer_SLOT_ActionSprite_1,5)
			}

		//ATTENTION

	@if BOOL_Gen_NoListAssigningFlag.isOff() {
		@if agent_AgentType != 11 {
			func_drawing_agent_init_set_picture_strs(SpawnAgentID) // ->module_core_RTS_drawing_functions.tpc
		}
	}

		v[886..889] = 0


}

// functions for STATIC agents
__fn agent_static_set_adjustments_for_pic_system {

			@if agent_AAType == 2 {
					func_get_ranged_weapon_velocity(agent_BaseRange_max,1)
					agent_AAvelocity = reg1
			}

				Bool_Refresh_Static_Minimap.on //request refresh minimap static
				v[834..835] = 0
				//MapXY/5 for minimap
				v[600 + AGENT_STATIC_SLOT_MINIMAP_X] = agent_MapX / 5
				v[600 + AGENT_STATIC_SLOT_MINIMAP_Y] = agent_MapY / 5

				@comment "Node check"
				@if agent_UnitType == 107 { // the unit type is wall


					v[600 + AGENT_STATIC_SLOT_MINIMAP_X] = (v[803]+agent_Width/16)/5
						v[600 + AGENT_STATIC_SLOT_MINIMAP_Y] = (v[804]+agent_Height/16)/5
						@if `agent_StaticBits & StaticBits_FLAG_has_gate_function {

								v[803].copy var1, 2
								@call .cev 2017
								v[807] = reg1
								v[808..809] = 0
								v[807] = max(v[807], 0)
								v[808] += v[610] * 2 / 32
								v[809] += v[611] * 2 / 32

								/*v[803].copy v[856], 2
									v[856]=(v[856]+v[610]/16)/5
									v[857]=(v[857]+v[611]/16)/5*/

								@loop v[809] .dst v[2064] {
									Ptr6 = v[4564] * (v[807] + v[433] * v[2064]) + v[4569] - 1
										@loop v[808] .dst v[2065] {
											@comment "init"
												Ptr7 = Ptr6 + 3
												@comment "setup"
												@if v[Ptr7] == 0 {
													Ptr7 += 1

												}
											@comment "Cost Set"
												@comment "setup"
												@comment "Cost Set"
												v[Ptr7] -= STATIC_NODE_MOVEMENT_COST_WALL
												@comment "static built"
												v[Ptr6 + 11] |= 32
												@comment "1"
												Ptr6 += v[4564]

										}


								}


						} .else bl {
							v[803].copy var1, 2
								@call .cev 2017
								v[807] = reg1
								v[808..809] = 0
								@if v[610] >= v[611] {
									v[834] = 1

								} .else bl {
									v[835] = 1

								}
							v[807] = max(v[807], 0)
								v[808] += v[610] * 2 / 32
								v[809] += v[611] * 2 / 32
								@loop v[809] .dst v[2064] {
									Ptr6 = v[4564] * (v[807] + v[433] * v[2064]) + v[4569] - 1
										@loop v[808] .dst v[2065] {
											@comment "init"
												Ptr7 = Ptr6 + 3
												@comment "setup"
												@if v[Ptr7] == 0 {
													Ptr7 += 1

												}
											@comment "Cost Set"
												@comment "setup"
												@comment "Cost Set"
												@if s[1] .isOn() {
													Ptr8 = Ptr6 + 1
														Ptr9 = Ptr6 + 2
														@loop 2 .dst v[2067] {
															v[2068] = v[Ptr9] + v[2067]
																@loop 2 .dst v[2066] {
																	v[2069] = v[Ptr8] + v[2066]
																		Temp13 = v[v[1182] + v[2069] - Map_LimitCoordX_min + (v[2068] - Map_LimitCoordY_min) * var_Map_Width] % 100
																		@if Temp13 == 21 {

																		}

																}


														}


												}
											v[Ptr7] += STATIC_NODE_MOVEMENT_COST_WALL
												@comment "static built"
												v[Ptr6 + 11] |= 32
												@comment "1"
												Ptr6 += v[4564]

										}


								}


						}

				} .else bl {
					// tile hyu-risutexikku kosuto dayo
					@if `!between(agent_UnitType, 104, 105) {
						v[607].copy var1, 2
							var1 .sub v[610], 2
							v[11..12] *= 10000
							@call .cev 1999
							v[803] = reg1
							v[804] = reg2
							v[804] += 1
							reg1.copy v[803], 2
							v[803].copy var1, 2
							@call .cev 2017
							v[807] = reg1
							v[808..809] = 1
							v[808] += v[610] * 2 / 32
							v[809] += v[611] * 2 / 32
							@loop v[809] .dst v[2064] {
								Ptr6 = v[4564] * (v[807] + v[433] * v[2064]) + v[4569] - 1
									@loop v[808] .dst v[2065] {
										@comment "init"
											Ptr7 = Ptr6 + 3
											@comment "setup"
											@if v[Ptr7] == 0 {
												Ptr7 += 1

											}
										@comment "Cost Set"
											v[Ptr7] += STATIC_NODE_MOVEMENT_COST
											@comment "static built"
											v[Ptr6 + 11] |= 32
											@comment "1"
											Ptr6 += v[4564]

									}


							}


					} .else bl {
						v[607].copy var1, 2
							var1 .sub v[610], 2
							v[11..12] *= 10000
							@call .cev 1999
							v[803] = reg1
							v[804] = reg2
							v[804] += 1
							reg1.copy v[803], 2
							v[803].copy var1, 2
							@call .cev 2017
							v[807] = reg1
							v[808..809] = 1
							v[808] += v[610] * 2 / 32
							v[809] += v[611] * 2 / 32

					}

				}
			@comment "#minimap"
				v[833] = max(min(muldiv(v[803], 100, v[430]) - 1, v[1277]), 0) + max(min(muldiv(v[804], 100, v[431]) - 1, v[1276]), 0) * v[1277]
				v[834] += v[610] / 7 / v[413] + 1
				v[835] += v[611] / 7 / v[416] + 1
				@comment "####"
				v[602] |= v[602] == 0 ? agent_UnitID : v[602]
				v[841] = 1
				v[603] |= 1048576
				v[899] = 8
				@comment "AVD=-100"
				v[714] = -100
				@comment "CritRedu"
				v[839] = 100
				@comment "Clean up production space"
				v[770..800] = 0
				agent_BaseObjBit |= 64
				agent_BaseObjBit |= 128
				@comment "no_fatigue"
				v[726] |= 2048
				@comment "Big flag"
				agent_BaseObjBit |= 524288
				@comment "No mind"
				agent_BaseObjBit |= BaseObjBit_FLAG_No_mind
				@comment "Halve Ranged"
				agent_BaseObjBit |= 32
				@comment "do not bleed"
				agent_BaseObjBit |= BaseObjBit_FLAG_Immune_to_bleed
				v[844] = 3
				@comment "Design Flaw, temp fix"
				v[820] = agent_BaseObjBit
				@comment "Cost"
				v[31].copy v[851], 4
				@comment "##Team Bonus"
				@if agent_UnitType != 105 {
					@if agent_UnitType != 104 {
						v[711] += 50
							v[705..706] += muldiv(v[706], 2, 10)
							@comment "##Empire"
							@if agent_Culture == 1 {
								v[705..706] += muldiv(v[706], 4, 10)

							}
						@comment "##Sushi"
							@if agent_Culture == 12 {
								v[705..706] -= muldiv(v[706], 12, 100)

							}
						@comment "Artitecture"
						// TECH!
							v[705..706] += v[2409 + spawnSet_Team % 3] & 0x40000 ? muldiv(v[706], 20, 100) : 0
							v[711] += v[2409 + spawnSet_Team % 3] & 0x40000 ? 50 : 0

					}

				}

				// sprite pattern set for static agents
				// in legacy design, using action state was used to indicate sprite pattern, this will be abolished
				agent_static_Spritepattern = agent_ActionState > 0 ? agent_ActionState + 2 : 2

					__if DIS_EXPERIMENTAL == 1 {

						/* Call js function:
						 * DIS._tpc.building.getEnhancedGeneration(SpawnAgentID,agent_UnitID,agent_Culture)
						 * This function directly sets sprite file name and offsets on js
						 * => regs1 = DIStable pictureFiles; reg1 = OffsetX; reg1 = OffsetY;
						 */
						init_agent_picture_strs(SpawnAgentID)
						val_init(var1)
						eval_js("
							try {
								v[11] = DIS._tpc.building.getEnhancedGenerationInfo(v[701],v[822]);
							} catch(error) {
								errorlog(`DIS._tpc.building.getEnhancedGenerationInfo: Something went wrong.\n` + error)
							};
						")
							@if var1 == 1 { // if the agent is enhanced
								// set Offset
								reg1.copy agent_InitialOffsetX,2 
								// set picture
								inputstr.asg "../Picture/static/" //kari
								inputstr.cat regs1
								function_set_agent_picture(SpawnAgentID,inputstr,SPR_STATIC_UPPER) // LAYER SYSTEM IS NOT YET COMPLETED
								function_set_agent_picture(SpawnAgentID,inputstr,SPR_STATIC_WRECK) // LAYER SYSTEM IS NOT YET COMPLETED


							}.else bl{ // NOT enhanced
								// kari
								var1 = (SpawnAgentID - 1) * 10
								var1 += Const_str_agent_pictures_strings_start + SPR_STATIC_UPPER
								t[var1].asg __str(PATH_pictureHome,"static\spr_static_")
								t[var1].cat agent_PicID
								
							}

						// multi layer system for static agent
						@if `agent_StaticBits & StaticBits_FLAG_has_generated_sprite {	
							agent_PictArray = SPR_STATIC_GENERATED // kari
						}.else bl{
							agent_PictArray = SPR_STATIC_WRECK * 10 + SPR_STATIC_UPPER // kari

								@if s[314] .isOff() {
									agent_StaticBits |= StaticBits_FLAG_has_wreck_system
								}
						}
					}
}


__fn agent_static_set_adjustments_for_finish_set {
			v[899] = max(1,v[899]) // assure at least one sprite layer

			//cache flag
			v[725] |= 512

			v[607].copy reg1, 2
			reg1 .add v[53], 2
			reg1 .sub v[76], 2
			reg1 .div v[74], 2
			@comment "TT1=MortX  TT2=MortY ビット演算して処理するよ"
			reg1 = (reg1 | reg1 << 8) & 0xFF00FF
			reg1 = (reg1 | reg1 << 4) & 0xF0F0F0F
			reg1 = (reg1 | reg1 << 2) & 0x33333333
			reg1 = (reg1 | reg1 << 1) & 0x55555555
			reg2 = (reg2 | reg2 << 8) & 0xFF00FF
			reg2 = (reg2 | reg2 << 4) & 0xF0F0F0F
			reg2 = (reg2 | reg2 << 2) & 0x33333333
			reg2 = (reg2 | reg2 << 1) & 0x55555555
			@comment "yは1bitシフトで終わり"
			reg2 <<= 1
			@comment "最後にTT1 OR TT2"
			v[609] = reg1 | reg2
			@if `between(agent_UnitType, 104, 105) {
				@comment "Flat Static"
					v[726] |= 1048576

			}
		str3 .asg ""
			str5 .asg t[20034]
			@comment "Load"
			v[1942] = agent_UnitID
			v[1941] = v[4576] + v[1942] - 1
			CSVELM_AGENT_id .asg t[v[1941]]
			CSVELM_AGENT_id .split "|", CSVELM_AGENT_name, v[1941]
			str3 .asg CSVELM_AGENT_name
			t[2999..3000] .asg ""
			str1 .asg str3



			//save map tile infomation where the Static agent built
			v[605].copy Temp11, 2
			Temp11 .add v[1061], 2
			Temp11.copy Temp3, 2
			macro_cord_diff(Temp11 Temp12)
			Temp13 = v[v[1182] + Temp11 - Map_LimitCoordX_min + (Temp12 - Map_LimitCoordY_min) * var_Map_Width]
			v[657] = Temp13 / 100000000
			v[640] = Temp13 % 100


}

